<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estimasi Produksi & Perencanaan Mesin</title>
    <!-- FAVICON (Ikon Tab Browser) -->
    <link rel="icon" type="image/jpeg"
        href="https://img.lazcdn.com/g/ff/kf/Sedf6893749284ee49d1a9d1d34119487A.jpg_720x720q80.jpg">
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Supabase SDK dari CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Memuat jsPDF (untuk buat PDF) dan html2canvas (untuk screenshot HTML) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Memuat xlsx.js (SheetJS) untuk export Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Memuat Chart.js untuk Grafik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Konfigurasi Font Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }

        /* Custom styles for modal (popup) */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }

        /* Style untuk input yang harus diubah ke huruf besar */
        .uppercase-input {
            text-transform: uppercase;
        }

        /* Style untuk Tab Aktif (BIRU/INDIGO) */
        .tab-active {
            border-bottom: 3px solid #4f46e5;
            /* indigo-600 */
            color: #3730a3;
            /* indigo-800 */
            font-weight: 600;
        }

        /* Style Tambahan untuk Slot Akhir Pekan */
        .weekend-slot {
            background-color: #fecaca;
            /* red-200 */
            color: #b91c1c;
            /* red-700 */
            font-style: italic;
        }

        /* Style untuk menjaga kolom Mesin Utama (sticky left 0) dan kolom Shift (sticky left 120px) */
        .sticky-col-header {
            box-shadow: 2px 0 5px -2px rgba(0, 0, 0, 0.1);
        }

        @media (min-width: 768px) {

            /* Style untuk menjaga kolom Mesin Utama (sticky left 0) - Desktop Only */
            .sticky-machine {
                position: sticky;
                left: 0;
                z-index: 30;
                background-color: white;
                box-shadow: 1px 0 3px -1px rgba(0, 0, 0, 0.1);
            }

            /* Style untuk kolom shift (sticky left 120px) - Desktop Only */
            .sticky-shift {
                position: sticky;
                left: 120px;
                z-index: 30;
                background-color: #f9fafb;
                box-shadow: 1px 0 3px -1px rgba(0, 0, 0, 0.05);
            }
        }

        /* Style untuk input di slot jadwal */
        .planning-input {
            height: 100%;
            width: 100%;
            font-size: 10px;
            padding: 2px;
            border: none;
            text-align: center;
            background-color: transparent;
        }



        /* CSS untuk memperbesar font PDF */
        .pdf-export-font .text-xs {
            font-size: 16px !important;
            line-height: 1.5;
        }

        .pdf-export-font .text-sm {
            font-size: 18px !important;
            line-height: 1.5;
        }

        .pdf-export-font .text-base {
            font-size: 20px !important;
            line-height: 1.5;
        }

        .pdf-export-font .text-lg {
            font-size: 22px !important;
            line-height: 1.5;
        }

        .pdf-export-font .text-xl {
            font-size: 24px !important;
            line-height: 1.5;
        }

        .pdf-export-font .text-3xl {
            font-size: 34px !important;
            line-height: 1.5;
        }

        /* --- CSS BARU UNTUK DRAG AND DROP --- */
        .drag-over {
            background-color: #fef3c7 !important;
            /* amber-100 */
            border: 2px dashed #d97706 !important;
            /* amber-600 */
            transform: scale(0.98);
            transition: all 0.2s;
        }

        /* Item yang bisa di-drag */
        .draggable-item {
            cursor: grab;
        }

        .draggable-item:active {
            cursor: grabbing;
            opacity: 0.5;
        }

        /* Style untuk baris input produk dinamis */
        .product-input-row {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Style tombol tambah (+) di tabel */
        .add-slot-btn {
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        td:hover .add-slot-btn {
            opacity: 1;
            transform: scale(1);
        }

        /* CURSOR FOLLOWER FOR DUPLICATE */
        #cursorFollower {
            position: fixed;
            pointer-events: none;
            /* Penting agar klik tembus ke elemen di bawahnya */
            z-index: 9999;
            display: none;
            background: rgba(79, 70, 229, 0.9);
            /* Indigo-600 with opacity */
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            transform: translate(15px, 15px);
            /* Offset sedikit dari kursor */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            white-space: nowrap;
        }

        /* --- NEW MODERN TABS --- */
        .segmented-control {
            background-color: #f3f4f6;
            /* gray-100 */
            border-radius: 0.75rem;
            /* rounded-xl */
            padding: 0.35rem;
            /* p-1.5 */
            display: inline-flex;
            position: relative;
        }

        .tab-btn {
            position: relative;
            z-index: 1;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            /* text-sm */
            font-weight: 500;
            color: #6b7280;
            /* gray-500 */
            border-radius: 0.5rem;
            /* rounded-lg */
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: none;
            background: transparent;
        }

        .tab-btn:hover {
            color: #4f46e5;
            /* indigo-600 */
        }

        .tab-btn.tab-active {
            background-color: #ffffff;
            color: #4f46e5;
            /* indigo-600 */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            font-weight: 600;
        }
    </style>

    <!-- Mobile Responsive Tweaks -->
    <style>
        @media (max-width: 640px) {
            .tab-btn {
                padding: 0.5rem 0.5rem;
                font-size: 0.75rem;
                display: flex;
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .tab-btn span {
                margin-top: 2px;
            }

            /* Reduce table cell padding on mobile */
            th,
            td {
                padding-left: 0.25rem !important;
                padding-right: 0.25rem !important;
                padding-top: 0.5rem !important;
                padding-bottom: 0.5rem !important;
            }

            /* Smaller font for tables on mobile */
            table {
                font-size: 0.70rem;
            }

            /* Adjust input fields in tables */
            .planning-input {
                font-size: 0.70rem;
            }

            /* Hide some elements if they take too much space, or adjust margins */
            h1 {
                line-height: 1.2;
            }
        }
    </style>
</head>

<body class="p-2 sm:p-6 min-h-screen">

    <!-- Cursor Follower Element -->
    <div id="cursorFollower">Paste Item</div>

    <div id="app" class="bg-white p-3 md:p-8 rounded-xl shadow-2xl">

        <!-- HEADER ROW: LOGO, TITLE, & LOGIN BUTTON -->
        <div
            class="flex flex-col md:flex-row justify-between items-center mb-4 md:mb-6 pb-4 md:pb-6 border-b border-gray-100 gap-4">

            <div class="flex items-center justify-between w-full md:w-auto md:justify-start gap-3">

                <div class="flex items-center gap-3">
                    <!-- LOGO SECTION -->
                    <div class="flex-shrink-0 group">
                        <div
                            class="w-12 h-12 md:w-16 md:h-16 bg-white rounded-xl shadow-sm border border-slate-200 flex items-center justify-center overflow-hidden transition-transform transform group-hover:scale-105 group-hover:shadow-md">
                            <!-- Logo Image -->
                            <img src="https://img.lazcdn.com/g/ff/kf/Sf1cc8d330638465fa063a736e486ed5fK.jpg_720x720q80.jpg"
                                alt="SHINPO Logo" class="w-full h-full object-contain p-1">
                        </div>
                    </div>

                    <!-- DIVIDER -->
                    <div class="h-10 w-px bg-slate-200 hidden md:block mx-1"></div>

                    <!-- TEXT SECTION -->
                    <div class="flex flex-col justify-center">
                        <!-- Main Title -->
                        <h1
                            class="text-base sm:text-lg md:text-3xl font-extrabold tracking-tight text-slate-800 leading-tight">
                            Estimasi <span class="text-blue-600">Produksi</span>
                            <span class="hidden sm:inline mx-1 text-slate-300 font-light">&</span>
                            <br class="sm:hidden" />
                            Perencanaan <span class="text-blue-600">Mesin</span>
                        </h1>

                        <!-- Subtitle / Tagline -->
                        <div
                            class="flex flex-col sm:flex-row sm:items-center mt-1 sm:space-x-2 text-[10px] md:text-sm font-medium text-slate-500 uppercase tracking-wider">
                            <span class="flex items-center text-amber-500">
                                <svg class="w-3 h-3 md:w-4 md:h-4 mr-1" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                Sistem Manajemen
                            </span>
                            <span class="hidden sm:inline w-1 h-1 bg-slate-300 rounded-full"></span>
                            <span>Operasional & Kapasitas</span>
                        </div>
                    </div>
                </div>

                <!-- Mobile Login Button -->
                <button id="adminLoginButton" onclick="toggleAdminLogin()"
                    class="md:hidden ml-2 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 border border-indigo-200 font-bold py-1.5 px-2.5 rounded-lg transition duration-300 ease-in-out shadow-sm text-xs whitespace-nowrap">
                    Login
                </button>
            </div>

            <!-- Desktop Login Button -->
            <button id="adminLoginButtonDesktop" onclick="toggleAdminLogin()"
                class="hidden md:block bg-indigo-50 hover:bg-indigo-100 text-indigo-700 border border-indigo-200 font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-sm text-sm">
                Login Admin
            </button>
        </div>

        <!-- Tab Navigasi Modern -->
        <div class="flex justify-center mb-4 md:mb-8 overflow-x-auto whitespace-nowrap pb-2">
            <!-- Added pb-2 for scrollbar spacing if needed -->
            <div class="segmented-control shadow-inner border border-gray-200">
                <button id="tabEstimation" onclick="showView('estimation')"
                    class="tab-btn tab-active flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path
                            d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" />
                    </svg>
                    <span>Estimasi Produksi</span>
                </button>
                <button id="tabPlanning" onclick="showView('planning')" class="tab-btn flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"
                            clip-rule="evenodd" />
                    </svg>
                    <span>Perencanaan Mesin</span>
                </button>
                <button id="tabMaster" onclick="showView('master')" class="tab-btn flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path
                            d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z" />
                    </svg>
                    <span>Data Master</span>
                </button>
            </div>
        </div>

        <p class="text-gray-600 mb-4 md:mb-8 text-center text-xs md:text-base px-2" id="viewDescription">
            Hitung Estimasi Produksi
        </p>

        <!-- FORMULIR INPUT DATA PRODUKSI BARU (GLOBAL) -->
        <!-- FORMULIR INPUT DATA PRODUKSI BARU (GLOBAL) - REFACTORED TO BUTTON & MODAL -->
        <!-- FORMULIR INPUT DATA PRODUKSI BARU (GLOBAL) - BUTTON MOVED TO HEADER BELOW -->
        <div id="adminPanel" class="hidden">
            <!-- Button dipindahkan ke dalam header estimationFormContainer agar lebih hemat tempat -->
        </div>

        <!-- NEW MODAL FOR PRODUCTION DATA FORM -->
        <div id="productionDataModal"
            class="hidden fixed inset-0 z-[70] flex items-center justify-center modal-overlay">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto m-4">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h2 class="text-xl font-bold text-cyan-800 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        Formulir Data Produksi
                    </h2>
                    <button onclick="toggleProductionModal(false)"
                        class="text-gray-500 hover:text-red-500 transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <form id="productionDataForm" class="grid grid-cols-1 gap-4">
                    <input type="hidden" id="inputId" value="">

                    <div>
                        <label for="inputCode" class="block text-sm font-medium text-gray-700">Kode Barang *</label>
                        <input type="text" id="inputCode" placeholder="Contoh: 110" required
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500 text-gray-800 shadow-sm uppercase-input"
                            oninput="this.value = this.value.toUpperCase()">
                    </div>
                    <div>
                        <label for="inputName" class="block text-sm font-medium text-gray-700">Nama Komponen /
                            Produk</label>
                        <input type="text" id="inputName" placeholder="Contoh: Komponen Standard X"
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500 shadow-sm uppercase-input"
                            oninput="this.value = this.value.toUpperCase()">
                    </div>
                    <div>
                        <label for="inputColor" class="block text-sm font-medium text-gray-700">Warna</label>
                        <input type="text" id="inputColor" placeholder="Contoh: HITAM"
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500 shadow-sm uppercase-input"
                            oninput="this.value = this.value.toUpperCase()">
                    </div>
                    <div>
                        <label for="inputMachine" class="block text-sm font-medium text-gray-700">Mesin Utama</label>
                        <input type="text" id="inputMachine" placeholder="Contoh: Mesin A01"
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-cyan-500 focus:focus:border-cyan-500 shadow-sm uppercase-input"
                            oninput="this.value = this.value.toUpperCase()">
                    </div>
                    <div>
                        <label for="inputMachineOptional" class="block text-sm font-medium text-gray-700">Mesin
                            (Optional)</label>
                        <input type="text" id="inputMachineOptional" placeholder="Contoh: A02, A03"
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-cyan-500 focus:focus:border-cyan-500 shadow-sm uppercase-input"
                            oninput="this.value = this.value.toUpperCase()">
                    </div>


                    <div>
                        <label for="inputPcsPerBox" class="block text-sm font-medium text-gray-700">Isi Dus (pcs)
                            *</label>
                        <input type="text" id="inputPcsPerBox" placeholder="Contoh: 100" required
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500 shadow-sm">
                    </div>
                    <div>
                        <label for="inputTargetPerShift" class="block text-sm font-medium text-gray-700">Target per
                            Shift
                            (pcs) *</label>
                        <input type="text" id="inputTargetPerShift" placeholder="Contoh: 8000" required
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500 shadow-sm">
                    </div>
                    <div class="flex flex-col">
                        <label for="capacity3Shift" class="block text-sm font-medium text-gray-700">Kapasitas 3 Shift
                            (pcs)</label>
                        <input type="text" id="capacity3Shift" readonly value="Otomatis Terisi"
                            class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-500 shadow-inner">
                    </div>

                    <div class="flex flex-col sm:flex-row justify-end items-center gap-3 border-t pt-4 mt-2">
                        <button type="button" onclick="toggleProductionModal(false)"
                            class="w-full sm:w-auto px-4 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 rounded-lg transition duration-300 ease-in-out shadow-sm text-center text-sm">
                            Batal
                        </button>

                        <button type="submit" id="submitButton"
                            class="w-full sm:w-auto px-5 bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 rounded-lg transition duration-300 ease-in-out shadow-md hover:shadow-lg flex items-center justify-center text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-2" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M8 7H5a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-3m-1-4l-3 3m0 0l-3 3m3-3V4" />
                            </svg>
                            Simpan Data
                        </button>

                        <button type="button" id="cancelEditButton" onclick="cancelEdit()"
                            class="hidden w-full sm:w-auto px-4 bg-orange-400 hover:bg-orange-500 text-white font-medium py-2 rounded-lg transition duration-300 ease-in-out shadow-md hover:shadow-lg text-center text-sm">
                            Reset
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- VIEW 1: ESTIMASI PRODUKSI (DEFAULT) -->
        <div id="estimationView" class="view-content">

            <div id="estimationFormContainer"
                class="mb-4 md:mb-8 p-3 md:p-6 bg-white rounded-xl border border-gray-200 shadow-lg">
                <div
                    class="flex flex-col md:flex-row justify-between items-start md:items-center mb-3 md:mb-6 border-b border-gray-100 pb-2 md:pb-4 gap-2 md:gap-4">
                    <h3 class="text-lg md:text-xl font-bold text-gray-800 flex items-center">
                        <div class="bg-indigo-100 p-1.5 md:p-2 rounded-lg mr-2 md:mr-3 text-indigo-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 md:h-6 md:w-6" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path
                                    d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z" />
                            </svg>
                        </div>
                        Daftar Pesanan
                    </h3>

                    <!-- ADMIN BUTTON INTEGRATION -->
                    <button id="adminAddDataBtn" onclick="toggleProductionModal(true)"
                        class="hidden text-sm px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white font-bold rounded-lg transition duration-300 shadow-md flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                        </svg>
                        Data Baru
                    </button>
                </div>

                <!-- COMPACT TABLE LAYOUT -->
                <div class="overflow-x-auto rounded-lg border border-gray-200">
                    <table class="min-w-full bg-white" id="inputTable">
                        <thead class="bg-gray-50 text-gray-600 text-xs uppercase tracking-wider">
                            <tr>
                                <th class="py-3 px-4 text-left font-semibold w-5/12">Kode Produk</th>
                                <th class="py-3 px-4 text-left font-semibold w-3/12">Jumlah (Dus)</th>
                                <th class="py-3 px-4 text-left font-semibold w-3/12">Mulai Shift</th>
                                <th class="py-3 px-4 text-center font-semibold w-1/12">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="inputRowsContainer" class="divide-y divide-gray-100">
                            <!-- Rows via JS -->
                        </tbody>
                    </table>
                </div>

                <div class="flex flex-col sm:flex-row justify-between items-center mt-3 md:mt-6 space-y-2 md:space-y-0">
                    <button onclick="addInputRow()"
                        class="text-xs sm:text-sm bg-white border border-indigo-300 hover:bg-indigo-50 text-indigo-700 font-semibold py-1.5 px-3 rounded-lg transition duration-300 shadow-sm flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                        </svg>
                        Tambah Produk Lain
                    </button>

                    <button onclick="calculateEstimation()"
                        class="w-auto px-5 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg transition duration-300 ease-in-out transform hover:scale-[1.01] shadow-md shadow-indigo-500/50 flex items-center justify-center text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" viewBox="0 0 20 20"
                            fill="currentColor">
                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" />
                        </svg>
                        Hitung Estimasi Produksi
                    </button>
                </div>

                <!-- Datalist (Dipindahkan keluar loop agar bisa direuse) -->
                <datalist id="productCodeList">
                </datalist>
            </div>


            <div id="results" class="hidden">

                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-2xl font-semibold text-gray-800">Hasil Estimasi Waktu</h2>
                    <div class="flex items-center space-x-2">
                        <button id="exportPdfButton" onclick="exportEstimationToPDF()"
                            class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-md text-sm flex items-center hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Export PDF
                        </button>
                        <button onclick="closeEstimationResults()"
                            class="text-gray-500 hover:text-red-600 p-2 rounded-full transition duration-150 hover:bg-red-50"
                            title="Tutup Hasil Estimasi">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Container Area Print -->
                <div id="estimationPrintArea">

                    <!-- 1. RINGKASAN KARTU (Paling Atas) -->
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                        <div class="p-4 bg-indigo-100 rounded-lg shadow border border-indigo-200">
                            <h3 class="text-sm font-medium text-indigo-700">Total Jam Produksi</h3>
                            <p id="resultHours" class="text-2xl sm:text-3xl font-bold text-indigo-900 mt-1">--</p>
                        </div>
                        <div class="p-4 bg-blue-100 rounded-lg shadow border border-blue-200">
                            <h3 class="text-sm font-medium text-blue-700">Total Shift Produksi</h3>
                            <p id="resultShifts" class="text-2xl sm:text-3xl font-bold text-blue-900 mt-1">--</p>
                        </div>
                        <div class="p-4 bg-orange-100 rounded-lg shadow border border-orange-200">
                            <h3 class="text-sm font-medium text-orange-700">Total Hari Produksi</h3>
                            <p id="resultDays" class="text-2xl sm:text-3xl font-bold text-orange-900 mt-1">--</p>
                        </div>
                    </div>

                    <!-- 2. RINCIAN DETAIL (Dikembalikan ke posisi tengah/setelah ringkasan) -->
                    <div id="estimationDetails"
                        class="p-4 bg-gray-50 rounded-lg text-sm text-gray-700 border border-gray-200 hidden">
                    </div>

                    <!-- 3. PENJADWALAN OTOMATIS (Dikembalikan ke posisi Bawah) -->
                    <div id="autoSchedulePanel"
                        class="mt-8 p-6 bg-green-50 rounded-xl border border-green-200 hidden shadow-sm">
                        <div class="flex items-center mb-4 border-b border-green-200 pb-3">
                            <div class="bg-green-100 p-2 rounded-full mr-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-700" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </div>
                            <h3 class="text-lg font-bold text-green-800">Penjadwalan Otomatis Berdasarkan Estimasi</h3>
                        </div>

                        <div id="componentSelectionContainer"
                            class="mt-4 mb-4 p-4 border border-green-200 rounded-lg bg-white hidden">
                            <h4 class="text-base font-semibold text-gray-700 mb-3">Pilih Komponen untuk Dijadwalkan:
                            </h4>
                            <div class="mb-2 border-b pb-2">
                                <input type="checkbox" id="selectAllComponents" onchange="toggleSelectAll(this)"
                                    class="rounded border-gray-400 focus:ring-indigo-500">
                                <label for="selectAllComponents" class="ml-2 text-sm font-medium text-gray-800">Pilih
                                    Semua Komponen</label>
                            </div>
                            <div id="componentSelectionList" class="max-h-40 overflow-y-auto space-y-2 pt-2">
                            </div>
                        </div>

                        <div id="autoScheduleFormGrid" class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                            <div class="sm:col-span-2">
                                <label for="autoScheduleStartDate"
                                    class="block text-sm font-medium text-gray-700">Tanggal Mulai Produksi Ideal
                                    (DD/MM/YYYY)</label>
                                <input type="text" id="autoScheduleStartDate" placeholder="Tanggal Mulai" required
                                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 shadow-sm"
                                    maxlength="10" oninput="formatDateInput(this)">
                            </div>
                            <div class="sm:col-span-1">
                                <button id="autoScheduleButton" onclick="handleAutoScheduleClick()"
                                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg transition duration-300 shadow-md">
                                </button>
                            </div>
                        </div>
                        <p id="autoScheduleStatus" class="text-xs text-green-700 mt-2 hidden">Hasil simulasi jadwal akan
                            muncul di sini.</p>
                    </div>
                </div>
                <!-- Akhir Area Print -->

                <div id="toggleDetailsContainer" class="flex justify-end mb-4 mt-2">
                    <button id="toggleDetailsButton" onclick="toggleDetails()"
                        class="text-sm text-gray-600 hover:text-indigo-600 font-medium transition duration-150 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 transition-transform" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" id="toggleIcon">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                        </svg>
                        Lihat Detail Perhitungan
                    </button>
                </div>

            </div>
        </div>

        <!-- VIEW 2: PERENCANAAN MESIN -->
        <!-- VIEW 2: PERENCANAAN MESIN -->
        <!-- VIEW 2: PERENCANAAN MESIN -->
        <div id="planningView" class="view-content hidden">

            <div class="mb-8 p-6 bg-white rounded-xl border border-gray-200 shadow-lg">
                <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center border-b border-gray-100 pb-4">
                    <div class="bg-indigo-100 p-2 rounded-lg mr-3 text-indigo-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                        </svg>
                    </div>
                    Perencanaan Jadwal Mesin
                </h3>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
                    <!-- COLUMN 1: FORM INPUT -->
                    <div class="lg:col-span-4 border-r border-gray-100 pr-0 lg:pr-6">
                        <h4 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4">Filter Periode</h4>
                        <form id="planningForm" onsubmit="handlePlanningFormSubmit(event)" class="space-y-4">
                            <div>
                                <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal
                                    Mulai</label>
                                <div class="relative">
                                    <input type="text" id="startDate" placeholder="DD/MM/YYYY" required
                                        class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm text-gray-800"
                                        maxlength="10" oninput="formatDateInput(this)" onblur="autoSetEndDate()">
                                </div>
                            </div>

                            <div>
                                <label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal
                                    Akhir</label>
                                <div class="relative">
                                    <input type="text" id="endDate" placeholder="DD/MM/YYYY"
                                        class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm text-gray-800"
                                        maxlength="10" oninput="formatDateInput(this)">
                                </div>
                            </div>

                            <button type="submit"
                                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg transition duration-300 shadow-sm flex items-center justify-center text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                Tampilkan Jadwal
                            </button>
                        </form>

                        <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-100">
                            <p class="text-[10px] text-blue-800 flex items-start leading-tight">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1.5 mt-0.5 shrink-0"
                                    fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Menampilkan alokasi 3 Shift untuk setiap Mesin Utama. Slot Merah = Hari
                                    Libur.</span>
                            </p>
                        </div>
                    </div>

                    <!-- COLUMN 2: CHART AREA -->
                    <div class="lg:col-span-8 flex flex-col justify-center h-full min-h-[300px]">
                        <div
                            class="bg-gray-50 rounded-xl p-4 border border-gray-200 h-full relative flex items-center justify-center group w-full">
                            <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest absolute top-3 left-4">
                                Statistik Variasi Produksi Harian</h4>
                            <!-- Canvas for Chart -->
                            <div class="w-full h-64 mt-4">
                                <canvas id="machineActivityChart"></canvas>
                            </div>

                            <!-- Empty State Placeholder (Initially Visible) -->
                            <!-- Empty State / Dashboard Placeholder (Initially Visible) -->
                            <div id="chartPlaceholder"
                                class="absolute inset-0 flex flex-col items-center justify-center bg-white rounded-xl z-10">
                            </div>
                        </div>
                    </div>
                </div>
            </div>




            <div id="planningTableContainer">

                <div id="dailySummaryContainer" class="mb-4 hidden">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Ringkasan Beban Kerja Harian</h3>

                    <div class="overflow-x-auto">
                        <div id="dailySummaryWrapper" class="flex space-x-3 pb-2">
                        </div>
                    </div>
                </div>

                <!-- STRUKTUR BARU: Container Pembungkus Hasil (Judul + Tabel) -->
                <div id="planningResultSection" class="hidden bg-white rounded-lg shadow-md border border-gray-200">

                    <!-- 1. HEADER JUDUL (STATIS / TIDAK IKUT SCROLL) -->
                    <div class="flex justify-between items-center p-4 border-b border-gray-200 bg-white rounded-t-lg">
                        <div class="flex items-center space-x-4">
                            <h3 class="text-lg font-semibold text-gray-800" id="planningTableTitle">Matriks Jadwal</h3>

                            <button id="exportExcelButton" onclick="exportPlanningMatrixToExcel()"
                                class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-lg transition duration-300 shadow-md text-sm flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                Export Excel
                            </button>
                        </div>

                        <button onclick="closePlanningTable()"
                            class="text-gray-500 hover:text-red-600 p-1 rounded-full transition duration-150"
                            title="Tutup Jadwal">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    <!-- 2. AREA SCROLL TABEL (MAX-HEIGHT DISINI) -->
                    <div id="planningTableWrapper" class="w-full overflow-auto max-h-[70vh]">
                        <table class="min-w-full bg-white border-b border-gray-200" id="planningActualTable">
                            <!-- Tabel akan digenerate di sini -->
                        </table>
                    </div>

                </div>

                <p class="text-gray-500 p-4 bg-white mt-4 rounded-lg shadow-sm" id="planningTablePlaceholder">Silakan
                    masukkan Tanggal Mulai dan Tanggal Akhir untuk menampilkan Matriks Jadwal.</p>
            </div>

            <p class="text-xs text-gray-500 mt-4" id="planningDescription">
                Matriks ini menunjukkan alokasi 3 Shift untuk setiap Mesin Utama selama periode yang dipilih. Slot Merah
                adalah akhir pekan/hari libur.
            </p>
        </div>

        <!-- VIEW 3: DATA MASTER -->
        <div id="masterView" class="view-content hidden">
            <div id="masterTableContainer">
                <div class="mt-10 pt-4 border-t border-gray-200">
                    <!-- UBAH: Header dibuat Flex untuk menampung tombol Export & Icon -->
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                            <!-- ICON DATABASE -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-indigo-600" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
                            </svg>
                            Data Master Produksi Tersimpan
                            <span id="masterDataTotalCount" class="text-lg font-normal text-gray-500 ml-2"></span>
                        </h2>
                        <!-- TOMBOL EXPORT -->
                        <button onclick="exportProductionMasterToExcel()"
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-lg transition duration-300 shadow-md text-sm flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Export Excel
                        </button>
                    </div>

                    <div class="mb-4 relative">
                        <input type="text" id="masterSearchInput" placeholder="Cari Kode, Nama Komponen, atau Mesin..."
                            class="w-full p-2 pl-10 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-2.5 text-gray-400"
                            fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>

                    <div id="rateTableContainer"
                        class="overflow-x-auto rounded-lg shadow-md max-h-[60vh] overflow-y-auto">
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        *Asumsi: 1 Hari = 3 Shift, 1 Shift = 8 Jam. Perhitungan waktu didasarkan pada target pcs per
                        shift.
                    </p>
                </div>

                <div id="scheduleMasterSection" class="mt-10 pt-4 border-t border-gray-200">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                            <!-- ICON ARCHIVE / TABLE -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-indigo-600" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                            </svg>
                            Data Master Jadwal Mesin Tersimpan
                            <span id="scheduleMasterTotalCount" class="text-lg font-normal text-gray-500 ml-2"></span>
                        </h2>
                        <button id="exportMasterScheduleButton" onclick="exportMasterScheduleToExcel()"
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-lg transition duration-300 shadow-md text-sm flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Export Excel
                        </button>
                    </div>

                    <div class="mb-4 relative">
                        <input type="text" id="scheduleMasterSearchInput"
                            placeholder="Cari Mesin, Kode, Nama, atau Shift (mis: '1' atau 'Shift 1')..."
                            class="w-full p-2 pl-10 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm"
                            oninput="renderScheduleMasterTable(this.value)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-2.5 text-gray-400"
                            fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>

                    <div id="deleteSelectedScheduleContainer" class="mb-4 hidden">
                        <button onclick="confirmDeleteSelectedSchedules()"
                            class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 shadow-md text-sm">
                            Hapus <span id="selectedScheduleCount">0</span> Item Terpilih
                        </button>
                    </div>

                    <div id="scheduleMasterContainer">
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Konfirmasi Hari Libur / Swap (Diperbarui strukturnya) -->
        <div id="weekendConfirmModal"
            class="hidden fixed inset-0 z-[60] flex items-center justify-center modal-overlay">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transform transition-all scale-100">
                <h3 class="text-xl font-bold mb-4 text-orange-600 flex items-center border-b pb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <span id="weekendModalTitle">Konfirmasi Hari Libur</span>
                </h3>

                <div id="weekendConfirmText" class="text-gray-700 mb-6 text-sm leading-relaxed">
                    <!-- Konten teks akan diisi lewat JS -->
                </div>

                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" onclick="toggleWeekendConfirmModal(false)"
                        class="px-4 py-2 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200 transition duration-150 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-300">Batal</button>
                    <button type="button" onclick="handleWeekendConfirm()"
                        class="px-4 py-2 bg-orange-600 text-white font-bold rounded-lg hover:bg-orange-700 transition duration-150 shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500">Ya,
                        Lanjutkan</button>
                </div>
            </div>
        </div>

        <!-- Modal Edit Slot Jadwal -->
        <div id="scheduleEditModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-2xl">
                <h3 class="text-xl font-bold mb-4 text-green-700">Edit Slot Jadwal</h3>
                <form onsubmit="event.preventDefault(); updateScheduleSlotFromModal(false);"
                    class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <input type="hidden" id="modalScheduleId" value="">
                    <div>
                        <label for="modalScheduleMachine" class="block text-sm font-medium text-gray-700">Mesin
                            Utama</label>
                        <select id="modalScheduleMachine" required
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 shadow-sm text-sm"
                            onchange="checkSlotAvailability_Modal()"></select>
                    </div>
                    <div>
                        <label for="modalScheduleDate" class="block text-sm font-medium text-gray-700">Tanggal</label>
                        <input type="text" id="modalScheduleDate" placeholder="DD/MM/YYYY" required
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 shadow-sm text-sm"
                            maxlength="10" oninput="formatDateInput(this)" onblur="checkSlotAvailability_Modal()">
                    </div>
                    <div>
                        <label for="modalScheduleShift" class="block text-sm font-medium text-gray-700">Shift</label>
                        <select id="modalScheduleShift" required
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 shadow-sm text-sm"
                            onchange="checkSlotAvailability_Modal()">
                            <option value="Shift 1">Shift 1</option>
                            <option value="Shift 2">Shift 2</option>
                            <option value="Shift 3">Shift 3</option>
                        </select>
                    </div>
                    <div>
                        <label for="modalScheduleCode" class="block text-sm font-medium text-gray-700">Kode
                            Barang</label>
                        <input type="text" id="modalScheduleCode" placeholder="Kode Brg" required
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 shadow-sm text-sm uppercase-input"
                            oninput="this.value = this.value.toUpperCase()" onblur="findProductNameByCode_Modal()">
                    </div>
                    <!-- NEW INPUT MODAL: JUMLAH PESANAN -->
                    <div>
                        <label for="modalScheduleQty" class="block text-sm font-medium text-gray-700">Jml Order
                            (Dus)</label>
                        <input type="number" id="modalScheduleQty" placeholder="0"
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 shadow-sm text-sm">
                    </div>

                    <div class="sm:col-span-2"> <!-- Ubah span agar layout rapi -->
                        <label for="modalScheduleName" class="block text-sm font-medium text-gray-700">Nama
                            Komponen</label>
                        <select id="modalScheduleName" required
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 shadow-sm text-sm"
                            onchange="handleComponentSelectionChange_Modal()">
                            <option value="" disabled selected>Otomatis (Isi Kode)</option>
                        </select>
                    </div>
                    <p id="modalSlotStatusMessage" class="sm:col-span-2 text-sm font-bold mt-2 text-center"></p>
                    <div class="sm:col-span-2 flex justify-end space-x-3 mt-4">
                        <button type="button" onclick="toggleScheduleEditModal(false)"
                            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">Batal</button>
                        <button type="submit"
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M4 4v5h.582m15.836 2.582a2 2 0 010 2.828l-7 7L10 20l-1.586-1.586L2.586 12a2 2 0 010-2.828z" />
                            </svg>
                            Update Slot
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal Add Slot Jadwal (NEW) -->
        <div id="scheduleAddModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-2xl">
                <h3 class="text-xl font-bold mb-4 text-indigo-700">Tambah Jadwal Baru</h3>
                <form onsubmit="event.preventDefault(); saveScheduleSlotFromModal(false);"
                    class="grid grid-cols-1 sm:grid-cols-2 gap-4">

                    <div>
                        <label for="addScheduleMachine" class="block text-sm font-medium text-gray-700">Mesin
                            Utama</label>
                        <select id="addScheduleMachine" required
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm text-sm"
                            onchange="checkSlotAvailability_AddModal()"></select>
                    </div>
                    <div>
                        <label for="addScheduleDate" class="block text-sm font-medium text-gray-700">Tanggal</label>
                        <input type="text" id="addScheduleDate" placeholder="DD/MM/YYYY" required
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm text-sm"
                            maxlength="10" oninput="formatDateInput(this)" onblur="checkSlotAvailability_AddModal()">
                    </div>
                    <div>
                        <label for="addScheduleShift" class="block text-sm font-medium text-gray-700">Shift</label>
                        <select id="addScheduleShift" required
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm text-sm"
                            onchange="checkSlotAvailability_AddModal()">
                            <option value="Shift 1">Shift 1</option>
                            <option value="Shift 2">Shift 2</option>
                            <option value="Shift 3">Shift 3</option>
                        </select>
                    </div>
                    <div>
                        <label for="addScheduleCode" class="block text-sm font-medium text-gray-700">Kode Barang</label>
                        <input type="text" id="addScheduleCode" placeholder="Kode Brg" required
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm text-sm uppercase-input"
                            oninput="this.value = this.value.toUpperCase()" onblur="findProductNameByCode_AddModal()">
                    </div>

                    <div>
                        <label for="addScheduleQty" class="block text-sm font-medium text-gray-700">Jml Order
                            (Dus)</label>
                        <input type="number" id="addScheduleQty" placeholder="0"
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm text-sm">
                    </div>

                    <div class="sm:col-span-2">
                        <label for="addScheduleName" class="block text-sm font-medium text-gray-700">Nama
                            Komponen</label>
                        <select id="addScheduleName" required
                            class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm text-sm"
                            onchange="handleComponentSelectionChange_AddModal()">
                            <option value="" disabled selected>Otomatis (Isi Kode)</option>
                        </select>
                    </div>
                    <p id="addSlotStatusMessage" class="sm:col-span-2 text-sm font-bold mt-2 text-center"></p>
                    <div class="sm:col-span-2 flex justify-end space-x-3 mt-4">
                        <button type="button" onclick="toggleScheduleAddModal(false)"
                            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">Batal</button>
                        <button type="submit"
                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                            </svg>
                            Simpan Jadwal
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal Hapus Multi -->
        <div id="scheduleMultiDeleteModal"
            class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h3 class="text-xl font-bold mb-4 text-red-700">Konfirmasi Hapus Multi Slot</h3>
                <p class="text-gray-600 mb-4">Anda akan menghapus <span id="multiDeleteCount" class="font-bold">0</span>
                    slot jadwal terpilih secara permanen. Tindakan ini tidak dapat dibatalkan.</p>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="toggleMultiDeleteModal(false)"
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">Batal</button>
                    <button type="button" onclick="executeDeleteSelectedSchedules()"
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150">Hapus
                        Terpilih</button>
                </div>
            </div>
        </div>

        <!-- Modal Login -->
        <div id="loginModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
                <h3 class="text-xl font-bold mb-4 text-indigo-700">Login Administrator</h3>
                <p class="text-sm text-gray-600 mb-4">Masukkan kata sandi admin untuk mengakses manajemen data.</p>
                <form onsubmit="event.preventDefault(); attemptAdminLogin();">
                    <input type="password" id="adminPasswordInput" placeholder="Kata Sandi"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4 shadow-sm"
                        required>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="toggleAdminLogin()"
                            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">Batal</button>
                        <button type="submit"
                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150">Login</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Message Box -->
        <div id="messageBox"
            class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 p-3 rounded-lg shadow-xl transition-opacity duration-300 z-[100] text-white">
        </div>

        <!-- Modal Logout -->
        <div id="logoutModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h3 class="text-xl font-bold mb-4 text-red-700">Konfirmasi Logout</h3>
                <p class="text-gray-600 mb-4">Anda yakin ingin keluar dari mode Admin?</p>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="toggleLogoutModal(false)"
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">Batal</button>
                    <button type="button" onclick="confirmLogout()"
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150">Logout</button>
                </div>
            </div>
        </div>

        <!-- Modal Hapus Data Master -->
        <div id="deleteModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h3 class="text-xl font-bold mb-4 text-red-700">Konfirmasi Hapus Data</h3>
                <p class="text-gray-600 mb-4">Anda yakin ingin menghapus data master untuk: <span id="deleteCodeDisplay"
                        class="font-bold"></span>?</p>
                <p class="text-xs text-gray-500 mb-4">Tindakan ini permanen dan tidak dapat dibatalkan.</p>
                <input type="hidden" id="deleteIdConfirm" value="">
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="toggleDeleteModal(false)"
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">Batal</button>
                    <button type="button" onclick="confirmDelete()"
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150">Hapus
                        Permanen</button>
                </div>
            </div>
        </div>

        <!-- Modal Hapus Slot -->
        <div id="scheduleDeleteModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h3 class="text-xl font-bold mb-4 text-red-700">Konfirmasi Hapus Slot</h3>
                <p class="text-gray-600 mb-4">Anda yakin ingin menghapus slot jadwal untuk: <span
                        id="deleteScheduleDisplay" class="font-bold"></span>?</p>
                <input type="hidden" id="deleteScheduleIdConfirm" value="">
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="toggleScheduleDeleteModal(false)"
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">Batal</button>
                    <button type="button" onclick="confirmScheduleDelete()"
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150">Hapus
                        Slot</button>
                </div>
            </div>
        </div>
    </div>

    <script>


        window.addInputRow = function () {
            const container = document.getElementById('inputRowsContainer');
            if (!container) return;
            const rowId = 'input-row-' + Date.now();
            const tr = document.createElement('tr');
            tr.id = rowId;
            tr.className = 'product-input-row hover:bg-gray-50 transition duration-150';
            const isFirstRow = container.children.length === 0;
            const deleteVisibility = isFirstRow ? 'invisible' : '';

            tr.innerHTML = `
                <td class="py-2 px-4">
                    <input type="text" class="product-code-input w-full p-2 border border-gray-300 rounded-lg text-sm uppercase-input" placeholder="Kode Barang..." list="productCodeList" oninput="this.value = this.value.toUpperCase()">
                </td>
                <td class="py-2 px-4">
                    <input type="number" class="order-qty-input w-full p-2 border border-gray-300 rounded-lg text-sm" placeholder="0" min="1">
                </td>
                <td class="py-2 px-4">
                    <select class="start-shift-input w-full p-2 bg-white border border-gray-200 text-sm rounded-lg">
                        <option value="auto"> Otomatis</option>
                        <option value="Shift 1"> Shift 1</option>
                        <option value="Shift 2"> Shift 2</option>
                        <option value="Shift 3"> Shift 3</option>
                    </select>
                </td>
                <td class="py-2 px-4 text-center">
                    <button onclick="window.removeInputRow('${rowId}')" class="text-gray-400 hover:text-red-500 p-2 ${deleteVisibility}">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                </td>
            `;
            container.appendChild(tr);
        };

        window.removeInputRow = function (rowId) {
            const row = document.getElementById(rowId);
            if (row) row.remove();
        };



        const SUPABASE_URL = 'https://adxpkzebtvetcnhngjax.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkeHBremVidHZldGNuaG5namF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NDEzMTEsImV4cCI6MjA3NjUxNzMxMX0.c8pMAL7jAJFJmKFh8hcjI8_pIiW_pHZrenHT8nbUdoA';
        const TABLE_NAME = 'production_rates';
        const SCHEDULE_TABLE_NAME = 'production_schedule';

        // let supabase;
        let productionData = {};
        let scheduleData = {};
        let masterScheduleData = [];
        let selectedScheduleIds = new Set();
        let isSyncingScroll = false;
        let draggedItemData = null;

        let pendingWeekendAction = null;
        let pendingDropUpdate = null;
        let pendingSwapUpdate = null; // New for Swap

        // --- DUPLICATE STATE ---
        let isDuplicating = false;
        let sourceDuplicateItem = null;
        let pendingDuplicateData = null;

        const STATIC_MACHINE_DATA = [
            { code: 'A01', type: 'HC -450 T' }, { code: 'A02', type: 'HC -450 T' }, { code: 'A03', type: 'CF -600 T' },
            { code: 'A04', type: 'BORC -400 T' }, { code: 'A05', type: 'BORC -400 T' }, { code: 'A06', type: 'BORC -400 T' },
            { code: 'A07', type: 'BORC -400 T' }, { code: 'A08', type: 'BORC -700 T' }, { code: 'A09', type: 'CF -1300 T' },
            { code: 'A10', type: 'CF -1300 T' }, { code: 'A11', type: 'BORC -1000 T' }, { code: 'A12', type: 'HWD -1300 T' },
            { code: 'A13', type: 'HC -1600 T' }, { code: 'A14', type: 'HT -1300 T' }, { code: 'A15', type: 'CF -800 T' },
            { code: 'A16', type: 'HC -800 T' }, { code: 'A17', type: 'NISS -360 T' }, { code: 'A18', type: 'HC -600 T' },
            { code: 'A19', type: 'HC -600 T' }, { code: 'A20', type: 'HC -600 T' }, { code: 'A21', type: 'NISS -460 T' },
            { code: 'A22', type: 'NB -650 T' }, { code: 'A23', type: 'LG -650 T' }, { code: 'A24', type: 'BORC -500 T' },
            { code: 'A25', type: 'HT -650 T' }, { code: 'A26', type: 'BORC -400 T' }, { code: 'A27', type: 'HWAM -430 T' },
            { code: 'A28', type: 'HWAM -430 T' },
            { code: 'B01', type: 'BORC -320 T' }, { code: 'B02', type: 'BORC -260T' }, { code: 'B03', type: 'NISS -180 T' },
            { code: 'B04', type: 'NISS -80 T' }, { code: 'B05', type: 'NISS -180 T' }, { code: 'B06', type: 'HC -250 T' },
            { code: 'B07', type: 'HC -250 T' }, { code: 'B08', type: 'HC -250 T' }, { code: 'B09', type: 'HC -350 T' },
            { code: 'B10', type: 'HC -300 T' }, { code: 'B11', type: 'BORC -250 T' }, { code: 'B12', type: 'NISS -220 T' },
            { code: 'B13', type: 'HMD -228 T' }, { code: 'B14', type: 'HMD -288 T' }, { code: 'B15', type: 'HMD -228 T' },
            { code: 'B16', type: 'HMD -228 T' }, { code: 'B17', type: 'HMD -228 T' }, { code: 'B18', type: 'HMD -228 T' },
            { code: 'B19', type: 'HWA -160 T' }, { code: 'B20', type: 'BORC -150 T' }, { code: 'B21', type: 'HWA -125 T' },
            { code: 'B22', type: 'BORC -150 T' }, { code: 'B23', type: 'LG -170 T' }, { code: 'B24', type: 'NISS -80 T' },
            { code: 'B25', type: 'LG -170 T' }, { code: 'B26', type: 'HWA -350 T' }, { code: 'B27', type: 'HWA -450 T' },
            { code: 'C01', type: 'NISS -80 T' }, { code: 'C02', type: 'NISS -110 T' }, { code: 'C03', type: 'HC -125 T' },
            { code: 'C04', type: 'HC -125 T' }, { code: 'C05', type: 'HC -125 T' }, { code: 'C06', type: 'HC -125 T' },
            { code: 'D01', type: 'BORC -600 T' }, { code: 'D02', type: 'BORC -260 T' }, { code: 'D03', type: 'BORC -500 T' },
            { code: 'D04', type: 'BORC -400 T' }, { code: 'D05', type: 'HWD -600 T' }, { code: 'D06', type: 'HWD -430 T' },
            { code: 'D07', type: 'HWD -288 T' }, { code: 'D08', type: 'HWD -310 T' }, { code: 'D09', type: 'HWD -218 T' }
        ];

        // --- MOUSE LISTENER UNTUK CURSOR FOLLOWER ---
        document.addEventListener('mousemove', (e) => {
            if (isDuplicating) {
                const follower = document.getElementById('cursorFollower');
                if (follower) {
                    follower.style.left = (e.clientX + 10) + 'px';
                    follower.style.top = (e.clientY + 10) + 'px';
                }
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && isDuplicating) {
                cancelDuplicate();
            }
        });

        const HOURS_PER_SHIFT = 8;
        const SHIFTS_PER_DAY = 3;

        const ADMIN_PASSWORD = "admin123";
        let isLoggedIn = false;

        let pendingScheduleComponents = [];



        const cleanInt = (str) => {
            if (typeof str === 'number') return str;
            if (typeof str !== 'string') return 0;
            const cleaned = str.replace(/[^\d]/g, '');
            return parseInt(cleaned) || 0;
        };

        function formatHoursMinutes(decimalHours) {
            if (decimalHours < 0) return '0 Jam 0 Menit';
            const hours = Math.floor(decimalHours);
            const decimalPart = decimalHours - hours;
            const minutes = Math.round(decimalPart * 60);
            return `${hours} Jam ${minutes} Menit`;
        }

        // --- HELPER UNTUK SINGKATAN NAMA KOMPONEN (KHUSUS EXCEL) ---
        function shortenComponentName(name) {
            if (!name) return '';
            let res = name.toUpperCase().trim();

            // 1. Prioritaskan frase panjang dari user list
            const complexMappings = {
                "TUDUNG SAJI": "TD SAJI",
                "TATAKAN BAWAH": "TTK BWH",
                "RODA KECIL": "RD KECIL",
                "HANDLE BESAR": "HD BESAR",
                "KLIP TUTUP": "KLIP TP"
            };

            for (const [key, val] of Object.entries(complexMappings)) {
                const regex = new RegExp(`\\b${key}\\b`, 'g');
                res = res.replace(regex, val);
            }

            // 2. Penggantian kata tunggal
            res = res.replace(/\bBODY\b/g, "BD");
            res = res.replace(/\bTUTUP\b/g, "TP");
            res = res.replace(/\bBANGKU\b/g, "BG");

            return res;
        }

        // --- DUPLICATE FUNCTIONS ---

        window.startDuplicate = function (scheduleItem) {
            if (!isLoggedIn) {
                showMessage("Akses ditolak. Silakan Login Admin.", "error");
                return;
            }
            isDuplicating = true;
            sourceDuplicateItem = scheduleItem;

            const follower = document.getElementById('cursorFollower');
            follower.textContent = `Paste: ${scheduleItem.product_code}`;
            follower.style.display = 'block';
            document.body.style.cursor = 'copy';

            showMessage("Mode Duplikat Aktif: Klik slot manapun untuk Paste (Tekan Esc untuk batal).", "info");
        }

        window.cancelDuplicate = function () {
            isDuplicating = false;
            sourceDuplicateItem = null;
            document.getElementById('cursorFollower').style.display = 'none';
            document.body.style.cursor = 'default';
        }

        window.handleCellClick = async function (event) {
            if (!isDuplicating || !sourceDuplicateItem) return;

            // Cari elemen TD terdekat jika user klik child element
            const cell = event.target.closest('td');
            if (!cell) return;

            const targetMachine = cell.getAttribute('data-machine');
            const targetDate = cell.getAttribute('data-date');
            const targetShift = cell.getAttribute('data-shift');

            if (!targetMachine || !targetDate || !targetShift) return;

            const newItem = {
                mesin: targetMachine,
                schedule_date: targetDate,
                schedule_shift: targetShift,
                product_code: sourceDuplicateItem.product_code,
                product_name: sourceDuplicateItem.product_name,
                order_qty: sourceDuplicateItem.order_qty,
                timestamp: new Date().toISOString()
            };

            // Cek Weekend
            const dateObj = new Date(targetDate);
            const isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6);

            if (isWeekend) {
                pendingWeekendAction = 'paste_duplicate';
                pendingDuplicateData = newItem; // Simpan data sementara
                toggleWeekendConfirmModal(true, 'paste_duplicate', formatDateToDMY(dateObj));
                return;
            }

            await executeDuplicate(newItem);
        }

        async function executeDuplicate(newItem) {
            try {
                // Hapus data lama jika ada (Overwrite logic)
                const existing = Object.values(scheduleData).find(
                    item => item.mesin === newItem.mesin &&
                        item.schedule_date === newItem.schedule_date &&
                        item.schedule_shift === newItem.schedule_shift
                );

                if (existing) {
                    await supabase.from(SCHEDULE_TABLE_NAME).delete().eq('id', existing.id);
                    // Optimistic Remove
                    const oldKey = `${existing.mesin}|${existing.schedule_date}|${existing.schedule_shift}`;
                    delete scheduleData[oldKey];
                }

                const { data, error } = await supabase
                    .from(SCHEDULE_TABLE_NAME)
                    .insert([newItem])
                    .select();

                if (error) throw error;

                showMessage(`Berhasil menduplikat ke ${newItem.mesin} - ${formatDateToDMY(new Date(newItem.schedule_date))}`, "info");

                // Optimistic Add
                const insertedItem = (data && data.length > 0) ? data[0] : null;
                if (insertedItem) {
                    const newKey = `${insertedItem.mesin}|${insertedItem.schedule_date}|${insertedItem.schedule_shift}`;
                    scheduleData[newKey] = insertedItem;
                }

                // Refresh
                const start = document.getElementById('startDate').value;
                const end = document.getElementById('endDate').value;

                // Skip fetchAllScheduleData for speed
                if (start && end) {
                    renderPlanningTable(start, end, true);
                }

                cancelDuplicate();

            } catch (e) {
                console.error("Error duplicating:", e);
                showMessage("Gagal menduplikat jadwal.", "error");
            }
        }



        // --- Helper Functions for UI State ---


        function updateDeleteButtonsVisibility() {
            const container = document.getElementById('inputRowsContainer');
            // Select delete buttons inside TRs
            const buttons = container.querySelectorAll('button');

            if (container.children.length === 1) {
                buttons.forEach(btn => btn.classList.add('invisible'));
            } else {
                buttons.forEach(btn => btn.classList.remove('invisible'));
            }
        }

        window.showView = function (viewName) {
            const views = ['estimation', 'planning', 'master'];
            const description = document.getElementById('viewDescription');

            const adminPanel = document.getElementById('adminPanel');
            const estimationFormContainer = document.getElementById('estimationFormContainer');
            const resultsContainer = document.getElementById('results');
            const planningTableContainer = document.getElementById('planningTableContainer');
            const masterTableContainer = document.getElementById('masterTableContainer');
            const scheduleInputForm = document.getElementById('scheduleInputForm');

            views.forEach(view => {
                const viewElement = document.getElementById(`${view}View`);
                const tabElement = document.getElementById(`tab${view.charAt(0).toUpperCase() + view.slice(1)}`);

                viewElement.classList.add('hidden');
                tabElement.classList.remove('tab-active');
            });

            document.getElementById(`${viewName}View`).classList.remove('hidden');
            document.getElementById(`tab${viewName.charAt(0).toUpperCase() + viewName.slice(1)}`).classList.add('tab-active');

            adminPanel.classList.add('hidden');
            estimationFormContainer.classList.add('hidden');
            resultsContainer.classList.add('hidden');
            masterTableContainer.classList.add('hidden');

            // UPDATE: Pengecekan jika elemen form ada
            if (scheduleInputForm) {
                scheduleInputForm.classList.remove('visible');
                scheduleInputForm.classList.add('hidden');
            }



            if (viewName === 'estimation') {
                description.textContent = 'Hitung estimasi waktu dan kapasitas produksi Anda secara akurat dan efisien di sini.';

                if (isLoggedIn) {
                    const adminBtn = document.getElementById('adminAddDataBtn');
                    if (adminBtn) adminBtn.classList.remove('hidden');
                    estimationFormContainer.classList.remove('hidden');
                } else {
                    estimationFormContainer.classList.remove('hidden');
                }

            } else if (viewName === 'planning') {
                description.textContent = 'Visualisasikan jadwal produksi dan pantau ketersediaan slot mesin secara real-time.';

                document.getElementById('planningForm').style.display = 'grid'; // Pastikan display form benar

                // HITUNG TOTAL MESIN UNTUK DASHBOARD
                const uniqueMachines = new Set(Object.values(productionData).map(d => d.machine).filter(m => m));
                const totalMachinesElement = document.getElementById('dashTotalMachines');
                if (totalMachinesElement) {
                    totalMachinesElement.textContent = uniqueMachines.size > 0 ? uniqueMachines.size : '-';
                }

                if (isLoggedIn) {
                    const adminBtn = document.getElementById('adminAddDataBtn');
                    if (adminBtn) adminBtn.classList.remove('hidden');

                    if (scheduleInputForm) {
                        scheduleInputForm.classList.remove('hidden');
                        scheduleInputForm.classList.add('visible');
                        checkSlotAvailability(null);
                    }
                }

            } else if (viewName === 'master') {
                description.textContent = 'Kelola database produk, target output, dan kapasitas mesin sebagai referensi utama sistem.';

                masterTableContainer.classList.remove('hidden');

                // Fix: Persist search query
                const currentMasterSearch = document.getElementById('masterSearchInput') ? document.getElementById('masterSearchInput').value : '';
                renderRateTable(currentMasterSearch);

                selectedScheduleIds.clear();
                updateDeleteSelectedButtonState();

                fetchAllScheduleData().then(() => {
                    // Fix: Persist schedule search query (don't clear it)
                    const currentScheduleSearch = document.getElementById('scheduleMasterSearchInput') ? document.getElementById('scheduleMasterSearchInput').value : '';
                    renderScheduleMasterTable(currentScheduleSearch);
                });

                if (isLoggedIn) {
                    adminPanel.classList.add('hidden');
                }
            }
        }

        // --- GLOBAL HELPER FUNCTIONS & LISTENERS ---
        // Pindahkan ke atas untuk menghindari ReferenceError saat dipanggil setupApp

        function setupCapacityListener() {
            const targetInput = document.getElementById('inputTargetPerShift');
            const capacityOutput = document.getElementById('capacity3Shift');
            const pcsPerBoxInput = document.getElementById('inputPcsPerBox');

            if (!targetInput || !capacityOutput || !pcsPerBoxInput) {
                return;
            }

            const updateCapacity = () => {
                const target = cleanInt(targetInput.value);

                if (target > 0) {
                    const capacity = target * SHIFTS_PER_DAY;
                    capacityOutput.value = capacity.toLocaleString('id-ID', { maximumFractionDigits: 0 }) + ' pcs';
                } else {
                    capacityOutput.value = 'Otomatis Terisi';
                }
            };

            targetInput.addEventListener('input', updateCapacity);
            pcsPerBoxInput.addEventListener('input', () => { });
        }

        // --- RESTORED PLANNING FUNCTIONS ---

        window.autoSetEndDate = function () {
            const startDateStr = document.getElementById('startDate').value;
            if (!startDateStr || startDateStr.length < 10) return;

            const startDate = parseDMY(startDateStr);
            if (!startDate) return;

            // Default: +6 hari (Total 7 hari)
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);

            document.getElementById('endDate').value = formatDateToDMY(endDate);
        }

        window.handlePlanningFormSubmit = async function (event) {
            event.preventDefault();
            const startDateStr = document.getElementById('startDate').value;
            const endDateStr = document.getElementById('endDate').value;

            if (!startDateStr || !endDateStr) {
                showMessage("Mohon isi tanggal mulai dan tanggal akhir.", "error");
                return;
            }

            const start = parseDMY(startDateStr);
            const end = parseDMY(endDateStr);

            if (end < start) {
                showMessage("Tanggal akhir tidak boleh lebih kecil dari tanggal mulai.", "error");
                return;
            }

            // Limit range to prevent browser crash (e.g. max 31 days)
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays > 31) {
                showMessage("Rentang tanggal maksimal adalah 31 hari agar performa tetap optimal.", "error");
                return;
            }

            showMessage("Memuat data jadwal...", "info");

            await fetchScheduleData(startDateStr, endDateStr);
            renderPlanningTable(startDateStr, endDateStr);
        }

        let planningChartInstance = null;

        // Helper Color Class (Simplified)
        function getColorClass(colorName) {
            if (!colorName) return 'bg-gray-100 text-gray-800 border-gray-200';
            const c = colorName.toLowerCase();
            if (c.includes('hijau') || c.includes('green')) return 'bg-green-100 text-green-900 border-green-200';
            if (c.includes('merah') || c.includes('red')) return 'bg-red-100 text-red-900 border-red-200';
            if (c.includes('kuning') || c.includes('yellow')) return 'bg-yellow-100 text-yellow-900 border-yellow-200';
            if (c.includes('biru') || c.includes('blue')) return 'bg-blue-100 text-blue-900 border-blue-200';
            if (c.includes('hitam') || c.includes('black')) return 'bg-gray-800 text-white border-gray-600';
            if (c.includes('putih') || c.includes('white')) return 'bg-white border border-gray-300 text-gray-800 shadow-sm';
            if (c.includes('ungu') || c.includes('purple')) return 'bg-purple-100 text-purple-900 border-purple-200';
            if (c.includes('orange')) return 'bg-orange-100 text-orange-900 border-orange-200';
            if (c.includes('bening') || c.includes('clear')) return 'bg-slate-50 text-slate-700 border border-slate-300 border-dashed';
            return 'bg-gray-100 text-gray-800 border-gray-200';
        }

        window.renderPlanningTable = function (startDateStr, endDateStr, preserveData = false) {
            const container = document.getElementById('planningTableWrapper');
            const placeholder = document.getElementById('planningTablePlaceholder');
            const resultSection = document.getElementById('planningResultSection');
            const tableTitle = document.getElementById('planningTableTitle');
            const actualTable = document.getElementById('planningActualTable');

            if (!actualTable) return;

            // Hide placeholder, show result
            if (placeholder) placeholder.classList.add('hidden');
            if (resultSection) resultSection.classList.remove('hidden');

            if (tableTitle) tableTitle.textContent = `Matriks Jadwal: ${startDateStr} s/d ${endDateStr}`;

            const startDate = parseDMY(startDateStr);
            const endDate = parseDMY(endDateStr);
            const dateArray = [];
            let currentDate = new Date(startDate);

            while (currentDate <= endDate) {
                dateArray.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // --- BUILD HEADER ---
            let theadHTML = `
                <thead class="sticky top-0 bg-white z-30 shadow-sm">
                    <tr>
                        <th class="py-3 px-2 border-b-2 border-r border-gray-200 bg-gray-100 text-left text-xs font-bold text-gray-700 uppercase w-32 sticky left-0 z-40">Mesin</th>
                        <th class="py-3 px-1 border-b-2 border-r border-gray-200 bg-gray-100 text-center text-xs font-bold text-gray-700 w-20 sticky left-32 z-40">Shift</th>
             `;

            dateArray.forEach(date => {
                const dayName = date.toLocaleDateString('id-ID', { weekday: 'short' }).toUpperCase();
                const dateNum = date.getDate();
                const monthNum = date.getMonth() + 1;
                const isWeekend = (date.getDay() === 0 || date.getDay() === 6);
                const bgClass = isWeekend ? 'bg-red-50 text-red-600' : 'bg-gray-50 text-gray-700';

                theadHTML += `
                    <th class="py-2 px-1 border-b-2 border-r border-gray-100 min-w-[100px] text-center ${bgClass}">
                        <div class="text-[10px] uppercase tracking-wider opacity-70">${dayName}</div>
                        <div class="text-sm font-extrabold">${dateNum}/${monthNum}</div>
                    </th>
                 `;
            });

            theadHTML += `</tr></thead>`;

            // --- BUILD BODY ---
            let tbodyHTML = `<tbody class="divide-y divide-gray-100">`;

            STATIC_MACHINE_DATA.forEach((machine, index) => {
                const machineCode = machine.code;

                // 3 Rows per Machine (Shift 1, 2, 3)
                for (let shift = 1; shift <= 3; shift++) {
                    const isFirstShift = (shift === 1);
                    const borderTopClass = isFirstShift ? 'border-t-2 border-gray-200' : '';

                    tbodyHTML += `<tr class="hover:bg-gray-50 transition duration-150 ${borderTopClass}">`;

                    // CELL: MESIN (Rowspan 3)
                    if (isFirstShift) {
                        tbodyHTML += `
                            <td rowspan="3" class="py-2 px-3 border-r border-b-2 border-gray-200 bg-white font-bold text-gray-800 text-sm align-top sticky left-0 z-20 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">
                                <div class="flex flex-col h-full justify-center">
                                    <span class="text-base font-extrabold text-indigo-900">${machineCode}</span>
                                    <span class="text-[10px] text-gray-400 font-mono mt-0.5">${machine.type}</span>
                                </div>
                            </td>
                          `;
                    }

                    // CELL: SHIFT
                    let shiftIcon = '';
                    let shiftClass = '';
                    if (shift === 1) { shiftIcon = ''; shiftClass = 'text-orange-500 bg-orange-50/50'; }
                    if (shift === 2) { shiftIcon = ''; shiftClass = 'text-blue-500 bg-blue-50/50'; }
                    if (shift === 3) { shiftIcon = ''; shiftClass = 'text-indigo-900 bg-indigo-50/50'; }

                    tbodyHTML += `
                        <td class="py-1 px-1 border-r border-b border-gray-200 text-center text-xs font-bold sticky left-32 z-20 ${shiftClass}">
                            <div class="flex items-center justify-center gap-1">
                                <span>${shiftIcon}</span> <span>${shift}</span>
                            </div>
                        </td>
                      `;

                    // CELL: DATA PER DATE
                    dateArray.forEach(date => {
                        const dateYMD = formatDateToYMD(date);
                        const shiftName = `Shift ${shift}`;
                        const key = `${machineCode}|${dateYMD}|${shiftName}`;
                        const item = scheduleData[key];
                        const isWeekend = (date.getDay() === 0 || date.getDay() === 6);
                        const weekendBg = isWeekend ? 'bg-red-50/30' : '';

                        let cellContent = '';
                        let cellClass = `border-r border-b border-gray-100 p-1 h-14 w-[100px] relative group cursor-pointer align-top ${weekendBg}`;
                        let clickAction = '';

                        if (item) {
                            // ITEM EXISTS
                            const productCode = item.product_code;
                            const productName = item.product_name || '';

                            // Get Color
                            let color = item.color;
                            if (!color) {
                                const prod = Object.values(productionData).find(p => p.code === productCode);
                                color = prod ? prod.color : '';
                            }

                            const colorClass = getColorClass(color);
                            const textColorClass = colorClass.includes('text-white') ? 'text-white' : 'text-gray-900';

                            // Check collision with ID for edit
                            // We construct object explicitly to avoid issues
                            const itemDataObj = {
                                id: item.id,
                                mesin: item.mesin,
                                schedule_date: item.schedule_date,
                                schedule_shift: item.schedule_shift,
                                product_code: item.product_code,
                                product_name: item.product_name,
                                order_qty: item.order_qty
                            };
                            const safeItem = JSON.stringify(itemDataObj).replace(/"/g, '&quot;');

                            cellContent = `
                                <div class="w-full h-full rounded shadow-sm flex flex-col justify-center px-1.5 py-1 text-xs ${colorClass} bg-opacity-95 border hover:scale-[1.03] hover:shadow-md transition-all z-10 hover:z-30 leading-tight">
                                    <span class="font-extrabold truncate ${textColorClass}">${productCode}</span>
                                    <span class="truncate text-[9px] ${textColorClass} opacity-80 mt-0.5">${shortenComponentName(productName)}</span>
                                </div>
                              `;

                            if (isLoggedIn) {
                                // EDIT
                                clickAction = `onclick='startScheduleEdit(${safeItem})'`;
                            }

                        } else {
                            // EMPTY SLOT
                            if (isLoggedIn) {
                                cellClass += ' hover:bg-indigo-50 hover:border-indigo-200 transition-colors duration-200';
                                clickAction = `onclick="openAddScheduleModal('${machineCode}', '${formatDateToDMY(date)}', '${shiftName}')"`;

                                // Add Button
                                cellContent = `
                                    <div class="hidden group-hover:flex w-full h-full items-center justify-center text-indigo-300">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                        </svg>
                                    </div>
                                  `;
                            }
                        }

                        if (isDuplicating && sourceDuplicateItem) {
                            // Paste Mode
                            clickAction = `onclick="handleCellClick(event)" data-machine="${machineCode}" data-date="${dateYMD}" data-shift="${shiftName}"`;
                            cellClass += ' hover:bg-yellow-100 hover:shadow-inner';
                        }

                        tbodyHTML += `<td class="${cellClass}" ${clickAction}>${cellContent}</td>`;
                    });

                    tbodyHTML += `</tr>`;
                }
            });

            tbodyHTML += `</tbody>`;

            actualTable.innerHTML = theadHTML + tbodyHTML;

            updateMachineActivityChart(startDate, endDate, dateArray);
        }

        window.updateMachineActivityChart = function (startDate, endDate, dateArray) {
            const ctx = document.getElementById('machineActivityChart');
            if (!ctx) return;

            if (typeof Chart === 'undefined') {
                document.getElementById('chartPlaceholder').classList.add('hidden'); // Hide placeholder anyway
                return;
            }

            // Destroy old chart if exists
            if (planningChartInstance) {
                planningChartInstance.destroy();
            }

            // Data Preparation
            const dailyStats = dateArray.map(date => {
                const dateYMD = formatDateToYMD(date);
                let activeCodes = new Set();
                let uniqueComponents = new Set();

                STATIC_MACHINE_DATA.forEach(m => {
                    for (let s = 1; s <= 3; s++) {
                        const key = `${m.code}|${dateYMD}|Shift ${s}`;
                        const item = scheduleData[key];
                        if (item) {
                            activeCodes.add(item.product_code);
                            uniqueComponents.add(item.product_name);
                        }
                    }
                });

                return {
                    dateLabel: formatDateToDMY(date).substring(0, 5), // DD/MM
                    activeCodes: activeCodes.size,
                    uniqueComponents: uniqueComponents.size,
                    displayDate: formatDateToDMY(date) // For tooltip
                };
            });

            const labels = dailyStats.map(d => d.dateLabel);
            const dataCodes = dailyStats.map(d => d.activeCodes);
            const dataComponents = dailyStats.map(d => d.uniqueComponents);

            // Create New Chart
            planningChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Kode Unik',
                            data: dataCodes,
                            borderColor: 'rgb(79, 70, 229)', // Indigo 600
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'Item Komponen',
                            data: dataComponents,
                            borderColor: 'rgb(16, 185, 129)', // Green 500
                            backgroundColor: 'rgba(16, 185, 129, 0.05)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.3,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top', align: 'end' },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { borderDash: [2, 4] } },
                        x: { grid: { display: false } }
                    }
                }
            });

            document.getElementById('chartPlaceholder').classList.add('hidden');
        }

        window.exportPlanningMatrixToExcel = function () {
            if (typeof XLSX === 'undefined') {
                showMessage("Library Excel belum siap. Silakan refresh.", "error");
                return;
            }

            const table = document.getElementById('planningActualTable');
            if (!table || table.rows.length < 2) {
                showMessage("Tabel Jadwal masih kosong. Tampilkan jadwal terlebih dahulu.", "error");
                return;
            }

            const startDateStr = document.getElementById('startDate').value.replace(/\//g, '-');
            const endDateStr = document.getElementById('endDate').value.replace(/\//g, '-');
            const fileName = `Jadwal_Produksi_${startDateStr}_sd_${endDateStr}.xlsx`;

            // Convert HTML table to Sheet
            const wb = XLSX.utils.table_to_book(table, { sheet: "Jadwal Produksi" });
            XLSX.writeFile(wb, fileName);
        }

        // --- NEW: MISSING CORE DATA FETCHERS ---

        function parseDMY(dmy) {
            if (!dmy) return null;
            const parts = dmy.split('/');
            if (parts.length !== 3) return null;
            // Note: Month is 0-indexed in JS Date
            return new Date(parseInt(parts[2], 10), parseInt(parts[1], 10) - 1, parseInt(parts[0], 10));
        }

        function formatDateToDMY(date) {
            if (!date) return '';
            let d = date.getDate();
            let m = date.getMonth() + 1;
            let y = date.getFullYear();
            return `${d.toString().padStart(2, '0')}/${m.toString().padStart(2, '0')}/${y}`;
        }

        function formatDateToYMD(date) {
            if (!date) return '';
            let d = date.getDate();
            let m = date.getMonth() + 1;
            let y = date.getFullYear();
            return `${y}-${m.toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
        }

        async function fetchScheduleData(startDateStr, endDateStr) {
            const startYMD = formatDateToYMD(parseDMY(startDateStr));
            const endYMD = formatDateToYMD(parseDMY(endDateStr));

            try {
                const { data, error } = await supabase
                    .from(SCHEDULE_TABLE_NAME)
                    .select('*')
                    .gte('schedule_date', startYMD)
                    .lte('schedule_date', endYMD);

                if (error) throw error;

                if (data) {
                    processScheduleData(data); // Populates global scheduleData
                }

            } catch (e) {
                console.error("Error fetching schedule data:", e);
                showMessage("Gagal mengambil data jadwal: " + e.message, "error");
            }
        }

        async function fetchAllScheduleData() {
            try {
                // Limit to last 2000 records
                const { data, error } = await supabase
                    .from(SCHEDULE_TABLE_NAME)
                    .select('*')
                    .order('schedule_date', { ascending: false })
                    .limit(2000);

                if (error) throw error;

                masterScheduleData = data || [];
                const countElem = document.getElementById('scheduleMasterTotalCount');
                if (countElem) countElem.textContent = `(${masterScheduleData.length} records)`;

                renderScheduleMasterTable();

            } catch (e) {
                console.error("Error fetching all schedule data:", e);
                showMessage("Gagal mengambil data master jadwal: " + e.message, "error");
            }
        }

        function renderScheduleMasterTable(searchTerm = '') {
            const container = document.getElementById('scheduleMasterContainer');
            if (!container) return;

            let filteredData = masterScheduleData;
            if (searchTerm) {
                const lower = searchTerm.toLowerCase();
                filteredData = masterScheduleData.filter(item =>
                    (item.product_code && item.product_code.toLowerCase().includes(lower)) ||
                    (item.product_name && item.product_name.toLowerCase().includes(lower)) ||
                    (item.mesin && item.mesin.toLowerCase().includes(lower)) ||
                    (item.schedule_shift && item.schedule_shift.toLowerCase().includes(lower))
                );
            }

            if (filteredData.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Tidak ada data jadwal yang ditemukan.</p>';
                return;
            }

            let html = `
            <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200 bg-white max-h-[60vh] overflow-y-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0 z-10">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mesin</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Shift</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Barang</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Qty (Dus)</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            filteredData.forEach(item => {
                const dateStr = formatDateToDMY(new Date(item.schedule_date));
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${dateStr}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-800 font-bold">${item.mesin}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-600">${item.schedule_shift}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-800 font-mono">${item.product_code}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-600 truncate max-w-[200px]">${item.product_name || '-'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-800 text-right">${item.order_qty || 0}</td>
                    </tr>
                 `;
            });

            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }

        function processScheduleData(data) {
            // Global data processing for schedule items
            if (data) {
                data.forEach(item => {
                    const key = `${item.mesin}|${item.schedule_date}|${item.schedule_shift}`;
                    scheduleData[key] = item;
                });
            }
        }

        // SHIM to prevent ReferenceError in showView and other places
        window.checkSlotAvailability = function (product = null) {
            // Forwarding to specialized versions if available
            if (document.getElementById('scheduleAddModal')?.classList.contains('hidden') === false) {
                if (typeof checkSlotAvailability_AddModal === 'function') checkSlotAvailability_AddModal(product);
            } else if (document.getElementById('scheduleEditModal')?.classList.contains('hidden') === false) {
                if (typeof checkSlotAvailability_Modal === 'function') checkSlotAvailability_Modal(product);
            }
        };

        // GLOBAL ERROR HANDLER TO CAPTURE "NOT CLICKABLE" ISSUES
        window.onerror = function (message, source, lineno, colno, error) {
            console.error("GLOBAL JS ERROR DETECTED:", message, "at", source, ":", lineno);
            if (window.showMessage) {
                showMessage(`System Error: ${message} (Line ${lineno})`, "error");
            }
            return false;
        };

        function populateProductDatalist() {
            const datalist = document.getElementById('productCodeList');
            datalist.innerHTML = '';

            const uniqueCodes = {};
            for (const id in productionData) {
                const data = productionData[id];
                if (!uniqueCodes[data.code]) {
                    uniqueCodes[data.code] = true;
                    const option = document.createElement('option');
                    option.value = data.code;
                    option.textContent = `${data.code} - ${data.name} (${data.machine}) [Target 1 Shift: ${data.targetPerShift.toLocaleString('id-ID', { maximumFractionDigits: 0 })} pcs]`;
                    datalist.appendChild(option);
                }
            }
        }

        function renderRateTable(searchQuery = '') {
            const container = document.getElementById('rateTableContainer');
            const dataArray = Object.values(productionData);
            const totalCountSpan = document.getElementById('masterDataTotalCount');

            if (dataArray.length === 0) {
                container.innerHTML = '<p class="text-gray-500 p-4">Belum ada data produksi yang tersimpan. Silakan tambahkan data menggunakan formulir di halaman Estimasi Produksi (setelah login admin).</p>';
                return;
            }

            const filteredData = dataArray.filter(data => {
                if (!searchQuery) return true;
                const query = searchQuery.toLowerCase();
                return (
                    data.code.toLowerCase().includes(query) ||
                    data.name.toLowerCase().includes(query) ||
                    (data.color && data.color.toLowerCase().includes(query)) ||
                    data.machine.toLowerCase().includes(query) ||
                    (data.machine_optional && data.machine_optional.toLowerCase().includes(query))
                );
            });

            if (totalCountSpan) {
                if (searchQuery) {
                    totalCountSpan.textContent = `(Menampilkan ${filteredData.length} dari ${dataArray.length} total)`;
                } else {
                    totalCountSpan.textContent = `(${dataArray.length} Total)`;
                }
            }

            filteredData.sort((a, b) => a.code.localeCompare(b.code));

            if (filteredData.length === 0 && searchQuery) {
                container.innerHTML = `<p class="text-gray-500 p-4">Tidak ada hasil ditemukan untuk "${searchQuery}".</p>`;
                return;
            }

            // Samakan padding header aksi dengan tabel sebelah
            // Menggunakan percentage widths agar tabel full dan tidak scroll
            const actionHeader = isLoggedIn ? '<th class="py-2 px-2 border-b text-center" style="width: 8%">Aksi</th>' : '';

            let tableHTML = `
        <div class="w-full overflow-x-auto overflow-y-auto max-h-[70vh] border border-gray-200 rounded-lg shadow-sm">
            <table class="min-w-[800px] w-full bg-white text-sm">
                <thead class="sticky top-0 bg-gray-100 z-10">
                    <tr class="text-left font-semibold text-gray-600 uppercase tracking-wider">
                        <th class="py-2 px-2 border-b text-center w-12">#</th>
                        <th class="py-2 px-2 border-b" title="Kode Barang">Kode</th>
                        <th class="py-2 px-2 border-b" title="Nama Komponen / Produk">Nama Produk</th>
                        <th class="py-2 px-2 border-b" title="Warna">Warna</th>
                        <th class="py-2 px-2 border-b" title="Mesin Utama">Mesin</th>
                        <th class="py-2 px-2 border-b" title="Mesin Optional">Mesin (Opt)</th>
                        <th class="py-2 px-2 border-b text-right" title="Isi Dus (pcs)">Isi Dus</th>
                        <th class="py-2 px-2 border-b text-right" title="Target 1 Shift">Target</th>
                        <th class="py-2 px-2 border-b text-right font-bold text-red-600" title="Kapasitas 3 Shift">Kap. 3 Shift</th>
                        ${actionHeader}
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
    `;

            filteredData.forEach((data, index) => {
                const rowClass = (index % 2 === 0) ? '' : 'bg-gray-50';
                const capacity3ShiftPcs = data.targetPerShift * SHIFTS_PER_DAY;

                const actionButtons = isLoggedIn ? `
            <td class="py-1.5 px-2 text-center whitespace-nowrap space-x-1 ${rowClass}">
                <button onclick="startEditData('${data.id}')"
                        class="text-indigo-500 hover:text-indigo-700 p-0.5 rounded transition hover:bg-indigo-50"
                        title="Edit Data">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                        <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                    </svg>
                </button>

                <button onclick="prepareDelete('${data.id}')"
                        class="text-red-500 hover:text-red-700 p-0.5 rounded transition hover:bg-red-50"
                        title="Hapus Data">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </button>
            </td>
        ` : '';

                // Perubahan Tipografi agar konsisten dengan Tabel Jadwal:
                // 1. Kode Barang: font-mono font-bold text-gray-700 (UPDATED: font-medium -> font-bold)
                // 2. Mesin Utama: font-bold text-gray-800
                // 3. Warna: text-gray-600
                // 4. Mesin Optional: text-xs (lebih kecil agar rapi)

                tableHTML += `
            <tr class="hover:bg-indigo-50 transition duration-150 ${rowClass}">
                <td class="py-2.5 px-2 text-center text-gray-600 font-medium ${rowClass}">${index + 1}</td>
                <td class="py-2.5 px-2 text-gray-800 font-mono font-bold truncate text-sm" title="${data.code}">${data.code}</td>
                <td class="py-2.5 px-2 text-gray-800 font-semibold truncate text-sm" title="${data.name}">${data.name}</td>
                <td class="py-2.5 px-2 text-gray-600 truncate text-xs" title="${data.color || '-'}">${data.color || '-'}</td>
                <td class="py-2.5 px-2 text-gray-900 font-bold truncate text-sm" title="${data.machine}">${data.machine}</td> 
                <td class="py-2.5 px-2 text-gray-500 text-xs truncate" title="${data.machine_optional || '-'}">${data.machine_optional || '-'}</td>
                <td class="py-2.5 px-2 text-right text-gray-700 font-medium whitespace-nowrap text-sm">${data.pcs_per_box.toLocaleString('id-ID')}</td>
                <td class="py-2.5 px-2 text-right text-indigo-700 font-bold whitespace-nowrap text-sm">${data.targetPerShift.toLocaleString('id-ID')}</td>
                <td class="py-2.5 px-2 text-right font-extrabold text-red-600 bg-red-50/50 whitespace-nowrap text-sm">${capacity3ShiftPcs.toLocaleString('id-ID')}</td>
                ${actionButtons}
            </tr>
        `;
            });

            tableHTML += `
                    </tbody>
                </table>
            </div>
            `;
            container.innerHTML = tableHTML;
        }

        function groupProductionDataByMachine() {
            const machineData = {};

            STATIC_MACHINE_DATA.forEach(staticMachine => {
                const code = staticMachine.code ? staticMachine.code.trim() : null;
                if (code) {
                    machineData[code] = {
                        machineCode: code,
                        type: staticMachine.type || 'N/A',
                        products: []
                    };
                }
            });

            Object.values(productionData).forEach(item => {
                const machineCode = item.machine ? item.machine.trim() : null;

                if (machineCode && item.code && item.name && machineData[machineCode]) {
                    const isDuplicate = machineData[machineCode].products.some(p => p.code === item.code);
                    if (!isDuplicate) {
                        machineData[machineCode].products.push({ code: item.code, name: item.name });
                    }
                }
            });

            return Object.values(machineData)
                .sort((a, b) => a.machineCode.localeCompare(b.machineCode));
        }

        function populateMachineDropdowns() {
            const selects = [
                document.getElementById('modalScheduleMachine'),
                document.getElementById('addScheduleMachine')
            ];
            const groupedMachines = groupProductionDataByMachine();

            const placeholderEmpty = '<option value="" disabled selected>Tidak ada Mesin di Data Master</option>';
            const placeholderDefault = '<option value="" disabled selected>Pilih Mesin</option>';

            selects.forEach(select => {
                if (!select) return; // UPDATE: Skip jika elemen tidak ditemukan (misal sudah dihapus)

                select.innerHTML = (groupedMachines.length === 0) ? placeholderEmpty : placeholderDefault;
                if (groupedMachines.length === 0) return;

                groupedMachines.forEach(machine => {
                    const option = document.createElement('option');
                    option.value = machine.machineCode;
                    option.textContent = `${machine.machineCode} (${machine.type || 'N/A'})`;
                    select.appendChild(option.cloneNode(true));
                });
            });
        }




        async function updateScheduleSlotFromModal(forceWeekend = false) {
            if (!isLoggedIn) {
                showMessage("Akses ditolak. Silakan Login sebagai Admin untuk menjadwalan.", "error");
                return;
            }

            const machineDropdown = document.getElementById('modalScheduleMachine');
            const dateStr = document.getElementById('modalScheduleDate').value;
            const shift = document.getElementById('modalScheduleShift').value;
            const code = document.getElementById('modalScheduleCode').value.trim();
            const orderQty = document.getElementById('modalScheduleQty').value;
            const currentId = document.getElementById('modalScheduleId').value;

            if (!machineDropdown.value || !dateStr || !shift || !code || !currentId) {
                showMessage("Data tidak lengkap. Gagal mengupdate.", "error");
                return;
            }

            const parsedDate = parseDMY(dateStr);
            if (!parsedDate) {
                showMessage("Format Tanggal tidak valid. Harap gunakan format DD/MM/YYYY.", "error");
                return;
            }

            const isWeekend = (parsedDate.getDay() === 0 || parsedDate.getDay() === 6);

            if (isWeekend && !forceWeekend) {
                toggleWeekendConfirmModal(true, 'update', dateStr);
                return;
            }

            const dbDate = formatDateToYMD(parsedDate);

            const productDataForCheck = Object.values(productionData).find(p => p.code === code);
            await checkSlotAvailability_Modal(productDataForCheck);

            const finalMachineToSave = machineDropdown.value;
            const finalKey = `${finalMachineToSave}|${dbDate}|${shift}`;
            const finalScheduleItem = scheduleData[finalKey];

            if (finalScheduleItem && finalScheduleItem.id != currentId) {
                showMessage(`SLOT PENUH (Mesin ${finalMachineToSave}). Gagal mengupdate.`, "error");
                return;
            }

            const dataToSave = {
                mesin: finalMachineToSave,
                schedule_date: dbDate,
                schedule_shift: shift,
                product_code: code,
                product_name: document.getElementById('modalScheduleName').value,
                order_qty: orderQty, // Update qty
                timestamp: new Date().toISOString()
            };

            try {
                const { data, error } = await supabase
                    .from(SCHEDULE_TABLE_NAME)
                    .update(dataToSave)
                    .eq('id', currentId)
                    .select();

                if (error) throw error;

                showMessage(`Slot ${code} untuk Mesin ${finalMachineToSave} Shift ${shift.split(' ')[1]} pada ${dateStr} berhasil diperbarui!`, "info");

                toggleScheduleEditModal(false);

                // --- OPTIMISTIC UPDATE ---
                // 1. Remove old entry
                const existingItem = Object.values(scheduleData).find(i => i.id == currentId);
                if (existingItem) {
                    const oldKey = `${existingItem.mesin}|${existingItem.schedule_date}|${existingItem.schedule_shift}`;
                    delete scheduleData[oldKey];
                }
                // 2. Add new entry
                const newItem = (data && data.length > 0) ? data[0] : { ...dataToSave, id: parseInt(currentId) };
                const newKey = `${newItem.mesin}|${newItem.schedule_date}|${newItem.schedule_shift}`;
                scheduleData[newKey] = newItem;


                const start = document.getElementById('startDate').value;
                const end = document.getElementById('endDate').value;

                if (start && end) {
                    renderPlanningTable(start, end, true);
                }

            } catch (e) {
                console.error("Error updating schedule slot:", e);
                let errorMessage = `Gagal mengupdate jadwal.Error: ${e.message} `;
                if (e.code && (e.code === '401' || e.code === '403')) {
                    errorMessage = "Gagal mengupdate. Cek pengaturan RLS (Row Level Security) di Supabase untuk tabel jadwal.";
                }
                showMessage(errorMessage, "error");
            }
        }



        window.confirmScheduleDelete = async function () {
            const idToDelete = document.getElementById('deleteScheduleIdConfirm').value;
            toggleScheduleDeleteModal(false);

            if (idToDelete) {
                try {
                    const { error } = await supabase
                        .from(SCHEDULE_TABLE_NAME)
                        .delete()
                        .eq('id', idToDelete);

                    if (error) throw error;

                    showMessage("Slot jadwal berhasil dihapus!", "info");

                    // --- OPTIMISTIC UPDATE ---
                    const itemToDelete = Object.values(scheduleData).find(i => i.id == idToDelete);
                    if (itemToDelete) {
                        const key = `${itemToDelete.mesin}|${itemToDelete.schedule_date}|${itemToDelete.schedule_shift}`;
                        delete scheduleData[key];
                    }

                    const start = document.getElementById('startDate').value;
                    const end = document.getElementById('endDate').value;

                    if (start && end) {
                        renderPlanningTable(start, end, true);
                    }

                    fetchAllScheduleData().then(() => {
                        renderScheduleMasterTable(document.getElementById('scheduleMasterSearchInput').value);
                    });

                } catch (e) {
                    console.error("Error deleting schedule slot:", e);
                    showMessage("Gagal menghapus slot jadwal. Cek koneksi atau izin RLS.", "error");
                }
            }
        }

        window.toggleScheduleDeleteModal = function (show) {
            document.getElementById('scheduleDeleteModal').classList.toggle('hidden', !show);
        }

        window.prepareScheduleDelete = function (id, code, date, shift) {
            if (!isLoggedIn) {
                showMessage("Akses ditolak. Silakan Login sebagai Admin.", "error");
                return;
            }

            document.getElementById('deleteScheduleDisplay').textContent = `${code} (${date} - ${shift.split(' ')[1]})`;
            document.getElementById('deleteScheduleIdConfirm').value = id;
            toggleScheduleDeleteModal(true);
        }

        window.toggleScheduleDeleteModal = function (show) {
            document.getElementById('scheduleDeleteModal').classList.toggle('hidden', !show);
        }


        window.toggleScheduleEditModal = function (show) {
            document.getElementById('scheduleEditModal').classList.toggle('hidden', !show);
        }

        window.toggleProductionModal = function (show) {
            document.getElementById('productionDataModal').classList.toggle('hidden', !show);
            if (!show) {
                // Opsional: Cek jika sedang mode edit, mungkin perlu confirm sebelum close?
                // Untuk sekarang, kita biarkan saja. User bisa buka lagi data masih ada.
            }
        }


        window.startScheduleEdit = function (scheduleItem) {
            if (!isLoggedIn) {
                showMessage("Anda harus Login Admin untuk mengedit jadwal.", "error");
                return;
            }

            const parts = scheduleItem.schedule_date.split('-');
            const displayDate = `${parts[2]} /${parts[1]}/${parts[0]} `;

            document.getElementById('modalScheduleId').value = scheduleItem.id;
            document.getElementById('modalScheduleMachine').value = scheduleItem.mesin;
            document.getElementById('modalScheduleDate').value = displayDate;
            document.getElementById('modalScheduleShift').value = scheduleItem.schedule_shift;
            document.getElementById('modalScheduleCode').value = scheduleItem.product_code;
            document.getElementById('modalScheduleQty').value = scheduleItem.order_qty || ''; // Load existing qty

            findProductNameByCode_Modal();

            setTimeout(() => {
                const nameDropdown = document.getElementById('modalScheduleName');
                nameDropdown.value = scheduleItem.product_name;

                if (nameDropdown.value) {
                    handleComponentSelectionChange_Modal();
                }
            }, 100);

            toggleScheduleEditModal(true);
        }





        window.findProductNameByCode_Modal = function () {
            const codeInput = document.getElementById('modalScheduleCode');
            const nameDropdown = document.getElementById('modalScheduleName');
            const machineDropdown = document.getElementById('modalScheduleMachine');
            const code = codeInput.value.trim().toUpperCase();
            const currentId = document.getElementById('modalScheduleId').value;

            nameDropdown.innerHTML = '';

            if (!code) {
                nameDropdown.innerHTML = '<option value="" disabled selected>Otomatis (Isi Kode)</option>';
                checkSlotAvailability_Modal(null);
                return;
            }

            const matchingProducts = Object.values(productionData).filter(p => p.code === code);

            if (matchingProducts.length > 0) {
                if (matchingProducts.length > 1) {
                    nameDropdown.innerHTML = '<option value="" disabled selected>Pilih Komponen...</option>';
                }

                matchingProducts.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.name;
                    option.textContent = product.name;
                    nameDropdown.appendChild(option);
                });

            } else {
                nameDropdown.innerHTML = '<option value="" disabled>Kode tidak ditemukan</option>';
                checkSlotAvailability_Modal(null);
            }
        }

        window.handleComponentSelectionChange_Modal = function () {
            const code = document.getElementById('modalScheduleCode').value.trim().toUpperCase();
            const componentName = document.getElementById('modalScheduleName').value;
            const machineDropdown = document.getElementById('modalScheduleMachine');
            const currentId = document.getElementById('modalScheduleId').value;

            if (!code || !componentName) {
                checkSlotAvailability_Modal(null);
                return;
            }

            const product = Object.values(productionData).find(p => p.code === code && p.name === componentName);

            checkSlotAvailability_Modal(product);
        }

        window.checkSlotAvailability_Modal = async function (productData = null) {
            const messageEl = document.getElementById('modalSlotStatusMessage');
            if (!messageEl) {
                return;
            }

            const machineDropdown = document.getElementById('modalScheduleMachine');
            const dateStr = document.getElementById('modalScheduleDate').value;
            const shift = document.getElementById('modalScheduleShift').value;
            const codeInput = document.getElementById('modalScheduleCode');
            const code = codeInput.value.trim().toUpperCase();
            const currentId = document.getElementById('modalScheduleId').value;

            if (!isLoggedIn || !code || !dateStr || !shift) {
                messageEl.textContent = ''; return;
            }

            const parsedDate = parseDMY(dateStr);
            if (!parsedDate) {
                messageEl.textContent = 'Format Tanggal Salah';
                messageEl.className = 'text-sm font-bold mt-3 text-center text-red-600';
                return;
            }
            const dbDate = formatDateToYMD(parsedDate);

            if (!productData) {
                const componentName = document.getElementById('modalScheduleName').value;
                if (componentName) {
                    productData = Object.values(productionData).find(p => p.code === code && p.name === componentName);
                } else {
                    productData = Object.values(productionData).find(p => p.code === code);
                }
            }

            if (!productData) {
                messageEl.textContent = '';
                return;
            }

            const machinesToCheck = [];
            if (productData.machine) machinesToCheck.push(productData.machine);
            if (productData.machine_optional) {
                productData.machine_optional.split(',').map(m => m.trim().toUpperCase()).filter(m => m && !machinesToCheck.includes(m)).forEach(m => machinesToCheck.push(m));
            }

            if (machinesToCheck.length === 0) {
                messageEl.textContent = 'Produk ini tidak memiliki Mesin Utama/Optional';
                messageEl.className = 'text-sm font-bold mt-3 text-center text-orange-600';
                return;
            }

            const tableStartDateStr = document.getElementById('startDate').value;
            const tableEndDateStr = document.getElementById('endDate').value;
            let needsFetch = true;
            if (tableStartDateStr && tableEndDateStr) {
                const tableStart = parseDMY(tableStartDateStr);
                const tableEnd = parseDMY(tableEndDateStr);
                if (tableStart && tableEnd && parsedDate >= tableStart && parsedDate <= tableEnd) {
                    needsFetch = false;
                }
            }
            if (needsFetch) {
                await fetchScheduleData(dateStr, dateStr);
            }

            let foundAvailableSlot = false;
            let bestAvailableMachine = null;
            let statusMessage = '';
            let messageColor = 'text-green-600';

            for (const machineToCheck of machinesToCheck) {
                const key = `${machineToCheck}|${dbDate}|${shift}`;
                const scheduleItem = scheduleData[key];

                if (!scheduleItem || (currentId && scheduleItem.id == currentId)) {
                    const optionExists = Array.from(machineDropdown.options).some(opt => opt.value === machineToCheck);
                    if (optionExists) {
                        foundAvailableSlot = true;
                        bestAvailableMachine = machineToCheck;

                        if (machineToCheck === machineDropdown.value) {
                            break;
                        }
                    } else {
                        if (!bestAvailableMachine) {
                            bestAvailableMachine = machineToCheck;
                        }
                    }
                }
            }

            if (foundAvailableSlot && bestAvailableMachine) {
                const selectedMachine = machineDropdown.value;
                if (!machinesToCheck.includes(selectedMachine)) {
                    statusMessage = 'Mesin tidak valid untuk produk ini!';
                    messageColor = 'text-red-600';
                } else {
                    const key = `${selectedMachine}|${dbDate}|${shift}`;
                    const scheduleItem = scheduleData[key];
                    if (!scheduleItem || (currentId && scheduleItem.id == currentId)) {
                        statusMessage = 'Slot Tersedia';
                        messageColor = 'text-green-600';
                    } else {
                        statusMessage = 'SLOT PENUH (Mesin yg dipilih)';
                        messageColor = 'text-red-600';
                    }
                }
            } else if (!foundAvailableSlot && bestAvailableMachine) {
                statusMessage = `Slot Tersedia di ${bestAvailableMachine} (Opsional, tidak ada di list)`;
                messageColor = 'text-orange-600';
            } else {
                statusMessage = `SLOT PENUH(Mesin Utama & Optional)`;
                messageColor = 'text-red-600';
            }

            messageEl.textContent = statusMessage;
            messageEl.className = `text-sm font-bold mt-3 text-center ${messageColor}`;
        }

        function parseDMY(dateString) {
            if (!dateString) return null;
            const parts = dateString.split('/');
            if (parts.length !== 3) return null;

            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10);
            const year = parseInt(parts[2], 10);

            const date = new Date(year, month - 1, day);

            if (isNaN(date.getTime()) || date.getFullYear() !== year || date.getMonth() !== (month - 1) || date.getDate() !== day) {
                return null;
            }
            return date;
        }

        window.formatDateInput = function (input) {
            let value = input.value.replace(/\D/g, '');
            let formattedValue = '';

            if (value.length > 0) {
                formattedValue = value.substring(0, 2);
            }
            if (value.length >= 3) {
                formattedValue += '/' + value.substring(2, 4);
            }
            if (value.length >= 5) {
                formattedValue += '/' + value.substring(4, 8);
            }

            input.value = formattedValue;
        }

        function formatDateToDMY(date) {
            if (!(date instanceof Date) || isNaN(date)) return '';
            const d = date.getDate().toString().padStart(2, '0');
            const m = (date.getMonth() + 1).toString().padStart(2, '0');
            const y = date.getFullYear();
            return `${d}/${m}/${y}`;
        }

        window.autoSetEndDate = function () {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const startDate = parseDMY(startDateInput.value);

            if (startDate && (!endDateInput.value || endDateInput.value === startDateInput.value)) {
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
                endDateInput.value = formatDateToDMY(endDate);
            }
        }

        function getDatesInRange(startDate, endDate) {
            const dates = [];
            let currentDate = new Date(startDate);
            const stopDate = new Date(endDate);

            const dateFormatter = new Intl.DateTimeFormat('en-GB', { day: '2-digit', month: '2-digit' });
            const dayFormatter = new Intl.DateTimeFormat('id-ID', { weekday: 'short' });

            while (currentDate <= stopDate) {
                const date = new Date(currentDate);
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;

                dates.push({
                    date: date,
                    displayDate: dateFormatter.format(date),
                    weekday: dayFormatter.format(date),
                    isWeekend: isWeekend,
                    dbDate: formatDateToYMD(date)
                });

                currentDate.setDate(currentDate.getDate() + 1);
            }
            return dates;
        }

        window.closePlanningTable = function () {
            document.getElementById('planningActualTable').innerHTML = '';
            // Sembunyikan Section container baru
            document.getElementById('planningResultSection').classList.add('hidden');

            document.getElementById('planningTablePlaceholder').classList.remove('hidden');

            const summaryContainer = document.getElementById('dailySummaryContainer');
            const summaryWrapper = document.getElementById('dailySummaryWrapper');
            summaryContainer.classList.add('hidden');
            summaryWrapper.innerHTML = '';

            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';

            // Explicitly reset title (optional check)
            if (document.querySelector('#planningView h2')) {
                document.querySelector('#planningView h2').textContent = `Perencanaan Jadwal Mesin`;
            }

            // RESET CHART
            if (window.planningChartInstance) {
                window.planningChartInstance.destroy();
                window.planningChartInstance = null;
            }
            // Force clear canvas to be sure
            const ctx = document.getElementById('machineActivityChart').getContext('2d');
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

            document.getElementById('chartPlaceholder').classList.remove('hidden');
        }

        window.handleDragStart = function (event, scheduleId, productCode) {
            draggedItemData = {
                id: scheduleId,
                code: productCode
            };
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', JSON.stringify(draggedItemData));
        }

        window.allowDrop = function (event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
        }

        window.handleDragEnter = function (event) {
            event.preventDefault();
            if (event.currentTarget.tagName === 'TD') {
                event.currentTarget.classList.add('drag-over');
            }
        }

        window.handleDragLeave = function (event) {
            if (event.currentTarget.tagName === 'TD') {
                event.currentTarget.classList.remove('drag-over');
            }
        }

        window.handleDrop = async function (event) {
            event.preventDefault();

            // Clean visual styles
            if (event.currentTarget.tagName === 'TD') {
                event.currentTarget.classList.remove('drag-over');
            }

            if (!isLoggedIn) {
                showMessage("Anda harus Login Admin untuk memindahkan jadwal.", "error");
                return;
            }

            if (!draggedItemData) return;
            const sourceId = draggedItemData.id;
            const sourceCode = draggedItemData.code;

            const targetMachine = event.currentTarget.getAttribute('data-machine');
            const targetDate = event.currentTarget.getAttribute('data-date');
            const targetShift = event.currentTarget.getAttribute('data-shift');

            if (!targetMachine || !targetDate || !targetShift) {
                console.warn("Target drop tidak valid");
                return;
            }

            const sourceItem = Object.values(scheduleData).find(item => item.id == sourceId);
            // Drop on self check
            if (sourceItem && sourceItem.mesin === targetMachine && sourceItem.schedule_date === targetDate && sourceItem.schedule_shift === targetShift) {
                return;
            }

            const targetKey = `${targetMachine}| ${targetDate}| ${targetShift} `;
            const targetItem = scheduleData[targetKey];

            // === LOGIKA BARU: SWAP DENGAN KONFIRMASI ===
            if (targetItem) {
                // Validasi Warna untuk Swap (Dua Arah)
                const sourceColor = sourceItem.color || (Object.values(productionData).find(p => p.code === sourceItem.product_code && p.name === sourceItem.product_name)?.color);
                const targetColor = targetItem.color || (Object.values(productionData).find(p => p.code === targetItem.product_code && p.name === targetItem.product_name)?.color);

                const checkSourceToTarget = validateSlotColor(targetMachine, targetDate, targetShift, sourceColor);
                // Note: CheckTargetToSource checks against 'SourceItem' slot currently, which holds the item we are moving out.
                // Ideally we check previous slot of Source Slot. validateSlotColor does exactly that (looks up PREV slot).
                const checkTargetToSource = validateSlotColor(sourceItem.mesin, sourceItem.schedule_date, sourceItem.schedule_shift, targetColor);

                if (!checkSourceToTarget.valid || !checkTargetToSource.valid) {
                    let warningMsg = "Terdeteksi Konflik Warna:";
                    if (!checkSourceToTarget.valid) warningMsg += `\n>> (Source->Target): ${checkSourceToTarget.message}`;
                    if (!checkTargetToSource.valid) warningMsg += `\n>> (Target->Source): ${checkTargetToSource.message}`;

                    if (!confirm(`${warningMsg}\n\nApakah Anda yakin ingin menukar jadwal ini?`)) {
                        return;
                    }
                }

                // Konfirmasi Swap (SELALU MUNCUL POPUP)
                const sourceDateObj = new Date(sourceItem.schedule_date);
                const targetDateObj = new Date(targetDate);
                const isSourceWeekend = (sourceDateObj.getDay() === 0 || sourceDateObj.getDay() === 6);
                const isTargetWeekend = (targetDateObj.getDay() === 0 || targetDateObj.getDay() === 6);

                pendingSwapUpdate = {
                    sourceId: sourceId,
                    targetId: targetItem.id,
                    sourceItem: sourceItem,
                    targetItem: targetItem,
                    targetCoordinates: {
                        mesin: targetMachine,
                        schedule_date: targetDate,
                        schedule_shift: targetShift
                    },
                    sourceCoordinates: {
                        mesin: sourceItem.mesin,
                        schedule_date: sourceItem.schedule_date,
                        schedule_shift: sourceItem.schedule_shift
                    }
                };

                // Panggil Modal Konfirmasi dengan Detail Barang
                toggleWeekendConfirmModal(true, 'swap', '', {
                    isRisk: (isSourceWeekend || isTargetWeekend),
                    source: sourceCode,
                    target: targetItem.product_code
                });

                draggedItemData = null;
                return;
            }

            // === LOGIKA LAMA: MOVE (KE SLOT KOSONG) ===
            const dateObj = new Date(targetDate);
            const isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6);

            pendingDropUpdate = {
                id: sourceId,
                machine: targetMachine,
                date: targetDate,
                shift: targetShift,
                displayDate: formatDateToDMY(dateObj)
            };

            if (isWeekend) {
                toggleWeekendConfirmModal(true, 'move', pendingDropUpdate.displayDate);
            } else {
                // Validasi Warna untuk Move
                const sourceItemForColor = Object.values(scheduleData).find(i => i.id == sourceId);
                const colorVal = sourceItemForColor ? (sourceItemForColor.color || Object.values(productionData).find(p => p.code === sourceItemForColor.product_code && p.name === sourceItemForColor.product_name)?.color) : null;

                const colorCheck = validateSlotColor(targetMachine, targetDate, targetShift, colorVal);
                if (!colorCheck.valid) {
                    if (!confirm(`PERINGATAN: ${colorCheck.message}\n\nLanjutkan pemindahan?`)) {
                        draggedItemData = null;
                        return;
                    }
                }
                processDropUpdate(false);
            }

            draggedItemData = null;
        }

        async function executeSwap() {
            if (!pendingSwapUpdate) return;

            const { sourceId, targetId, sourceCoordinates, targetCoordinates } = pendingSwapUpdate;

            try {
                // Update Source to Target Position
                const updateSource = supabase
                    .from(SCHEDULE_TABLE_NAME)
                    .update({
                        mesin: targetCoordinates.mesin,
                        schedule_date: targetCoordinates.schedule_date,
                        schedule_shift: targetCoordinates.schedule_shift,
                        timestamp: new Date().toISOString()
                    })
                    .eq('id', sourceId);

                // Update Target to Source Position
                const updateTarget = supabase
                    .from(SCHEDULE_TABLE_NAME)
                    .update({
                        mesin: sourceCoordinates.mesin,
                        schedule_date: sourceCoordinates.schedule_date,
                        schedule_shift: sourceCoordinates.schedule_shift,
                        timestamp: new Date().toISOString()
                    })
                    .eq('id', targetId);

                // Jalankan paralel
                const [res1, res2] = await Promise.all([updateSource, updateTarget]);

                if (res1.error) throw res1.error;
                if (res2.error) throw res2.error;

                showMessage(`Berhasil menukar posisi jadwal!`, "info");

                // --- OPTIMISTIC UPDATE ---
                const sourceItem = Object.values(scheduleData).find(i => i.id == sourceId);
                const targetItem = Object.values(scheduleData).find(i => i.id == targetId);

                if (sourceItem && targetItem) {
                    // Remove old keys
                    const oldKeySource = `${sourceCoordinates.mesin}|${sourceCoordinates.schedule_date}|${sourceCoordinates.schedule_shift}`;
                    const oldKeyTarget = `${targetCoordinates.mesin}|${targetCoordinates.schedule_date}|${targetCoordinates.schedule_shift}`;

                    delete scheduleData[oldKeySource];
                    delete scheduleData[oldKeyTarget];

                    // Update item properties
                    sourceItem.mesin = targetCoordinates.mesin;
                    sourceItem.schedule_date = targetCoordinates.schedule_date;
                    sourceItem.schedule_shift = targetCoordinates.schedule_shift;

                    targetItem.mesin = sourceCoordinates.mesin;
                    targetItem.schedule_date = sourceCoordinates.schedule_date;
                    targetItem.schedule_shift = sourceCoordinates.schedule_shift;

                    // Add new keys
                    const newKeySource = `${sourceItem.mesin}|${sourceItem.schedule_date}|${sourceItem.schedule_shift}`;
                    const newKeyTarget = `${targetItem.mesin}|${targetItem.schedule_date}|${targetItem.schedule_shift}`;

                    scheduleData[newKeySource] = sourceItem;
                    scheduleData[newKeyTarget] = targetItem;
                }

                const start = document.getElementById('startDate').value;
                const end = document.getElementById('endDate').value;

                // Skip fetchAllScheduleData
                if (start && end) {
                    renderPlanningTable(start, end, true);
                }
            } catch (e) {
                console.error("Error executing swap:", e);
                showMessage("Gagal menukar jadwal. Cek koneksi.", "error");
            } finally {
                pendingSwapUpdate = null;
            }
        }

        async function processDropUpdate(forceWeekend = false) {
            if (!pendingDropUpdate) return;

            const { id, machine, date, shift, displayDate } = pendingDropUpdate;

            try {
                const { error } = await supabase
                    .from(SCHEDULE_TABLE_NAME)
                    .update({
                        mesin: machine,
                        schedule_date: date,
                        schedule_shift: shift,
                        timestamp: new Date().toISOString()
                    })
                    .eq('id', id);

                if (error) throw error;

                showMessage(`Berhasil memindahkan jadwal ke ${machine} - ${displayDate} (${shift}).`, "info");

                // --- OPTIMISTIC UPDATE (Update Local Data) ---
                const sourceItem = Object.values(scheduleData).find(i => i.id == id);
                if (sourceItem) {
                    const oldKey = `${sourceItem.mesin}|${sourceItem.schedule_date}|${sourceItem.schedule_shift}`;
                    delete scheduleData[oldKey];

                    // Update properties
                    sourceItem.mesin = machine;
                    sourceItem.schedule_date = date;
                    sourceItem.schedule_shift = shift;

                    const newKey = `${machine}|${date}|${shift}`;
                    scheduleData[newKey] = sourceItem;
                }

                const start = document.getElementById('startDate').value;
                const end = document.getElementById('endDate').value;

                // SKIP fetchAllScheduleData() to reduce delay
                // renderPlanningTable with skipFetch = true
                if (start && end) {
                    renderPlanningTable(start, end, true);
                }

            } catch (e) {
                console.error("Error updating slot via DragDrop:", e);
                showMessage("Gagal memindahkan jadwal. Cek koneksi.", "error");
            } finally {
                pendingDropUpdate = null;
            }
        }

        window.renderPlanningTable = async function (startDateStr, endDateStr, skipFetch = false) {
            const container = document.getElementById('planningActualTable');
            const placeholder = document.getElementById('planningTablePlaceholder');
            const resultSection = document.getElementById('planningResultSection'); // Container baru
            const summaryContainer = document.getElementById('dailySummaryContainer');
            const summaryWrapper = document.getElementById('dailySummaryWrapper');
            summaryWrapper.innerHTML = '';

            const groupedData = groupProductionDataByMachine();
            const shifts = ['Shift 1', 'Shift 2', 'Shift 3'];

            const startDate = parseDMY(startDateStr);
            const endDate = parseDMY(endDateStr);

            if (!startDate || !endDate || startDate > endDate) {
                placeholder.innerHTML = '<p class="text-gray-500 p-4 bg-white">Silakan masukkan Tanggal Mulai dan Tanggal Akhir yang valid.</p>';
                placeholder.classList.remove('hidden');
                resultSection.classList.add('hidden');
                summaryContainer.classList.add('hidden');
                return;
            }

            const dates = getDatesInRange(startDate, endDate);
            const validGroupedData = groupedData.filter(m => m.machineCode && m.machineCode !== 'MESIN TAK DIKETAHUI');

            if (validGroupedData.length === 0) {
                placeholder.innerHTML = '<p class="text-gray-500 p-4 bg-white">Tidak ada data mesin.</p>';
                placeholder.classList.remove('hidden');
                resultSection.classList.add('hidden');
                summaryContainer.classList.add('hidden');
                return;
            }

            if (!skipFetch) {
                await fetchScheduleData(startDateStr, endDateStr);
            }

            // UBAT PERHITUNGAN: DARI TOTAL SLOT (MESIN x 3 SHIFT) MENJADI TOTAL MESIN (MESIN x 1)
            const totalMachines = validGroupedData.length;
            const scheduleValues = Object.values(scheduleData);
            let summaryHTML = '';

            const dailyStatsArray = []; // Array untuk menyimpan data statistik harian

            dates.forEach(d => {
                const dbDate = d.dbDate;
                let onMachines = 0;
                let offMachines = 0;
                // eslint-disable-next-line no-unused-vars
                let isHoliday = false;

                if (d.isWeekend) {
                    isHoliday = true;
                    offMachines = totalMachines; // Semua mesin dianggap off (libur/tidak aktif)

                    summaryHTML += `
                <div class="flex-shrink-0 w-44 p-3 bg-red-100 border border-red-200 rounded-lg shadow-sm">
                    <p class="font-bold text-red-800">${d.displayDate} (${d.weekday})</p>
                    <p class="text-sm text-red-700 mt-1 font-semibold">HARI LIBUR</p>
                    <p class="text-xs text-red-600 mt-1">(${totalMachines} mesin tidak aktif)</p>
                </div>
            `;
                } else {
                    // Hitung Mesin ON (Unik) berdasarkan scheduleValues
                    // Cari jadwal pada tanggal tersebut
                    const dailySchedules = scheduleValues.filter(item => item.schedule_date === dbDate);

                    // Ambil nama mesin unik yang memiliki jadwal
                    const activeMachineNames = new Set(dailySchedules.map(item => item.mesin));

                    onMachines = activeMachineNames.size;
                    offMachines = totalMachines - onMachines;

                    // Pastikan tidak negatif (jika ada data sampah mesin yg tidak ada di master)
                    if (offMachines < 0) offMachines = 0;

                    const utilization = (onMachines / totalMachines) * 100;

                    summaryHTML += `
                <div class="flex-shrink-0 w-44 p-3 bg-blue-50 border border-blue-200 rounded-lg shadow-sm">
                    <p class="font-bold text-blue-800">${d.displayDate} (${d.weekday})</p>
                    <div class="mt-1 space-y-1">
                        <p class="text-sm text-green-700 font-semibold flex items-center">
                            <span class="inline-block w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                            ON: ${onMachines} Mesin
                        </p>
                        <p class="text-sm text-gray-600 font-semibold flex items-center">
                             <span class="inline-block w-3 h-3 bg-gray-400 rounded-full mr-2"></span>
                            OFF: ${offMachines} Mesin
                        </p>
                        <p class="text-xs text-blue-700 mt-1 pt-1 border-t border-blue-100">Utilisasi: ${utilization.toFixed(0)}%</p>
                    </div>
                </div>
            `;
                }

                // Kalkulasi Statistik Sesuai Request User (Unique Counts)
                const dailySchedulesForCodes = scheduleValues.filter(item => item.schedule_date === dbDate && item.product_code);

                // 1. Total Kode = Jumlah Kode Unik (Jika kode sama, hitung 1 kali)
                const uniqueCodesSet = new Set(dailySchedulesForCodes.map(item => item.product_code));
                const totalUniqueCodes = uniqueCodesSet.size;

                // 2. Jumlah Komponen = Jumlah Nama Komponen Unik
                // Pastikan menggunakan product_name. Jika kosong, fallback atau skip.
                const uniqueNamesSet = new Set(dailySchedulesForCodes.map(item => item.product_name).filter(n => n));
                const totalUniqueNames = uniqueNamesSet.size;

                // Simpan ke array statistik untuk grafik
                dailyStatsArray.push({
                    displayDate: d.displayDate,
                    dbDate: dbDate,
                    onSlots: onMachines,
                    offSlots: offMachines,
                    activeCodes: totalUniqueCodes, // Main Chart Line: Unique Codes
                    uniqueComponents: totalUniqueNames, // Tooltip: Unique Names
                    isHoliday: isHoliday
                });
            });



            let headerRowHTML = `
            <th class="py-3 px-3 border-b-2 border-r-2 border-gray-600 sticky left-0 top-0 bg-indigo-50 z-50 sticky-col-header text-center text-sm font-bold shadow-lg" style="min-width: 120px;">MESIN</th>
            <th class="py-3 px-3 border-b-2 border-r-2 border-gray-600 sticky left-[120px] top-0 bg-indigo-50 z-50 sticky-col-header text-center text-sm font-bold shadow-lg" style="min-width: 60px;">SHIFT</th>
        `;

            dates.forEach(d => {
                const classWeekend = d.isWeekend ? 'weekend-slot !bg-red-200 !text-red-800' : 'bg-indigo-100 text-indigo-800';
                headerRowHTML += `
            <th class="py-3 px-3 border-b-2 border-r-2 border-gray-600 text-center sticky top-0 z-40 ${classWeekend} text-sm uppercase font-bold"
                style="min-width: 100px;">
                ${d.displayDate} (${d.weekday})
            </th>
            `;
            });

            let tableHTML = `
            <thead class="sticky top-0 z-50">
                <tr class="bg-indigo-50 text-left text-xs font-semibold text-indigo-700 uppercase tracking-wider">
                    ${headerRowHTML}
                </tr>
            </thead>
            <tbody>
                `;

            validGroupedData.forEach(machine => {
                const machineName = machine.machineCode;
                const machineType = machine.type || '';

                const productListTooltip = machine.products.map(p => {
                    if (p && p.code && p.name) {
                        return `${p.code} - ${p.name}`;
                    }
                    return '';
                }).filter(text => text.length > 0).join('\n');

                shifts.forEach((shift, shiftIndex) => {
                    const isFirstRow = shiftIndex === 0;
                    const rowClass = (shiftIndex % 2 === 0) ? '' : 'bg-gray-50';

                    tableHTML += `
                <tr class="border-b-2 border-gray-600 hover:bg-gray-100 ${rowClass}">
                    ${isFirstRow ? `
                                <td class="py-1 px-3 border-r-2 border-gray-600 text-gray-800 font-bold align-middle text-center sticky-machine ${rowClass}"
                                    style="min-width: 120px; z-index: 30;" 
                                    rowspan="${shifts.length}">
                                    
                                    <div class="flex items-center justify-center space-x-1">
                                        <span>${machineName}</span>
                                        ${productListTooltip ? `
                                            <span title="${productListTooltip}" class="cursor-help">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500 hover:text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                            </span>
                                        ` : ''}
                                    </div>
                                    <span class="text-xs font-bold text-gray-500 block">${machineType}</span>
                                </td>
                            ` : ''}

                    <td class="py-1 px-3 border-r-2 border-gray-600 text-gray-700 align-middle text-center sticky-shift ${rowClass}"
                        style="min-width: 60px; z-index: 30;">
                        ${shift.split(' ')[1]}
                    </td>

                    ${dates.map(d => {
                        const classWeekend = d.isWeekend ? 'weekend-slot' : 'bg-white';
                        const key = `${machineName}|${d.dbDate}|${shift}`;
                        const scheduleItem = scheduleData[key] || null;
                        const scheduledCode = scheduleItem ? scheduleItem.product_code : null;
                        const scheduleId = scheduleItem ? scheduleItem.id : null;

                        const dragAttributes = `
                                    data-machine="${machineName}"
                                    data-date="${d.dbDate}"
                                    data-shift="${shift}"
                                    onclick="handleCellClick(event)"
                                    ondragover="allowDrop(event)"
                                    ondrop="handleDrop(event)"
                                    ondragenter="handleDragEnter(event)"
                                    ondragleave="handleDragLeave(event)"
                                `;

                        let textClass;
                        let slotContent;

                        if (scheduledCode) {
                            textClass = 'font-extrabold text-indigo-800';
                            const productName = scheduleItem.product_name || 'Nama?';
                            if (d.isWeekend) {
                                textClass = 'font-extrabold text-red-900';
                            }

                            // Lookup color
                            const pData = Object.values(productionData).find(p => p.code === scheduledCode && p.name === productName);
                            const pColor = pData && pData.color ? pData.color : 'Warna tidak tersedia';

                            const draggableAttr = isLoggedIn ? `draggable="true" ondragstart="handleDragStart(event, '${scheduleId}', '${scheduledCode}')"` : '';
                            const draggableClass = isLoggedIn ? 'draggable-item' : '';

                            slotContent = `
                                        <div class="flex flex-col items-center justify-center py-1 h-full w-full relative ${draggableClass}" ${draggableAttr}>
                                            
                                            <!-- Info Icon (Top Right) -->
                                            <div class="absolute top-0.5 right-0.5 z-20"> <!-- Positioned Top Right -->
                                                <div class="relative group flex items-center">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 text-gray-400 hover:text-indigo-500 cursor-help" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                    </svg>
                                                    
                                                    <!-- Tooltip (Positioned BELOW the icon to avoid Header overlap) -->
                                                    <div class="absolute top-full right-0 mt-1 hidden group-hover:block z-[60] w-max px-2 py-1 bg-gray-800 text-white text-[10px] rounded shadow-lg pointer-events-none">
                                                        ${pColor}
                                                        <!-- Arrow (Pointing Up) -->
                                                        <div class="absolute bottom-full right-1 border-4 border-transparent border-b-gray-800"></div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Code (Centered) -->
                                            <span class="text-sm ${textClass} leading-none mb-0.5 mt-1">${scheduledCode}</span>
                                            <span class="text-[11px] font-semibold text-gray-700 leading-tight text-center px-1 truncate w-full max-w-[110px]">${productName}</span> 
                                            ${isLoggedIn ? `
                                                <div class="flex justify-center items-center gap-3 mt-1.5 w-full">
                                                    <!-- Tombol Edit (Kiri) -->
                                                    <button onclick='event.stopPropagation(); startScheduleEdit(${JSON.stringify(scheduleItem)})' 
                                                            class="text-indigo-500 hover:text-indigo-700 p-0.5 rounded-full transition duration-100 ease-in-out" title="Edit Slot">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-5.605 5.605L7 12v3h3l3.586-3.586-2.828-2.828z" />
                                                        </svg>
                                                    </button>
                                                    
                                                    <!-- Tombol Duplicate (Tengah) -->
                                                    <button onclick='event.stopPropagation(); startDuplicate(${JSON.stringify(scheduleItem)})'
                                                            class="text-blue-500 hover:text-blue-700 p-0.5 rounded-full transition duration-100 ease-in-out" title="Duplicate Slot">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                                          <path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" />
                                                          <path d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2V5h8a2 2 0 00-2-2H5z" />
                                                        </svg>
                                                    </button>

                                                    <!-- Tombol Delete (Kanan) -->
                                                    ${(() => {
                                        const dateParts = d.dbDate.split('-');
                                        const displayDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
                                        return `
                                                        <button onclick="event.stopPropagation(); prepareScheduleDelete('${scheduleId}', '${scheduledCode}', '${displayDate}', '${shift}')"
                                                                class="text-red-500 hover:text-red-700 p-0.5 rounded-full transition duration-100 ease-in-out"
                                                                title="Hapus Slot">
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                                            </svg>
                                                        </button>
                                                        `;
                                    })()}
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                        }
                        else if (d.isWeekend) {
                            slotContent = 'LIBUR';
                            textClass = 'text-red-700 font-bold';
                        }
                        else {
                            if (isLoggedIn) {
                                slotContent = `
                                            <div class="group relative w-full h-full flex flex-col items-center justify-center">
                                                <span class="text-gray-300 group-hover:hidden text-[10px]">Kosong</span>
                                                <button onclick="event.stopPropagation(); openAddScheduleModal('${machineName}', '${d.dbDate}', '${shift}')" 
                                                        class="add-slot-btn hidden group-hover:flex bg-indigo-50 hover:bg-indigo-100 text-indigo-600 rounded-full w-8 h-8 items-center justify-center shadow-sm border border-indigo-200"
                                                        title="Tambah Jadwal">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                                                    </svg>
                                                </button>
                                            </div>
                                        `;
                                textClass = 'p-0 align-middle';
                            } else {
                                slotContent = 'Slot Kosong';
                                textClass = 'text-gray-400';
                            }
                        }

                        return `
                                    <td class="py-1 px-1 text-center border-r-2 border-gray-600 ${classWeekend} ${textClass} h-16" style="min-width: 100px;" ${dragAttributes}>
                                        ${slotContent}
                                    </td>
                                `;
                    }).join('')}
                </tr>
                `;
                });
            });

            tableHTML += `
            </tbody>
            </table>
            `;
            container.innerHTML = tableHTML;
            resultSection.classList.remove('hidden');
            placeholder.classList.add('hidden');

            summaryWrapper.innerHTML = summaryHTML;
            summaryContainer.classList.remove('hidden');

            const startOfWeekDisplay = new Intl.DateTimeFormat('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' }).format(startDate);
            const endOfWeekDisplay = new Intl.DateTimeFormat('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' }).format(endDate);
            document.getElementById('planningTableTitle').textContent = `Matriks Jadwal(Periode ${startOfWeekDisplay} - ${endOfWeekDisplay})`;

            window.latestDailyStats = dailyStatsArray;

            // AUTOMATICALLY Render Code/Component Chart
            if (typeof renderMachineChart === 'function') {
                renderMachineChart(dailyStatsArray);
            }
        }



        window.handlePlanningFormSubmit = function (event) {
            if (event) event.preventDefault(); // Handle event if present
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');

            let startDateStr = startDateInput.value.trim();
            let endDateStr = endDateInput.value.trim();

            if (startDateStr && !endDateStr) {
                const startDate = parseDMY(startDateStr);
                if (startDate) {
                    const endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    endDateStr = formatDateToDMY(endDate);
                    endDateInput.value = endDateStr;
                }
            }

            if (startDateStr && endDateStr) {
                renderPlanningTable(startDateStr, endDateStr);
            } else {
                showMessage('Mohon isi Tanggal Mulai dan Tanggal Akhir.', 'error');
            }
        };

        // --- NEW: Chart Rendering Logic ---


        // Updated: renderMachineChart now accepts pre-calculated daily stats
        window.renderMachineChart = function (dailyStats) {
            const ctx = document.getElementById('machineActivityChart').getContext('2d');
            const placeholder = document.getElementById('chartPlaceholder');

            if (!dailyStats || dailyStats.length === 0) return;

            // Prepare Data Array from Daily Stats
            const labels = dailyStats.map(stat => stat.displayDate.substring(0, 5)); // dd/mm
            const activeCodeCounts = dailyStats.map(stat => stat.activeCodes);

            if (planningChartInstance) {
                planningChartInstance.destroy();
            }

            placeholder.classList.add('hidden'); // Hide placeholder

            planningChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Kode Terjadwal',
                        data: activeCodeCounts,
                        backgroundColor: 'rgba(59, 130, 246, 0.2)', // Blue-500 opacity
                        borderColor: 'rgb(59, 130, 246)', // Blue-500
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4, // Smoother curve
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: 'rgb(59, 130, 246)',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#f3f4f6',
                                borderDash: [5, 5]
                            },
                            ticks: {
                                stepSize: 5, // Adjusted step size
                                precision: 0
                            },
                            title: {
                                display: true,
                                text: 'Total Kode'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false,
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#1f2937',
                            bodyColor: '#1e40af', // Darker blue text
                            borderColor: '#bfdbfe',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                title: function (context) {
                                    return `Tanggal: ${(dailyStats[context[0].dataIndex] || {}).displayDate || ''} `;
                                },
                                label: function (context) {
                                    const index = context.dataIndex;
                                    const stat = dailyStats[index];
                                    return [
                                        ` Total Kode: ${stat.activeCodes} `,
                                        ` Jumlah Komponen: ${stat.uniqueComponents} `
                                    ];
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index',
                    },
                }
            });
        }


        // --- NEW: Dynamic Input Row Functions WITH SHIFT SELECTION ---
        window.addInputRow = function () {
            const container = document.getElementById('inputRowsContainer');
            const rowId = 'input-row-' + Date.now();

            const tr = document.createElement('tr');
            tr.id = rowId;
            tr.className = 'product-input-row hover:bg-gray-50 transition duration-150';

            const isFirstRow = container.children.length === 0;
            const deleteVisibility = isFirstRow ? 'invisible' : '';

            tr.innerHTML = `
            <td class="py-2 px-4">
                <div class="relative">
                    <input type="text" class="product-code-input w-full p-2 pl-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-800 text-sm shadow-sm uppercase-input font-mono font-medium" placeholder="Kode Barang..." list="productCodeList" oninput="this.value = this.value.toUpperCase()">
                </div>
                </td>
                <td class="py-2 px-4">
                    <input type="number" class="order-qty-input w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm text-sm" placeholder="0" min="1">
                </td>
                <td class="py-2 px-4">
                    <div class="relative group">
                        <select class="start-shift-input w-full p-2.5 bg-white border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 block shadow-sm transition duration-200 ease-in-out cursor-pointer hover:border-indigo-300">
                            <option value="auto" class="font-medium text-gray-500"> Otomatis</option>
                            <option value="Shift 1" class="font-medium text-indigo-600"> Shift 1 (Pagi)</option>
                            <option value="Shift 2" class="font-medium text-indigo-600"> Shift 2 (Siang)</option>
                            <option value="Shift 3" class="font-medium text-indigo-600"> Shift 3 (Malam)</option>
                        </select>
                    </div>
                </td>
                <td class="py-2 px-4 text-center">
                    <button onclick="removeInputRow('${rowId}')" class="text-gray-400 hover:text-red-500 p-2 rounded-full transition duration-150 ${deleteVisibility}" title="Hapus Baris">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </td>
        `;

            container.appendChild(tr);
            updateDeleteButtonsVisibility();
        }

        window.removeInputRow = function (rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
                updateDeleteButtonsVisibility();
            }
        }

        // --- FUNGSI UNTUK MENUTUP HASIL ESTIMASI ---
        window.closeEstimationResults = function () {
            document.getElementById('results').classList.add('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- UPDATE: calculateEstimation to Capture Start Shift Preference ---
        window.calculateEstimation = function () {
            const container = document.getElementById('inputRowsContainer');
            const rows = container.querySelectorAll('.product-input-row');

            const componentSelectionPanel = document.getElementById('componentSelectionContainer');
            componentSelectionPanel.classList.add('hidden');
            document.getElementById('componentSelectionList').innerHTML = '';

            const estimationMachineTracker = {};
            let longestShiftNet = 0;
            let combinedDetailsHTML = '';
            const decimalFormatter = new Intl.NumberFormat('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const integerFormatter = new Intl.NumberFormat('id-ID', { maximumFractionDigits: 0 });

            pendingScheduleComponents = [];
            let hasError = false;
            let anyProductFound = false;

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const codeInput = row.querySelector('.product-code-input');
                const qtyInput = row.querySelector('.order-qty-input');
                const startShiftInput = row.querySelector('.start-shift-input'); // Get select element

                const code = codeInput.value.trim();
                const orderQtyDus = cleanInt(qtyInput.value);
                const startShiftPref = startShiftInput ? startShiftInput.value : 'auto'; // Capture Value

                if (!code) continue;

                if (orderQtyDus <= 0) {
                    showMessage(`Baris ke - ${i + 1}: Jumlah Pesanan harus valid(angka positif).`, "error");
                    hasError = true;
                    continue;
                }

                const matchingProducts = Object.values(productionData).filter(data => data.code === code);

                if (matchingProducts.length === 0) {
                    showMessage(`Baris ke - ${i + 1}: Kode Produk "${code}" tidak ditemukan.`, "error");
                    hasError = true;
                    continue;
                }

                anyProductFound = true;

                // --- Display Logic for Shift Preference in Estimation Detail ---
                let shiftPrefLabel = `<span class="text-gray-500 font-normal ml-2 text-xs"> (Mulai: Otomatis)</span>`;
                if (startShiftPref !== 'auto') {
                    shiftPrefLabel = `<span class="text-indigo-600 font-bold ml-2 text-xs"> (Mulai: ${startShiftPref})</span>`;
                }

                combinedDetailsHTML += `
            <div class="mb-4 bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
            <div class="bg-indigo-50 px-4 py-2 border-b border-indigo-100 flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <span class="bg-indigo-600 text-white font-bold py-0.5 px-2 rounded text-[10px] uppercase tracking-wider">Input #${i + 1}</span>
                    <span class="font-bold text-gray-800 text-sm">Kode: ${code}</span>
                    <span class="text-gray-500 text-xs">(${integerFormatter.format(orderQtyDus)} Dus)</span>
                </div>
                ${shiftPrefLabel}
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full text-xs table-fixed">
                    <thead class="bg-gray-50 text-gray-500 font-semibold uppercase tracking-wider border-b border-gray-100">
                        <tr>
                            <th class="py-2 px-3 text-left w-[20%]">Komponen</th>
                            <th class="py-2 px-3 text-left w-[8%]">Mesin</th>
                            <th class="py-2 px-3 text-left w-[22%]">Warna</th>
                            <th class="py-2 px-3 text-right w-[8%]">Isi Dus</th>
                            <th class="py-2 px-3 text-right w-[10%]">Total Pcs</th>
                            <th class="py-2 px-3 text-right w-[10%]">Target/Shift</th>
                            <th class="py-2 px-3 text-right w-[14%]">Waktu (Jam)</th>
                            <th class="py-2 px-3 text-right bg-blue-50 text-blue-700 w-[8%]">Shift Butuh</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
        `;

                matchingProducts.forEach((product, index) => {
                    const pcsPerBox = product.pcs_per_box;
                    const totalPcsOrdered = orderQtyDus * pcsPerBox;
                    const targetPerShiftPcs = product.targetPerShift;

                    const shiftNet = totalPcsOrdered / targetPerShiftPcs;
                    const hoursNet = shiftNet * HOURS_PER_SHIFT;

                    const machine = product.machine;
                    const lastBusyShiftNet = estimationMachineTracker[machine] || 0;

                    estimationMachineTracker[machine] = lastBusyShiftNet + shiftNet;

                    const formattedHoursMinutes = formatHoursMinutes(hoursNet);
                    const colorDisplay = product.color || '-';

                    pendingScheduleComponents.push({
                        productCode: product.code,
                        productName: product.name,
                        machine: product.machine,
                        machine_optional: product.machine_optional,
                        shiftNet: shiftNet,
                        orderQty: orderQtyDus,
                        startShiftPreference: startShiftPref, // Store Preference in Object
                        color: colorDisplay // Store Color
                    });

                    combinedDetailsHTML += `
            <tr class="hover:bg-gray-50 transition duration-150 group">
                <td class="py-2 px-3 text-gray-800 font-medium">${product.name}</td>
                <td class="py-2 px-3 text-gray-500 font-mono text-[11px] group-hover:text-indigo-600 transition-colors">${machine}</td>
                <td class="py-2 px-3 text-gray-600 truncate max-w-[150px]" title="${colorDisplay}">${colorDisplay}</td>
                <td class="py-2 px-3 text-right text-gray-600">${pcsPerBox}</td>
                <td class="py-2 px-3 text-right font-bold text-gray-800">${integerFormatter.format(totalPcsOrdered)}</td>
                <td class="py-2 px-3 text-right text-gray-600 font-mono">${integerFormatter.format(targetPerShiftPcs)}</td>
                <td class="py-2 px-3 text-right text-red-600 font-medium whitespace-nowrap">${formattedHoursMinutes}</td>
                <td class="py-2 px-3 text-right font-bold text-blue-700 bg-blue-50/50 group-hover:bg-blue-100 transition-colors">${decimalFormatter.format(shiftNet)}</td>
            </tr>
            `;
                });

                combinedDetailsHTML += `
                            </tbody>
                        </table>
                    </div>
                </div >
            `;
            }

            if (hasError || !anyProductFound) {
                if (!anyProductFound && !hasError) showMessage("Mohon masukkan minimal satu produk yang valid.", "error");
                document.getElementById('results').classList.add('hidden');
                document.getElementById('autoSchedulePanel').classList.add('hidden');
                return;
            }

            let busiestMachineCode = '-';

            for (const machine in estimationMachineTracker) {
                if (estimationMachineTracker[machine] > longestShiftNet) {
                    longestShiftNet = estimationMachineTracker[machine];
                    busiestMachineCode = machine;
                }
            }

            const totalShiftsBooked = Math.ceil(longestShiftNet);
            const totalHoursNet = longestShiftNet * HOURS_PER_SHIFT;
            const totalHoursBooked = Math.round(totalHoursNet);
            const totalDaysCalculated = totalShiftsBooked / SHIFTS_PER_DAY;
            const totalDaysBooked = Math.ceil(totalDaysCalculated);

            // Calculate Grand Total PCS
            const grandTotalPcs = pendingScheduleComponents.reduce((sum, item) => {
                // We need to re-calculate per item or store it. 
                // Since pendingScheduleComponents stores orderQty, we need pcsPerBox. 
                // Let's grab it from productionData.
                const product = Object.values(productionData).find(p => p.code === item.productCode);
                return sum + (item.orderQty * (product ? product.pcs_per_box : 0));
            }, 0);



            const pdfButton = document.getElementById('exportPdfButton');
            if (isLoggedIn) {
                pdfButton.classList.remove('hidden');
            } else {
                pdfButton.classList.add('hidden');
            }

            document.getElementById('resultHours').textContent = `${integerFormatter.format(totalHoursBooked)} Jam`;
            document.getElementById('resultShifts').textContent = `${totalShiftsBooked} Shift`;
            document.getElementById('resultDays').textContent = `${totalDaysBooked} Hari`;

            const simplifiedFinalSummaryHTML = `
            <div class="bg-green-50 p-5 rounded-xl border border-green-200 mb-6 font-sans">
                    <h3 class="text-sm font-bold text-green-900 mb-5 flex items-center uppercase tracking-wider">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Ringkasan Estimasi Total
                    </h3>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                        <!-- Stat 1: Volume Produksi -->
                        <div class="flex flex-col border-r border-green-200 last:border-0 pr-4">
                            <span class="text-[11px] font-bold text-green-600 uppercase tracking-wide mb-1">Total Volume</span>
                            <div class="flex items-center">
                                <span class="bg-green-200 text-green-800 p-1.5 rounded mr-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                                    </svg>
                                </span>
                                <div>
                                    <span class="text-xl font-extrabold text-gray-800 block leading-none">${integerFormatter.format(grandTotalPcs)}</span>
                                    <span class="text-xs text-gray-500 font-medium">Pcs (${pendingScheduleComponents.length} Item)</span>
                                </div>
                            </div>
                        </div>

                        <!-- Stat 2: Mesin Tersibuk -->
                        <div class="flex flex-col border-r border-green-200 last:border-0 px-2">
                            <span class="text-[11px] font-bold text-green-600 uppercase tracking-wide mb-1">Mesin Bottleneck</span>
                            <div class="flex items-center">
                                <span class="bg-red-100 text-red-700 p-1.5 rounded mr-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                                    </svg>
                                </span>
                                <div>
                                    <span class="text-xl font-extrabold text-gray-800 block leading-none">${busiestMachineCode}</span>
                                    <span class="text-xs text-gray-500 font-medium">Load Tertinggi</span>
                                </div>
                            </div>
                        </div>

                        <!-- Stat 3: Beban Shift -->
                        <div class="flex flex-col border-r border-green-200 last:border-0 px-2">
                            <span class="text-[11px] font-bold text-green-600 uppercase tracking-wide mb-1">Waktu Kritis</span>
                            <div class="flex items-center">
                                <span class="bg-blue-100 text-blue-700 p-1.5 rounded mr-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </span>
                                <div>
                                    <span class="text-xl font-extrabold text-gray-800 block leading-none">${decimalFormatter.format(longestShiftNet)}</span>
                                    <span class="text-xs text-gray-500 font-medium">Shift Dibutuhkan</span>
                                </div>
                            </div>
                        </div>

                         <!-- Stat 4: Durasi -->
                        <div class="flex flex-col pl-4">
                            <span class="text-[11px] font-bold text-green-600 uppercase tracking-wide mb-1">Estimasi Selesai</span>
                            <div class="flex items-center">
                                <span class="bg-purple-100 text-purple-700 p-1.5 rounded mr-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                </span>
                                <div>
                                    <span class="text-xl font-extrabold text-gray-800 block leading-none">${totalDaysBooked}</span>
                                    <span class="text-xs text-gray-500 font-medium">Hari Kerja (3 Shift)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div >
            `;

            document.getElementById('estimationDetails').innerHTML = simplifiedFinalSummaryHTML + combinedDetailsHTML;
            document.getElementById('results').classList.remove('hidden');

            renderComponentSelectionList(pendingScheduleComponents);

            showMessage(`Estimasi berhasil dihitung untuk ${pendingScheduleComponents.length} komponen!`, "info");

            const autoSchedulePanel = document.getElementById('autoSchedulePanel');
            if (isLoggedIn) {
                autoSchedulePanel.classList.remove('hidden');
                document.getElementById('autoScheduleStatus').classList.add('hidden');
                document.getElementById('autoScheduleStartDate').focus();
            } else {
                autoSchedulePanel.classList.add('hidden');
                componentSelectionPanel.classList.add('hidden');
            }
        }

        // --- UPDATE: Algorithm to Respect Start Shift Preference ---
        // --- FUNGSI BANTUAN KATEGORI WARNA ---
        function getColorCategory(colorName) {
            if (!colorName) return 'UNKNOWN';
            const c = colorName.toLowerCase().trim();
            if (['abu', 'grey', 'silver'].some(x => c.includes(x))) return 'TYPE_1';
            if (['hitam', 'black', 'dark'].some(x => c.includes(x))) return 'TYPE_2';
            if (['bening', 'clear', 'transparan'].some(x => c.includes(x))) return 'TYPE_3';
            // Tipe 4: Update per Request User (tambah 'putih natural')
            if (['putih', 'white', 'natural', 'ivory', 'putih natural'].some(x => c.includes(x))) return 'TYPE_4';
            return 'TYPE_5';
        }

        async function autoScheduleProduction_Simple(startDate, components) {

            const proposedSlots = [];
            // Copy existing schedule for simulation
            const tempSchedule = { ...scheduleData };

            let totalComponents = components.length;
            let scheduledCount = 0;
            let latestEndDate = new Date(startDate);

            const date60DaysLater = new Date(startDate);
            date60DaysLater.setDate(date60DaysLater.getDate() + 60);

            const date60DaysLaterStr = formatDateToDMY(date60DaysLater);
            const startDateStr = formatDateToDMY(startDate);

            // Fetch latest data
            await fetchScheduleData(startDateStr, date60DaysLaterStr);
            Object.assign(tempSchedule, scheduleData);

            // Helper: Check Color Compatibility
            const checkColorCompatibility = (machine, dateYMD, shiftNum, myColor) => {
                let prevDate = new Date(parseDMY(formatDateToDMY(new Date(dateYMD))));
                let prevShiftNum = 0;

                if (shiftNum === 1) {
                    prevShiftNum = 3;
                    prevDate.setDate(prevDate.getDate() - 1);
                } else {
                    prevShiftNum = shiftNum - 1;
                }

                const prevDateYMD = formatDateToYMD(prevDate);
                const prevKey = `${machine}|${prevDateYMD}|Shift ${prevShiftNum}`;
                const prevItem = tempSchedule[prevKey];

                // Rule: If Empty -> OK
                if (!prevItem) return true;

                // If Occupied -> Check Color
                const prevColor = prevItem.color || (prevItem.product_code ? (Object.values(productionData).find(p => p.code === prevItem.product_code && p.name === prevItem.product_name)?.color) : null);

                const catPrev = getColorCategory(prevColor);
                const catCurr = getColorCategory(myColor);

                return catPrev === catCurr;
            };

            // Helper: Try to find slots on a machine
            const tryScheduleOnMachine = (machine, shiftNeeded, component, useColorConstraint) => {
                const foundSlots = [];
                let slotsFoundCount = 0;
                let currentWorkingDate = new Date(startDate);
                let hasStartedFilling = false;

                for (let i = 0; i < 60; i++) {
                    if (slotsFoundCount >= shiftNeeded) break;

                    const isWeekend = currentWorkingDate.getDay() === 0 || currentWorkingDate.getDay() === 6;
                    if (isWeekend) {
                        currentWorkingDate.setDate(currentWorkingDate.getDate() + 1);
                        continue;
                    }

                    const dbDate = formatDateToYMD(currentWorkingDate);

                    for (let s = 1; s <= 3; s++) {
                        if (slotsFoundCount >= shiftNeeded) break;

                        const shiftName = `Shift ${s}`;
                        const key = `${machine}|${dbDate}|${shiftName}`;

                        // 1. Shift Preference Check (Start only)
                        if (!hasStartedFilling && component.startShiftPreference !== 'auto') {
                            if (shiftName !== component.startShiftPreference) continue;
                        }

                        // 2. Occupancy Check
                        if (tempSchedule[key]) continue;

                        // 3. Color Constraint Check
                        if (useColorConstraint) {
                            if (!checkColorCompatibility(machine, dbDate, s, component.color)) {
                                continue;
                            }
                        }

                        foundSlots.push({
                            machine: machine,
                            shift: shiftName,
                            dbDate: dbDate,
                            productCode: component.productCode,
                            productName: component.productName,
                            orderQty: component.orderQty,
                            color: component.color
                        });

                        slotsFoundCount++;
                        hasStartedFilling = true;
                    }
                    currentWorkingDate.setDate(currentWorkingDate.getDate() + 1);
                }

                return (slotsFoundCount >= shiftNeeded) ? foundSlots : null;
            };


            for (const component of components) {
                const totalShiftNeeded = Math.ceil(component.shiftNet);

                const machinesToCheck = [];
                if (component.machine) machinesToCheck.push(component.machine.trim().toUpperCase());
                if (component.machine_optional) {
                    component.machine_optional.split(',')
                        .map(m => m.trim().toUpperCase())
                        .filter(m => m && !machinesToCheck.includes(m))
                        .forEach(m => machinesToCheck.push(m));
                }

                if (machinesToCheck.length === 0) {
                    console.warn(`Skip ${component.productCode}: No machine.`);
                    continue;
                }

                let bestSlots = null;
                const mainMachine = machinesToCheck[0];
                const optionalMachines = machinesToCheck.slice(1);

                // STEP 1: Probe Main Machine Capacity (Ignore Color for now)
                // FORCE 'auto' preference for this probe to ensure we find the TRUE physical next slot (Gapless).
                // If we don't do this, a user preference like "Start Shift 1" will force a gap over Shift 2 and 3.
                const componentForProbe = { ...component, startShiftPreference: 'auto' };
                const mainSlotsPhysical = tryScheduleOnMachine(mainMachine, totalShiftNeeded, componentForProbe, false);

                // Helper: Comparable Timestamp for Sorting Candidates
                const getTimestamp = (s) => {
                    const d = new Date(parseDMY(formatDateToDMY(new Date(s.dbDate))));
                    // Gunakan multiplier kecil untuk shift agar urutan waktu presisi (Shift 1 < Shift 2)
                    const sh = parseInt(s.shift.replace(/\D/g, ''));
                    return d.getTime() + (sh * 0.1);
                };

                if (mainSlotsPhysical) {
                    // CASE 1: Mesin Utama Punya Kapasitas (Slot Kosong)
                    const firstSlot = mainSlotsPhysical[0];
                    const shiftNum = parseInt(firstSlot.shift.replace(/\D/g, ''));
                    const isMainColorCompatible = checkColorCompatibility(mainMachine, firstSlot.dbDate, shiftNum, component.color);

                    if (isMainColorCompatible) {
                        // A. Mesin Utama COCOK Warna -> Prioritas Tertinggi
                        bestSlots = tryScheduleOnMachine(mainMachine, totalShiftNeeded, component, true);
                        if (!bestSlots) bestSlots = mainSlotsPhysical;
                    } else {
                        // B. Mesin Utama TIDAK COCOK Warna -> Cek SEMUA Mesin Optional
                        // Cari yang (1) Cocok Warna DAN (2) Waktu Paling Cepat (Earliest)

                        let bestOptCandidate = null;
                        let bestOptTime = Infinity;

                        const mainStartTime = getTimestamp(mainSlotsPhysical[0]);

                        for (const opt of optionalMachines) {
                            const optSlots = tryScheduleOnMachine(opt, totalShiftNeeded, component, true);

                            if (optSlots) {
                                const optStartTime = getTimestamp(optSlots[0]);

                                // Cek Gap: Optional tidak boleh lebih lambat dari Main (meski main salah warna)
                                if (optStartTime > mainStartTime) {
                                    continue;
                                }

                                // Cari yang paling awal (Earliest)
                                if (optStartTime < bestOptTime) {
                                    bestOptTime = optStartTime;
                                    bestOptCandidate = optSlots;
                                }
                            }
                        }

                        if (bestOptCandidate) {
                            bestSlots = bestOptCandidate;
                        } else {
                            // C. Force Main (Jika tidak ada Optional yang cocok & aman secara waktu)
                            console.log(`[Auto Force] Main & Optional mismatch/slower. Forcing Main: ${mainMachine}`);
                            bestSlots = mainSlotsPhysical;
                        }
                    }

                } else {
                    // CASE: Mesin Utama PENUH -> Cari di Optional (Earliest & Color Compatible)

                    let bestOptCandidate = null;
                    let bestOptTime = Infinity;

                    // Priority A: Optional with Correct Color
                    for (const opt of optionalMachines) {
                        const optSlots = tryScheduleOnMachine(opt, totalShiftNeeded, component, true);
                        if (optSlots) {
                            const optStartTime = getTimestamp(optSlots[0]);
                            if (optStartTime < bestOptTime) {
                                bestOptTime = optStartTime;
                                bestOptCandidate = optSlots;
                            }
                        }
                    }

                    if (bestOptCandidate) {
                        bestSlots = bestOptCandidate;
                    } else {
                        // Priority B: Optional with Any Color (Force) - Find Earliest
                        bestOptTime = Infinity;
                        for (const opt of optionalMachines) {
                            const optSlots = tryScheduleOnMachine(opt, totalShiftNeeded, component, false);
                            if (optSlots) {
                                const optStartTime = getTimestamp(optSlots[0]);
                                if (optStartTime < bestOptTime) {
                                    bestOptTime = optStartTime;
                                    bestOptCandidate = optSlots;
                                }
                            }
                        }
                        if (bestOptCandidate) bestSlots = bestOptCandidate;
                    }
                }

                if (bestSlots) {
                    scheduledCount++;
                    bestSlots.forEach(slot => {
                        proposedSlots.push(slot);
                        // Update simulated schedule
                        const key = `${slot.machine}|${slot.dbDate}|${slot.shift}`;
                        tempSchedule[key] = {
                            id: 'simulated-' + Math.random(),
                            mesin: slot.machine,
                            schedule_date: slot.dbDate,
                            schedule_shift: slot.shift,
                            product_code: slot.productCode,
                            color: slot.color
                        };

                        const d = new Date(parseDMY(formatDateToDMY(new Date(slot.dbDate))));
                        if (d > latestEndDate) latestEndDate = d;
                    });
                }
            }

            const finalEndDateDisplay = formatDateToDMY(latestEndDate);

            return {
                proposedSlots: proposedSlots,
                totalComponents: totalComponents,
                scheduledCount: scheduledCount,
                endDateDisplay: finalEndDateDisplay,
            };
        }

        // --- end of listenForProductionData and processSupabaseData which are now handled above ---

        function processSupabaseData(data) {
            const newProductionData = {};
            if (data) {
                data.forEach(item => {
                    newProductionData[item.id] = {
                        ...item,
                        id: item.id,
                        pcs_per_box: cleanInt(item.pcs_per_box),
                        targetPerShift: cleanInt(item.targetPerShift),
                        machine_optional: item.machine_optional || null,
                        color: item.color || null,
                    };
                });
            }
            productionData = newProductionData;
            populateProductDatalist();
            populateMachineDropdowns();
            renderRateTable();
        }

        async function saveProductionData(event) {
            event.preventDefault();

            if (!isLoggedIn) {
                showMessage("Akses ditolak. Silakan Login sebagai Admin untuk menyimpan data.", "error");
                return;
            }

            const currentId = document.getElementById('inputId').value;
            const code = document.getElementById('inputCode').value.trim();
            const name = document.getElementById('inputName').value.trim() || 'Tidak Diketahui';
            const color = document.getElementById('inputColor').value.trim() || null;
            const machine = document.getElementById('inputMachine').value.trim() || 'Tidak Diketahui';
            const machineOptional = document.getElementById('inputMachineOptional').value.trim() || null;

            const pcsPerBox = cleanInt(document.getElementById('inputPcsPerBox').value);
            const targetPerShift = cleanInt(document.getElementById('inputTargetPerShift').value);

            if (!code || pcsPerBox <= 0 || targetPerShift <= 0) {
                showMessage("Kode Barang, Isi Dus, dan Target per Shift wajib diisi dan harus berupa angka positif (di atas 0).", "error");
                return;
            }

            const isoTimestampString = new Date().toISOString();

            const dataToSave = {
                code: code,
                name: name,
                color: color,
                machine: machine,
                machine_optional: machineOptional,
                pcs_per_box: pcsPerBox,
                targetPerShift: targetPerShift,
                timestamp: isoTimestampString
            };

            try {
                let response;

                if (currentId) {
                    response = await supabase
                        .from(TABLE_NAME)
                        .update(dataToSave)
                        .eq('id', currentId)
                        .select();

                    if (response.error) throw response.error;
                    showMessage(`Data untuk Kode Barang ${code} berhasil diperbarui!`, "info");

                } else {
                    response = await supabase
                        .from(TABLE_NAME)
                        .insert([dataToSave])
                        .select();

                    if (response.error) throw response.error;
                    showMessage(`Data untuk Kode Barang ${code} berhasil disimpan!`, "info");
                }

                cancelEdit();
                toggleProductionModal(false); // Close Modal on Success
            } catch (e) {
                console.error("Error saving/updating data to Supabase: ", e);
                let errorMessage = `Gagal menyimpan / memperbarui data.Error: ${e.message} `;
                if (e.code && (e.code === '401' || e.code === '403')) {
                    errorMessage = "Gagal menyimpan. Cek pengaturan RLS (Row Level Security) di Supabase untuk operasi INSERT/UPDATE.";
                } else if (e.message && e.message.includes("column \"machine_optional\" does not exist")) {
                    errorMessage = "Gagal menyimpan: Kolom 'machine_optional' tidak ditemukan di Supabase. Mohon tambahkan kolom tersebut (tipe: text).";
                }
                showMessage(errorMessage, "error");
            }
        }

        window.confirmDelete = async function () {
            const idToDelete = document.getElementById('deleteIdConfirm').value;
            toggleDeleteModal(false);

            if (idToDelete) {
                try {
                    const { error } = await supabase
                        .from(TABLE_NAME)
                        .delete()
                        .eq('id', idToDelete);

                    if (error) throw error;

                    showMessage(`Data Kode Barang ${productionData[idToDelete].code} berhasil dihapus.`, "info");
                    cancelEdit();
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    let errorMessage = `Gagal menghapus data.Error: ${e.message} `;
                    if (e.code && (e.code === '401' || e.code === '403')) {
                        errorMessage = "Gagal menghapus. Cek pengaturan RLS (Row Level Security) di Supabase untuk operasi DELETE.";
                    }
                    showMessage(errorMessage, "error");
                }
            }
        }

        window.prepareDelete = function (id) {
            if (!isLoggedIn) {
                showMessage("Anda harus Login Admin untuk menghapus data.", "error");
                return;
            }
            const data = productionData[id];
            if (!data) return;

            document.getElementById('deleteCodeDisplay').textContent = `${data.code} (${data.name})`;
            document.getElementById('deleteIdConfirm').value = id;
            toggleDeleteModal(true);
        }

        window.toggleDeleteModal = function (show) {
            document.getElementById('deleteModal').classList.toggle('hidden', !show);
        }

        window.startEditData = function (id) {
            if (!isLoggedIn) {
                showMessage("Anda harus Login Admin untuk mengedit data.", "error");
                return;
            }
            const data = productionData[id];
            if (!data) return;

            document.getElementById('inputId').value = id;
            document.getElementById('inputCode').value = data.code;
            document.getElementById('inputName').value = data.name;
            document.getElementById('inputColor').value = data.color || '';
            document.getElementById('inputMachine').value = data.machine;
            document.getElementById('inputMachineOptional').value = data.machine_optional || '';

            document.getElementById('inputPcsPerBox').value = data.pcs_per_box.toLocaleString('id-ID');
            document.getElementById('inputTargetPerShift').value = data.targetPerShift.toLocaleString('id-ID');

            document.getElementById('inputTargetPerShift').dispatchEvent(new Event('input'));

            document.getElementById('submitButton').innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-3m-1-4l-3 3m0 0l-3 3m3-3V4" />
            </svg>
            Perbarui Data (${data.code})
                `;
            document.getElementById('submitButton').classList.remove('bg-indigo-600', 'bg-cyan-600');
            document.getElementById('submitButton').classList.add('bg-green-600', 'hover:bg-green-700');
            document.getElementById('cancelEditButton').classList.remove('hidden');

            // Force Buka Tab Estimasi (jika belum) dan Buka Modal
            // showView('estimation'); // Removed to prevent jumping
            toggleProductionModal(true);
        }

        window.cancelEdit = function () {
            document.getElementById('productionDataForm').reset();
            document.getElementById('inputId').value = '';

            document.getElementById('submitButton').innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-3m-1-4l-3 3m0 0l-3 3m3-3V4" />
                </svg>
            Simpan Data
            `;
            document.getElementById('submitButton').classList.remove('bg-green-600', 'hover:bg-green-700');
            document.getElementById('submitButton').classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            document.getElementById('cancelEditButton').classList.add('hidden');
            document.getElementById('capacity3Shift').value = 'Otomatis Terisi';
        }

        window.toggleDetails = function () {
            const detailsDiv = document.getElementById('estimationDetails');
            const button = document.getElementById('toggleDetailsButton');
            const icon = document.getElementById('toggleIcon');

            if (detailsDiv.classList.contains('hidden')) {
                detailsDiv.classList.remove('hidden');
                button.textContent = 'Sembunyikan Detail Perhitungan';
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7-7" />';
                button.prepend(icon);
            } else {
                detailsDiv.classList.add('hidden');
                button.textContent = 'Lihat Detail Perhitungan';
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />';
                button.prepend(icon);
            }
        }

        // --- Improved Initialization Logic ---

        // Helper untuk mencoba fetch ulang jika gagal
        async function fetchWithRetry(fn, retries = 3, delay = 1000) {
            try {
                return await fn();
            } catch (err) {
                if (retries <= 0) throw err;
                await new Promise(res => setTimeout(res, delay));
                return fetchWithRetry(fn, retries - 1, delay * 1.5); // Exponential backoff
            }
        }

        window.onload = async function () {
            // 1. Inisialisasi UI dasar segera agar tombol & input muncul
            try {
                await setupApp();
            } catch (e) {
                console.error("Gagal menjalankan setupApp:", e);
            }

            try {
                if (!window.supabase) {
                    throw new Error("SDK Supabase tidak dimuat. Cek koneksi internet anda.");
                }
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                if (localStorage.getItem('isAdminLoggedIn') === 'true') {
                    isLoggedIn = true;
                    updateAdminUI();
                }

                // 2. Cek koneksi & Ambil Data secara asinkron (Background)
                fetchWithRetry(async () => {
                    const { error } = await supabase.from(TABLE_NAME).select('id').limit(1);
                    if (error) throw error;

                    // Ambil data awal
                    await listenForProductionData();
                    await fetchAllScheduleData();

                }).then(() => {
                    console.log("Supabase Ready.");
                }).catch(error => {
                    console.error("Kesalahan Supabase:", error);
                    let errorMessage = error.message && error.message.includes("Failed to fetch")
                        ? "Gagal terhubung ke Supabase (Network/Paused)."
                        : `Koneksi Bermasalah: ${error.message}`;
                    showMessage(errorMessage, "error");
                });

            } catch (error) {
                console.error("Fatal Error during onload:", error);
                showMessage("Isu Inisialisasi: " + error.message, "error");
            }

            // Tampilkan view awal
            showView('estimation');
        }

        function showMessage(message, type = 'info') {
            const box = document.getElementById('messageBox');
            if (!box) {
                console.error("Message box element not found. Message:", message);
                return;
            }
            box.textContent = message;
            box.className = `fixed top-4 left-1/2 transform -translate-x-1/2 p-3 rounded-lg shadow-xl transition-opacity duration-300 z-[100] ${type === 'error' ? 'bg-red-600' : 'bg-green-600'
                } text-white`;
            box.classList.remove('hidden');
            setTimeout(() => {
                box.classList.add('hidden');
            }, 5000);
        }

        async function setupApp() {
            // INI PENTING: Jalankan inisialisasi UI Tanpa Menunggu Database
            setupCapacityListener();
            addInputRow(); // Tambahkan baris pertama segera agar UI tidak blank

            const prodForm = document.getElementById('productionDataForm');
            if (prodForm) {
                prodForm.addEventListener('submit', saveProductionData);
            }

            const planningForm = document.getElementById('planningForm');
            if (planningForm) {
                planningForm.addEventListener('submit', handlePlanningFormSubmit);
            }

            const masterSearch = document.getElementById('masterSearchInput');
            if (masterSearch) {
                masterSearch.addEventListener('input', () => {
                    const query = masterSearch.value.toLowerCase();
                    renderRateTable(query);
                });
            }

            const summaryWrapper = document.getElementById('dailySummaryWrapper');
            const tableWrapper = document.getElementById('planningTableWrapper');

            if (summaryWrapper && tableWrapper) {
                tableWrapper.addEventListener('scroll', () => {
                    if (isSyncingScroll) {
                        isSyncingScroll = false;
                        return;
                    }
                    isSyncingScroll = true;
                    summaryWrapper.scrollLeft = tableWrapper.scrollLeft;
                });

                summaryWrapper.addEventListener('scroll', () => {
                    if (isSyncingScroll) {
                        isSyncingScroll = false;
                        return;
                    }
                    isSyncingScroll = true;
                    tableWrapper.scrollLeft = summaryWrapper.scrollLeft;
                });
            }

            updateAutoScheduleButton();
        }

        async function listenForProductionData() {
            if (!supabase) return;

            try {
                // Gunakan await untuk memastikan data didapat sebelum lanjut
                const { data, error } = await supabase.from(TABLE_NAME).select('*');

                if (error) throw error;

                processSupabaseData(data);

                // Setup realtime subscription
                supabase.channel('public:production_rates')
                    .on('postgres_changes', { event: '*', schema: 'public', table: TABLE_NAME }, (payload) => {
                        supabase.from(TABLE_NAME).select('*').then(({ data: newData }) => {
                            processSupabaseData(newData);
                        });
                    })
                    .subscribe();

            } catch (err) {
                console.error("Supabase connection error in listenForProductionData:", err);
                throw err; // Lempar error ke atas agar ditangkap window.onload
            }
        }

        function updateAutoScheduleButton() {
            const button = document.getElementById('autoScheduleButton');
            if (isLoggedIn) {
                button.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                    </svg>
            Jadwalkan Otomatis
                `;
            } else {
                button.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zM4 8a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1z" clip-rule="evenodd" />
                    </svg>
            Lihat Jadwal 7 - Hari
                `;
            }
        }

        function updateAdminUI() {
            const loginButton = document.getElementById('adminLoginButton');
            const loginButtonDesktop = document.getElementById('adminLoginButtonDesktop');

            if (isLoggedIn) {
                loginButton.textContent = 'Logout';
                loginButtonDesktop.textContent = 'Logout';
                loginButton.onclick = prepareLogout;
                loginButtonDesktop.onclick = prepareLogout;
                loginButton.classList.remove('bg-indigo-50', 'hover:bg-indigo-100', 'text-indigo-700', 'border-indigo-200');
                loginButton.classList.add('bg-red-50', 'hover:bg-red-100', 'text-red-700', 'border-red-200');
                loginButtonDesktop.classList.remove('bg-indigo-50', 'hover:bg-indigo-100', 'text-indigo-700', 'border-indigo-200');
                loginButtonDesktop.classList.add('bg-red-50', 'hover:bg-red-100', 'text-red-700', 'border-red-200');
            } else {
                loginButton.textContent = 'Login';
                loginButtonDesktop.textContent = 'Login Admin';
                loginButton.onclick = toggleAdminLogin;
                loginButtonDesktop.onclick = toggleAdminLogin;
                loginButton.classList.add('bg-indigo-50', 'hover:bg-indigo-100', 'text-indigo-700', 'border-indigo-200');
                loginButton.classList.remove('bg-red-50', 'hover:bg-red-100', 'text-red-700', 'border-red-200');
                loginButtonDesktop.classList.add('bg-indigo-50', 'hover:bg-indigo-100', 'text-indigo-700', 'border-indigo-200');
                loginButtonDesktop.classList.remove('bg-red-50', 'hover:bg-red-100', 'text-red-700', 'border-red-200');
            }

            const pdfButton = document.getElementById('exportPdfButton');
            const resultsVisible = !document.getElementById('results').classList.contains('hidden');

            if (isLoggedIn && resultsVisible) {
                pdfButton.classList.remove('hidden');
            } else {
                pdfButton.classList.add('hidden');
            }

            updateAutoScheduleButton();

            const activeViewElement = document.querySelector('.view-content:not(.hidden)');
            if (activeViewElement) {
                const activeView = activeViewElement.id.replace('View', '');
                showView(activeView);
            }
        }

        window.toggleAdminLogin = function () {
            document.getElementById('loginModal').classList.toggle('hidden');
            if (!document.getElementById('loginModal').classList.contains('hidden')) {
                document.getElementById('adminPasswordInput').value = '';
                document.getElementById('adminPasswordInput').focus();
            }
        }

        window.attemptAdminLogin = function () {
            const inputPass = document.getElementById('adminPasswordInput').value;

            if (inputPass === ADMIN_PASSWORD) {
                isLoggedIn = true;
                localStorage.setItem('isAdminLoggedIn', 'true'); // Save to storage
                toggleAdminLogin();
                updateAdminUI();
                showMessage("Login Admin Berhasil!", "info");
                showView('estimation');
            } else {
                showMessage("Kata Sandi Salah.", "error");
                document.getElementById('adminPasswordInput').value = '';
                document.getElementById('adminPasswordInput').focus();
            }
        }

        window.prepareLogout = function () {
            toggleLogoutModal(true);
        }

        window.toggleLogoutModal = function (show) {
            document.getElementById('logoutModal').classList.toggle('hidden', !show);
        }

        window.confirmLogout = function () {
            toggleLogoutModal(false);
            handleAdminLogout();
        }

        function handleAdminLogout() {
            isLoggedIn = false;
            localStorage.removeItem('isAdminLoggedIn'); // Remove from storage
            updateAdminUI();
            showMessage("Logout Admin Berhasil.", "info");
            showView('estimation');
        }

        // --- NEW: Helper for Master Schedule ---
        window.renderScheduleMasterTable = async function (searchQuery = '') {
            const container = document.getElementById('scheduleMasterContainer');

            const totalCountSpan = document.getElementById('scheduleMasterTotalCount');

            const filteredData = masterScheduleData.filter(data => {
                if (!searchQuery) return true;
                const query = searchQuery.toLowerCase();

                let shiftQueryMatch = false;
                if (query.startsWith('shift')) {
                    shiftQueryMatch = data.schedule_shift && data.schedule_shift.toLowerCase() === query;
                } else if (query === '1' || query === '2' || query === '3') {
                    shiftQueryMatch = data.schedule_shift && data.schedule_shift.split(' ')[1] === query;
                }

                // Cari juga berdasarkan warna (lookup dinamis)
                let colorMatch = false;
                const matchingProduct = Object.values(productionData).find(p => p.code === data.product_code);
                const color = matchingProduct ? (matchingProduct.color || '') : '';
                if (color.toLowerCase().includes(query)) colorMatch = true;

                return (
                    (data.mesin && data.mesin.toLowerCase().includes(query)) ||
                    (data.product_code && data.product_code.toLowerCase().includes(query)) ||
                    (data.product_name && data.product_name.toLowerCase().includes(query)) ||
                    shiftQueryMatch ||
                    colorMatch
                );
            });

            let tableHTML = ``;

            if (masterScheduleData.length === 0) {
                tableHTML += `<p class="text-gray-500 p-4 bg-white">Belum ada slot jadwal yang tersimpan. Silakan input jadwal di tab Perencanaan Mesin.</p>`;
                container.innerHTML = tableHTML;
                if (totalCountSpan) totalCountSpan.textContent = '(0 Total Kode)';
                return;
            }

            const totalUniqueCodes = new Set(masterScheduleData.map(data => data.product_code));
            const totalUniqueCount = totalUniqueCodes.size;

            if (filteredData.length === 0 && searchQuery) {
                tableHTML += `<p class="text-gray-500 p-4 bg-white">Tidak ada hasil ditemukan untuk "${searchQuery}".</p>`;
                container.innerHTML = tableHTML;
                if (totalCountSpan) totalCountSpan.textContent = `(Menampilkan 0 dari ${totalUniqueCount} total kode)`;
                return;
            }

            const filteredUniqueCodes = new Set(filteredData.map(data => data.product_code));
            const filteredUniqueCount = filteredUniqueCodes.size;

            if (totalCountSpan) {
                if (searchQuery) {
                    totalCountSpan.textContent = `(Menampilkan ${filteredUniqueCount} dari ${totalUniqueCount} total kode)`;
                } else {
                    totalCountSpan.textContent = `(${totalUniqueCount} Total Kode)`;
                }
            }

            // Perubahan: Menambahkan Header 'Warna' setelah 'Nama Komponen'
            tableHTML += `
            <div class="overflow-x-auto rounded-lg shadow-md max-h-[60vh] overflow-y-auto">
                <table class="min-w-full bg-white border border-gray-200 text-sm">
                    <thead class="sticky top-0 bg-gray-100 z-10">
                        <tr class="text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                            ${isLoggedIn ? `<th class="py-2 px-3 border-b w-12 text-center">
                                    <input type="checkbox" id="selectAllSchedulesCheckbox" onclick="toggleSelectAllSchedules(this)" class="rounded border-gray-400 focus:ring-indigo-500">
                                </th>` : ''}
                            <th class="py-2 px-3 border-b w-12 text-center">#</th>
                            <th class="py-2 px-3 border-b text-center">Tanggal Jadwal</th>
                            <th class="py-2 px-3 border-b">Mesin Utama</th>
                            <th class="py-2 px-3 border-b">Kode Produk</th>
                            <th class="py-2 px-3 border-b">Nama Komponen</th>
                            <th class="py-2 px-3 border-b">Warna</th>
                            <th class="py-2 px-3 border-b text-center">Jml Pesanan (Dus)</th>
                            <th class="py-2 px-3 border-b text-center">Shift</th>
                            ${isLoggedIn ? '<th class="py-2 px-3 border-b text-center">Aksi</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>
                        `;

            const visibleIds = getVisibleScheduleIds();
            const allVisibleSelected = visibleIds.length > 0 && visibleIds.every(id => selectedScheduleIds.has(id));

            let lastSeenCode = null;

            filteredData.forEach((data, index) => {
                const rowClass = (index % 2 === 0) ? '' : 'bg-gray-50';

                const dateParts = data.schedule_date.split('-');
                const displayDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;

                const productName = data.product_name || 'Nama?';

                // Lookup Warna dari Data Master Produksi
                const matchingProduct = Object.values(productionData).find(p => p.code === data.product_code);
                const colorDisplay = matchingProduct ? (matchingProduct.color || '-') : '-';

                let finalQty = data.order_qty;
                if (!finalQty || finalQty == 0) {
                    finalQty = '-';
                }

                const isSameGroup = (lastSeenCode === data.product_code);

                let orderQtyDisplay = '';
                if (!isSameGroup) {
                    if (finalQty !== '-') {
                        orderQtyDisplay = `<span class="font-bold text-indigo-700 bg-indigo-50 px-2 py-0.5 rounded border border-indigo-100 text-xs">${finalQty}</span>`;
                    } else {
                        orderQtyDisplay = `<span class="text-gray-400 font-medium">-</span>`;
                    }
                    lastSeenCode = data.product_code;
                } else {
                    orderQtyDisplay = `<span class="text-gray-300 text-lg">"</span>`;
                }

                const isChecked = selectedScheduleIds.has(data.id);

                const checkboxCell = isLoggedIn ? `
                        <td class="py-2 px-3 text-center align-middle ${rowClass}">
                            <input type="checkbox"
                                class="rounded border-gray-400 schedule-checkbox focus:ring-indigo-500"
                                value="${data.id}"
                                ${isChecked ? 'checked' : ''}
                                onclick="toggleScheduleSelection(this, ${data.id})">
                        </td>
                        ` : '';

                const actionButtons = isLoggedIn ? `
                        <td class="py-1 px-2 text-center whitespace-nowrap align-middle ${rowClass}">
                            <button onclick='startScheduleEdit(${JSON.stringify(data)})'
                                class="text-indigo-500 hover:text-indigo-700 p-1 rounded-full transition duration-150 ease-in-out hover:bg-indigo-50"
                                title="Edit Jadwal">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                                    <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <button onclick="prepareScheduleDelete('${data.id}', '${data.product_code}', '${displayDate}', '${data.schedule_shift}')"
                                class="text-red-500 hover:text-red-700 p-1 rounded-full transition duration-150 ease-in-out hover:bg-red-50"
                                title="Hapus Jadwal">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </td>
                        ` : '';

                // UPDATE PERBAIKAN: Menambahkan 'truncate', 'max-w-[...]' dan 'title' tooltip
                // Ini akan memaksa semua baris memiliki tinggi yang sama (single line)
                tableHTML += `
                        <tr class="border-b hover:bg-gray-100 ${rowClass}">
                            ${checkboxCell}
                            <td class="py-2 px-3 text-center text-gray-500 align-middle whitespace-nowrap ${rowClass}">${index + 1}</td>
                            <td class="py-2 px-3 text-gray-700 text-center align-middle whitespace-nowrap">${displayDate}</td>
                            <td class="py-2 px-3 text-gray-800 font-bold align-middle whitespace-nowrap">${data.mesin}</td>
                            <td class="py-2 px-3 text-gray-700 font-mono font-bold align-middle whitespace-nowrap flex items-center gap-2 justify-center h-full">
                                ${data.product_code}
                                <div class="relative group">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 hover:text-indigo-500 cursor-help" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 hidden group-hover:block z-50 w-max px-2 py-1 bg-gray-800 text-white text-xs rounded shadow-lg">
                                        ${colorDisplay}
                                        <!-- Arrow -->
                                        <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-800"></div>
                                    </div>
                                </div>
                            </td>
                            <td class="py-2 px-3 text-gray-700 align-middle whitespace-nowrap max-w-[180px] truncate" title="${productName}">
                                ${productName}
                            </td>
                            <td class="py-2 px-3 text-gray-600 text-sm align-middle whitespace-nowrap max-w-[180px] truncate" title="${colorDisplay}">
                                ${colorDisplay}
                            </td>
                            <td class="py-2 px-3 text-center align-middle whitespace-nowrap">${orderQtyDisplay}</td>
                            <td class="py-2 px-3 text-gray-700 text-center align-middle whitespace-nowrap">${data.schedule_shift.split(' ')[1]}</td>
                            ${actionButtons}
                        </tr>
                        `;
            });

            tableHTML += `
                    </tbody>
                </table>
                </div>
            `;
            container.innerHTML = tableHTML;

            if (isLoggedIn) {
                const masterCheckbox = document.getElementById('selectAllSchedulesCheckbox');
                if (masterCheckbox) {
                    masterCheckbox.checked = allVisibleSelected;
                }
            }
        }

        window.toggleMultiDeleteModal = function (show) {
            document.getElementById('scheduleMultiDeleteModal').classList.toggle('hidden', !show);
        }

        function updateDeleteSelectedButtonState() {
            const container = document.getElementById('deleteSelectedScheduleContainer');
            const countSpan = document.getElementById('selectedScheduleCount');

            if (isLoggedIn && selectedScheduleIds.size > 0) {
                container.classList.remove('hidden');
                countSpan.textContent = selectedScheduleIds.size;
            } else {
                container.classList.add('hidden');
                countSpan.textContent = 0;
            }
        }

        window.toggleScheduleSelection = function (checkbox, id) {
            if (checkbox.checked) {
                selectedScheduleIds.add(id);
            } else {
                selectedScheduleIds.delete(id);
            }
            const masterCheckbox = document.getElementById('selectAllSchedulesCheckbox');
            if (masterCheckbox) {
                const visibleIds = getVisibleScheduleIds();
                masterCheckbox.checked = visibleIds.length > 0 && visibleIds.every(vid => selectedScheduleIds.has(vid));
            }
            updateDeleteSelectedButtonState();
        }

        function getVisibleScheduleIds() {
            const searchQuery = document.getElementById('scheduleMasterSearchInput').value;
            return masterScheduleData.filter(data => {
                if (!searchQuery) return true;
                const query = searchQuery.toLowerCase();
                // Update filter to include color logic in helper as well if needed, or simple check
                // For selection logic, reuse the main filter logic roughly or keep simple
                return (
                    (data.mesin && data.mesin.toLowerCase().includes(query)) ||
                    (data.product_code && data.product_code.toLowerCase().includes(query)) ||
                    (data.product_name && data.product_name.toLowerCase().includes(query))
                );
            }).map(data => data.id);
        }

        window.toggleSelectAllSchedules = function (masterCheckbox) {
            const visibleIds = getVisibleScheduleIds();

            if (masterCheckbox.checked) {
                visibleIds.forEach(id => selectedScheduleIds.add(id));
            } else {
                visibleIds.forEach(id => selectedScheduleIds.delete(id));
            }

            renderScheduleMasterTable(document.getElementById('scheduleMasterSearchInput').value);
            updateDeleteSelectedButtonState();
        }

        window.confirmDeleteSelectedSchedules = function () {
            if (selectedScheduleIds.size === 0) {
                showMessage("Tidak ada item yang dipilih.", "error");
                return;
            }
            document.getElementById('multiDeleteCount').textContent = selectedScheduleIds.size;
            toggleMultiDeleteModal(true);
        }

        window.executeDeleteSelectedSchedules = async function () {
            toggleMultiDeleteModal(false);
            const idsToDelete = Array.from(selectedScheduleIds);

            if (idsToDelete.length === 0) return;

            showMessage(`Menghapus ${idsToDelete.length} slot...`, "info");

            try {
                const { error } = await supabase
                    .from(SCHEDULE_TABLE_NAME)
                    .delete()
                    .in('id', idsToDelete);

                if (error) throw error;

                showMessage(`${idsToDelete.length} slot jadwal berhasil dihapus!`, "info");
                selectedScheduleIds.clear();
                updateDeleteSelectedButtonState();

                await fetchAllScheduleData();
                renderScheduleMasterTable(document.getElementById('scheduleMasterSearchInput').value);

                const start = document.getElementById('startDate').value;
                const end = document.getElementById('endDate').value;
                if (start && end) {
                    renderPlanningTable(start, end);
                }

            } catch (e) {
                console.error("Error deleting multiple schedule slots:", e);
                showMessage("Gagal menghapus slot jadwal. Cek koneksi atau izin RLS.", "error");
            }
        }

        async function fetchScheduleData(startDateStr, endDateStr) {
            if (!supabase) return;

            const startDateParsed = parseDMY(startDateStr);
            const endDateParsed = parseDMY(endDateStr);

            if (!startDateParsed || !endDateParsed) {
                console.error("Format tanggal tidak valid saat memanggil fetchScheduleData");
                scheduleData = {};
                return;
            }

            const startDb = formatDateToYMD(startDateParsed);
            const endDb = formatDateToYMD(endDateParsed);

            try {
                const { data, error } = await supabase
                    .from(SCHEDULE_TABLE_NAME)
                    .select('*')
                    .gte('schedule_date', startDb)
                    .lte('schedule_date', endDb);

                if (error) throw error;

                const newScheduleData = {};
                data.forEach(item => {
                    const key = `${item.mesin}|${item.schedule_date}|${item.schedule_shift}`;
                    newScheduleData[key] = item;
                });
                scheduleData = newScheduleData;

            } catch (e) {
                console.error("Error fetching schedule data:", e);
                scheduleData = {};
                if (e.message && e.message.includes("Could not find the table")) {
                    showMessage(`Gagal memuat: Tabel '${SCHEDULE_TABLE_NAME}' tidak ditemukan di Supabase.Mohon buat tabel tersebut.`, "error");
                } else {
                    showMessage("Gagal memuat data jadwal dari database.", "error");
                }
            }
        }

        async function fetchAllScheduleData() {
            if (!supabase) return;

            try {
                const { data, error } = await supabase
                    .from(SCHEDULE_TABLE_NAME)
                    .select('*')
                    .order('product_code', { ascending: true })
                    .order('schedule_date', { ascending: true })
                    .order('mesin', { ascending: true })
                    .order('schedule_shift', { ascending: true });

                if (error) throw error;
                masterScheduleData = data;

            } catch (e) {
                console.error("Error fetching all schedule data for master table:", e);
                masterScheduleData = [];
                if (e.message && e.message.includes("Could not find the table")) {
                    showMessage(`Gagal memuat data Master Jadwal: Tabel '${SCHEDULE_TABLE_NAME}' tidak ditemukan.`, "error");
                } else if (e.message && e.message.includes("fetch")) {
                    showMessage(`Gagal memuat data Master Jadwal: Terjadi error jaringan(Failed to fetch).Ini mungkin karena RLS(Row Level Security) pada tabel '${SCHEDULE_TABLE_NAME}' memblokir pembacaan.`, "error");
                } else {
                    showMessage("Gagal memuat semua data jadwal dari database.", "error");
                }
            }
        }

        async function exportEstimationToPDF() {
            const printArea = document.getElementById('estimationPrintArea');
            const detailsDiv = document.getElementById('estimationDetails');
            const toggleBtnContainer = document.getElementById('toggleDetailsContainer');
            const autoSchedulePanel = document.getElementById('autoSchedulePanel'); // Referensi ke panel jadwal
            const logoUrl = 'https://img.lazcdn.com/g/ff/kf/Sf1cc8d330638465fa063a736e486ed5fK.jpg_720x720q80.jpg';

            if (!printArea || !window.jspdf || !window.html2canvas) {
                showMessage("Library PDF (jsPDF/html2canvas) belum dimuat.", "error");
                return;
            }

            const wasDetailsHidden = detailsDiv.classList.contains('hidden');

            // Cek apakah panel jadwal sedang tampil
            const wasScheduleVisible = !autoSchedulePanel.classList.contains('hidden');

            showMessage("Mempersiapkan PDF (Skala 2x)...", "info");

            // 1. Tampilkan Detail (agar tercetak)
            if (wasDetailsHidden) {
                detailsDiv.classList.remove('hidden');
            }

            // 2. Sembunyikan Panel Jadwal saat print (Fitur ini tetap dipertahankan untuk kerapian PDF)
            if (wasScheduleVisible) {
                autoSchedulePanel.classList.add('hidden');
            }

            // 3. Sembunyikan tombol toggle
            toggleBtnContainer.classList.add('hidden');
            printArea.classList.add('pdf-export-font');

            try {
                let logoBase64 = '';
                try {
                    const response = await fetch(logoUrl);
                    if (!response.ok) throw new Error('Gagal memuat logo, status: ' + response.status);
                    const blob = await response.blob();
                    logoBase64 = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                } catch (e) {
                    console.warn("Gagal memuat logo untuk PDF (mungkin masalah CORS):", e);
                }


                const canvas = await html2canvas(printArea, {
                    scale: 2,
                    useCORS: true,
                    logging: false
                });

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');

                const imgData = canvas.toDataURL('image/png');
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();

                const margin = 10;

                const headerStartY = 10;
                const logoSize = 15;

                if (logoBase64) {
                    try {
                        const imageType = logoBase64.startsWith('data:image/png') ? 'PNG' : 'JPEG';
                        pdf.addImage(logoBase64, imageType, margin, headerStartY, logoSize, logoSize);
                    } catch (e) {
                        console.error("Gagal menambahkan logo ke PDF:", e);
                    }
                }

                const title = `HASIL ESTIMASI WAKTU PRODUKSI(MULTI - ITEM)`;
                pdf.setFontSize(18);
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(40, 40, 40);

                const titleY = headerStartY + (logoSize / 2);

                pdf.text(title, pdfWidth / 2, titleY, { align: 'center', baseline: 'middle' });

                const usableWidth = pdfWidth - (margin * 2);
                const imageY = headerStartY + logoSize + 7;
                const usableHeight = pdfHeight - imageY - margin;

                const imgRatio = imgProps.width / imgProps.height;
                const pdfRatio = usableWidth / usableHeight;

                let finalImgWidth, finalImgHeight;

                if (imgRatio > pdfRatio) {
                    finalImgWidth = usableWidth;
                    finalImgHeight = finalImgWidth / imgRatio;
                } else {
                    finalImgHeight = usableHeight;
                    finalImgWidth = finalImgHeight * imgRatio;
                }

                const x = (pdfWidth - finalImgWidth) / 2;

                pdf.addImage(imgData, 'PNG', x, imageY, finalImgWidth, finalImgHeight);

                pdf.save(`Estimasi_Produksi_${new Date().toISOString().split('T')[0]}.pdf`);

                showMessage("PDF berhasil dibuat!", "info");

            } catch (e) {
                console.error("Gagal membuat PDF:", e);
                showMessage("Gagal membuat PDF. Lihat konsol untuk detail error.", "error");
            } finally {
                // Kembalikan tampilan seperti semula
                if (wasDetailsHidden) {
                    detailsDiv.classList.add('hidden');
                }

                // Kembalikan Panel Jadwal jika sebelumnya terlihat
                if (wasScheduleVisible) {
                    autoSchedulePanel.classList.remove('hidden');
                }

                toggleBtnContainer.classList.remove('hidden');
                printArea.classList.remove('pdf-export-font');
            }
        }

        window.exportPlanningMatrixToExcel = function () {
            if (typeof XLSX === 'undefined') {
                showMessage("Library Excel (xlsx.js) belum dimuat. Coba refresh halaman.", "error");
                return;
            }

            const table = document.getElementById('planningActualTable');
            const wrapper = document.getElementById('planningTableWrapper');

            if (!table || wrapper.classList.contains('hidden') || !table.rows || table.rows.length <= 1) {
                showMessage("Tidak ada data matriks untuk diekspor. Harap tampilkan jadwal terlebih dahulu.", "error");
                return;
            }

            showMessage("Mempersiapkan data Excel...", "info");

            const tableClone = table.cloneNode(true);

            const rows = tableClone.getElementsByTagName('tr');
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                for (let j = 0; j < cells.length; j++) {
                    const cell = cells[j];

                    // PERBAIKAN DI SINI: Logika Pengambilan Nama & Tipe Mesin
                    if (cell.classList.contains('sticky-machine')) {
                        // 1. Cari div pembungkus nama (karena ada ikon info)
                        const nameDiv = cell.querySelector('div');
                        // Ambil teks dari span di dalam div, atau span langsung jika tidak ada div
                        const nameSpan = nameDiv ? nameDiv.querySelector('span') : cell.querySelector('span');

                        // 2. Cari span khusus tipe mesin (yang punya class text-xs)
                        const typeSpan = cell.querySelector('span.text-xs');

                        const machineCode = nameSpan ? nameSpan.textContent.trim() : '';
                        const machineType = typeSpan ? typeSpan.textContent.trim() : '';

                        // 3. Gabungkan keduanya
                        if (machineCode && machineType) {
                            cell.textContent = `${machineCode} (${machineType})`;
                        } else {
                            // Fallback jika salah satu kosong
                            cell.textContent = machineCode || cell.textContent.trim();
                        }

                    } else if (cell.classList.contains('sticky-shift')) {
                        cell.textContent = cell.textContent.trim();

                    } else {
                        // UBAH: Selector disesuaikan dengan class yang ada (text-sm & text-[11px])
                        const codeSpan = cell.querySelector('span.text-sm');
                        const nameSpan = cell.querySelector('span.text-xs') || cell.querySelector('span.text-\\[11px\\]');

                        if (codeSpan && nameSpan) {
                            const shortName = shortenComponentName(nameSpan.textContent.trim());
                            cell.textContent = `${codeSpan.textContent.trim()} (${shortName})`;
                        } else if (cell.textContent.includes('LIBUR')) {
                            cell.textContent = 'LIBUR';
                        } else if (cell.textContent.includes('Slot Kosong') || cell.textContent.includes('Kosong')) {
                            cell.textContent = '';
                        }
                    }
                }
            }

            // MENGHITUNG STATISTIK ON/OFF UNTUK EXCEL
            const groupedData = groupProductionDataByMachine ? groupProductionDataByMachine() : [];
            const validMachines = groupedData.filter(m => m.machineCode && m.machineCode !== 'MESIN TAK DIKETAHUI');
            const totalMachines = validMachines.length;
            const scheduleValues = Object.values(scheduleData);

            // Ambil header tanggal dari baris pertama tabel (tr[0])
            // Baris 0: header (Mesin, Shift, Tanggal...)
            const headerRow = table.rows[0];
            const datesInHeader = [];
            for (let c = 2; c < headerRow.cells.length; c++) {
                // Header format: "19/12 (JUM)"
                const fullText = headerRow.cells[c].textContent.trim();
                datesInHeader.push(fullText);
            }

            // Persiapkan data ringkasan harian
            const summaryOn = ["MESIN ON"];
            const summaryOff = ["MESIN OFF"];
            const summaryUtil = ["UTILISASI (%)"];

            // Kosongkan 2 kolom pertama (Mesin & Shift)
            summaryOn.push("");
            summaryOff.push("");
            summaryUtil.push("");

            // Hitung statistik per kolom tanggal
            datesInHeader.forEach(dateLabel => {
                // Mencari database date yang cocok dengan label "DD/MM (WD)"
                // Karena kita tidak punya akses langsung ke array 'dates', kita coba parse dari label
                // Label format: "19/12 (JUM)"
                const dayMonth = dateLabel.split(' ')[0]; // "19/12"

                // Cari item di scheduleValues yang cocok dengan tanggal ini
                // Note: schedule_date format is YYYY-MM-DD. 
                // Kita cari yang matches DD/MM di akhir kuncinya
                const matchingSchedules = scheduleValues.filter(item => {
                    const d = item.schedule_date.split('-'); // [YYYY, MM, DD]
                    return `${d[2]}/${d[1]}` === dayMonth;
                });

                const activeMachines = new Set(matchingSchedules.map(item => item.mesin)).size;
                const inactiveMachines = totalMachines - activeMachines;
                const util = totalMachines > 0 ? Math.round((activeMachines / totalMachines) * 100) : 0;

                summaryOn.push(activeMachines);
                summaryOff.push(inactiveMachines);
                summaryUtil.push(util + "%");
            });

            const startDateStr = document.getElementById('startDate').value.replace(/\//g, '-');
            const endDateStr = document.getElementById('endDate').value.replace(/\//g, '-');
            const fileName = `Perencanaan_Mesin_${startDateStr}_sd_${endDateStr}.xlsx`;

            try {
                // Konversi data di atas menjadi format yang bisa digabung
                const wb = XLSX.utils.book_new();

                // 1. Buat sheet dari tabel (sudah dibersihkan)
                const ws = XLSX.utils.table_to_sheet(tableClone);

                // 2. Sisipkan row summary di index paling atas
                // Kita pakai sheet_add_aoa untuk menyisipkan data di baris 0, 1, 2, 3
                // Dan geser data tabel ke bawah. 
                // Tapi lebih mudah buat array of arrays baru: summary + header + data

                const tableData = XLSX.utils.sheet_to_json(ws, { header: 1 });

                // Tambahkan header ringkasan
                const finalData = [
                    ["RINGKASAN BEBAN KERJA HARIAN", "", ...Array(datesInHeader.length).fill("")],
                    summaryOn,
                    summaryOff,
                    summaryUtil,
                    [], // Spasi kosong
                    ...tableData
                ];

                const finalWs = XLSX.utils.aoa_to_sheet(finalData);

                // Re-apply Styles and Merges if needed (though basic version is enough)
                // finalWs['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 1 + datesInHeader.length } }];

                XLSX.utils.book_append_sheet(wb, finalWs, "Jadwal");
                XLSX.writeFile(wb, fileName);

            } catch (e) {
                console.error("Gagal mengekspor Excel:", e);
                showMessage("Terjadi kesalahan saat membuat file Excel.", "error");
            }
        }

        window.exportMasterScheduleToExcel = function () {
            if (typeof XLSX === 'undefined') {
                showMessage("Library Excel (xlsx.js) belum dimuat. Coba refresh halaman.", "error");
                return;
            }

            const searchQuery = document.getElementById('scheduleMasterSearchInput').value;
            const filteredData = masterScheduleData.filter(data => {
                if (!searchQuery) return true;
                const query = searchQuery.toLowerCase();
                return (
                    (data.mesin && data.mesin.toLowerCase().includes(query)) ||
                    (data.product_code && data.product_code.toLowerCase().includes(query)) ||
                    (data.product_name && data.product_name.toLowerCase().includes(query))
                );
            });

            if (filteredData.length === 0) {
                showMessage("Tidak ada data untuk diekspor (mungkin tabel kosong or filter tidak menemukan hasil).", "error");
                return;
            }

            showMessage("Mempersiapkan data Excel...", "info");

            const dataForExcel = filteredData.map(data => {
                const dateParts = data.schedule_date.split('-');
                const displayDate = `${dateParts[2]} /${dateParts[1]}/${dateParts[0]} `;

                return {
                    "MESIN UTAMA": data.mesin,
                    "KODE PRODUK": data.product_code,
                    "NAMA KOMPONEN": shortenComponentName(data.product_name || 'N/A'),
                    "JML PESANAN (DUS)": data.order_qty || '-',
                    "SHIFT": data.schedule_shift.split(' ')[1],
                    "TANGGAL JADWAL": displayDate
                };
            });

            try {
                const ws = XLSX.utils.json_to_sheet(dataForExcel);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Master Jadwal");

                ws['!cols'] = [
                    { wch: 15 },
                    { wch: 15 },
                    { wch: 30 },
                    { wch: 15 }, // QTY COL WIDTH
                    { wch: 10 },
                    { wch: 18 }
                ];

                const fileName = `Master_Jadwal_Mesin_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

            } catch (e) {
                console.error("Gagal mengekspor Master Jadwal Excel:", e);
                showMessage("Terjadi kesalahan saat membuat file Excel.", "error");
            }
        }

        // --- FUNGSI BARU: Export Data Master Produksi ke Excel ---
        window.exportProductionMasterToExcel = function () {
            if (typeof XLSX === 'undefined') {
                showMessage("Library Excel (xlsx.js) belum dimuat. Coba refresh halaman.", "error");
                return;
            }

            // Ambil query pencarian saat ini agar hasil export sesuai filter
            const searchQuery = document.getElementById('masterSearchInput').value.toLowerCase();
            const dataArray = Object.values(productionData);

            if (dataArray.length === 0) {
                showMessage("Tidak ada data produksi tersimpan untuk diekspor.", "error");
                return;
            }

            // Filter data sesuai tampilan
            const filteredData = dataArray.filter(data => {
                if (!searchQuery) return true;
                return (
                    data.code.toLowerCase().includes(searchQuery) ||
                    data.name.toLowerCase().includes(searchQuery) ||
                    data.machine.toLowerCase().includes(searchQuery) ||
                    (data.machine_optional && data.machine_optional.toLowerCase().includes(searchQuery))
                );
            });

            if (filteredData.length === 0) {
                showMessage("Tidak ada data yang cocok dengan pencarian untuk diekspor.", "error");
                return;
            }

            // Urutkan berdasarkan Kode Barang (A-Z) agar rapi
            filteredData.sort((a, b) => a.code.localeCompare(b.code));

            showMessage("Mempersiapkan data Excel Data Master...", "info");

            // Map data ke format Excel yang rapi
            const dataForExcel = filteredData.map((data, index) => {
                const capacity3ShiftPcs = data.targetPerShift * 3; // Hitung ulang kapasitas
                return {
                    "NO": index + 1,
                    "KODE BARANG": data.code,
                    "NAMA KOMPONEN / PRODUK": shortenComponentName(data.name),
                    "MESIN UTAMA": data.machine,
                    "MESIN (OPTIONAL)": data.machine_optional || '-',
                    "ISI DUS (PCS)": data.pcs_per_box,
                    "TARGET 1 SHIFT (PCS)": data.targetPerShift,
                    "KAPASITAS 3 SHIFT (PCS)": capacity3ShiftPcs
                };
            });

            try {
                // Buat Workbook dan Worksheet baru
                const ws = XLSX.utils.json_to_sheet(dataForExcel);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Data Master Produksi");

                // Atur lebar kolom agar mudah dibaca
                ws['!cols'] = [
                    { wch: 5 },  // No
                    { wch: 15 }, // Kode
                    { wch: 35 }, // Nama
                    { wch: 15 }, // Mesin Utama
                    { wch: 20 }, // Mesin Optional
                    { wch: 12 }, // Isi Dus
                    { wch: 20 }, // Target
                    { wch: 22 }  // Kapasitas
                ];

                const fileName = `Data_Master_Produksi_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                showMessage("File Excel berhasil diunduh!", "info");

            } catch (e) {
                console.error("Gagal mengekspor Data Master Excel:", e);
                showMessage("Terjadi kesalahan saat membuat file Excel.", "error");
            }
        }

        window.confirmAndSaveSchedule = async function (slots, startDateStr, endDateDisplay) {
            if (!isLoggedIn) {
                showMessage("Akses ditolak. Silakan Login sebagai Admin untuk menyimpan jadwal otomatis.", "error");
                return;
            }

            showMessage(`Menyimpan ${slots.length} slot jadwal ke database...`, "info");

            let errorCount = 0;
            const errors = [];
            const dataToInsert = slots.map(slot => ({
                mesin: slot.machine,
                schedule_date: slot.dbDate,
                schedule_shift: slot.shift,
                product_code: slot.productCode,
                product_name: slot.productName,
                order_qty: slot.orderQty, // INSERT QTY
                timestamp: new Date().toISOString()
            }));

            try {
                const { error } = await supabase
                    .from(SCHEDULE_TABLE_NAME)
                    .insert(dataToInsert);

                if (error) {
                    errorCount = slots.length;
                    errors.push(error.message);
                }

            } catch (e) {
                errorCount = slots.length;
                errors.push(e.message);
            }

            if (errorCount > 0) {
                showMessage(`Gagal menyimpan ${errorCount} slot.${errors[0]}. Cek RLS atau kolom database.`, "error");
            } else {
                showMessage(`Berhasil! ${slots.length} slot jadwal telah disimpan.Mengalihkan ke Tabel Perencanaan...`, "info");
            }

            document.getElementById('autoScheduleStatus').classList.add('hidden');

            if (errorCount === 0 && startDateStr && endDateDisplay) {
                await fetchAllScheduleData();

                const startDate = parseDMY(startDateStr);
                let weeklyEndDateStr = endDateDisplay;

                if (startDate) {
                    // Default view 1 minggu ke depan agar tabel tidak terlalu lebar
                    const weeklyEndDate = new Date(startDate);
                    weeklyEndDate.setDate(startDate.getDate() + 6);
                    weeklyEndDateStr = formatDateToDMY(weeklyEndDate);
                }

                // Set input tanggal di tab Planning
                document.getElementById('startDate').value = startDateStr;
                document.getElementById('endDate').value = weeklyEndDateStr;

                // Pindah ke Tab Planning & Render Tabel
                showView('planning');
                renderPlanningTable(startDateStr, weeklyEndDateStr);
            }
        }

        // --- NEW: Handle Auto Schedule Click ---
        window.handleAutoScheduleClick = async function () {
            const startDateStr = document.getElementById('autoScheduleStartDate').value.trim();
            if (!startDateStr) {
                showMessage("Mohon masukkan Tanggal Mulai Produksi Ideal.", "error");
                return;
            }
            const startDate = parseDMY(startDateStr);
            if (!startDate) {
                showMessage("Format Tanggal Mulai tidak valid (DD/MM/YYYY).", "error");
                return;
            }

            if (isLoggedIn) {
                const selectedCheckboxes = document.querySelectorAll('.component-checkbox:checked');
                const selectedComponents = Array.from(selectedCheckboxes).map(cb => {
                    return pendingScheduleComponents[parseInt(cb.value)];
                });

                if (selectedComponents.length === 0) {
                    showMessage("Tidak ada komponen yang dipilih untuk dijadwalkan. Harap pilih minimal satu komponen.", "error");
                    return;
                }

                showMessage(`Memulai simulasi penjadwalan otomatis untuk ${selectedComponents.length} komponen...`, "info");

                const results = await autoScheduleProduction_Simple(startDate, selectedComponents);

                if (results.error) {
                    showMessage(results.error, "error");
                } else {

                    const statusMessage = document.getElementById('autoScheduleStatus');
                    statusMessage.classList.remove('hidden');

                    // UPDATE: Tampilan hasil simulasi sekarang menggunakan tombol yang lebih jelas
                    statusMessage.innerHTML = `
            <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mt-4" role="alert">
                            <p class="font-bold">Simulasi Berhasil!</p>
                            <p>Sistem telah menemukan slot kosong untuk ${results.scheduledCount} dari ${selectedComponents.length} komponen.</p>
                            <ul class="list-disc list-inside text-sm mt-2 mb-4">
                                <li>Tanggal Mulai: ${startDateStr}</li>
                                <li>Estimasi Selesai: ${results.endDateDisplay}</li>
                                <li>Total Slot Dijadwalkan: ${results.proposedSlots.length} Slot</li>
                            </ul>
                            
                            <div class="flex items-center mt-2">
                                <button onclick='confirmAndSaveSchedule(${JSON.stringify(results.proposedSlots)}, "${startDateStr}", "${results.endDateDisplay}")' 
                                        class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded shadow-md transition duration-300 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z" />
                                    </svg>
                                    Simpan ke Database & Lihat Tabel
                                </button>
                                <span class="text-xs text-gray-500 ml-3 italic">Klik untuk menerapkan hasil ke Tabel Perencanaan.</span>
                            </div>
                        </div>
            `;
                }

            } else {
                // ... existing code for non-admin ...
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
                const endDateStr = formatDateToDMY(endDate);

                document.getElementById('startDate').value = startDateStr;
                document.getElementById('endDate').value = endDateStr;

                showView('planning');
                renderPlanningTable(startDateStr, endDateStr);
            }
        }

        function renderComponentSelectionList(components) {
            const listContainer = document.getElementById('componentSelectionList');
            const selectionContainer = document.getElementById('componentSelectionContainer');
            const selectAllCheckbox = document.getElementById('selectAllComponents');

            listContainer.innerHTML = '';

            if (!components || components.length === 0) {
                selectionContainer.classList.add('hidden');
                return;
            }

            selectionContainer.classList.remove('hidden');

            const decimalFormatter = new Intl.NumberFormat('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            components.forEach((component, index) => {
                const shiftNet = component.shiftNet;
                const shiftsRounded = Math.ceil(shiftNet); // Not really used in display but kept for logic if needed
                const colorName = component.color || 'N/A';

                // Simple Color Mapping Logic (similar to renderDetailedTable)
                let colorClass = 'bg-gray-100 text-gray-800'; // Default
                const lowerColor = colorName.toLowerCase();

                if (lowerColor.includes('hijau') || lowerColor.includes('green')) colorClass = 'bg-green-100 text-green-800';
                else if (lowerColor.includes('biru') || lowerColor.includes('blue')) colorClass = 'bg-blue-100 text-blue-800';
                else if (lowerColor.includes('merah') || lowerColor.includes('red')) colorClass = 'bg-red-100 text-red-800';
                else if (lowerColor.includes('kuning') || lowerColor.includes('yellow')) colorClass = 'bg-yellow-100 text-yellow-800';
                else if (lowerColor.includes('hitam') || lowerColor.includes('black')) colorClass = 'bg-gray-800 text-white';
                else if (lowerColor.includes('putih') || lowerColor.includes('white')) colorClass = 'bg-white border border-gray-200 text-gray-800';
                else if (lowerColor.includes('ungu') || lowerColor.includes('purple')) colorClass = 'bg-purple-100 text-purple-800';
                else if (lowerColor.includes('orange')) colorClass = 'bg-orange-100 text-orange-800';
                else if (lowerColor.includes('pink')) colorClass = 'bg-pink-100 text-pink-800';
                else if (lowerColor.includes('bening')) colorClass = 'bg-slate-100 text-slate-800 border border-slate-300';

                const html = `
            <div class="flex items-center p-3 rounded-lg hover:bg-gray-50 border border-transparent hover:border-gray-200 transition-all duration-200">
                <input type="checkbox" id="component-check-${index}" value="${index}" class="component-checkbox w-4 h-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer" checked>
                    <label for="component-check-${index}" class="ml-3 flex-1 cursor-pointer">
                        <div class="flex items-center flex-wrap gap-2">
                            <span class="font-bold text-gray-800 text-sm">${component.productCode} - ${component.productName}</span>
                            <span class="text-xs px-2 py-0.5 rounded-full font-medium ${colorClass} border border-opacity-20 flex-shrink-0">
                                ${colorName}
                            </span>
                            <span class="text-xs text-gray-400 font-mono ml-auto">(${component.machine})</span>
                        </div>
                        <div class="mt-1 flex items-center justify-between">
                            <span class="text-xs text-indigo-600 font-medium bg-indigo-50 px-2 py-0.5 rounded">${decimalFormatter.format(shiftNet)} Shift</span>
                        </div>
                    </label>
                </div>
        `;
                listContainer.innerHTML += html;
            });

            selectAllCheckbox.checked = true;
        }

        window.toggleSelectAll = function (masterCheckbox) {
            const checkboxes = document.querySelectorAll('.component-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = masterCheckbox.checked;
            });
        }

        // --- NEW: Toggle & Logic for Add Schedule Modal ---
        window.closePlanningTable = function () {
            const section = document.getElementById('planningResultSection');
            const placeholder = document.getElementById('planningTablePlaceholder');
            const dailySummary = document.getElementById('dailySummaryContainer');
            const chartPlaceholder = document.getElementById('chartPlaceholder');
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');

            if (section) section.classList.add('hidden');
            if (placeholder) placeholder.classList.remove('hidden');
            if (dailySummary) dailySummary.classList.add('hidden');
            if (chartPlaceholder) chartPlaceholder.classList.remove('hidden');

            // Reset input tanggal
            if (startDateInput) startDateInput.value = '';
            if (endDateInput) endDateInput.value = '';
        };

        window.toggleScheduleAddModal = function (show) {
            const modal = document.getElementById('scheduleAddModal');
            if (modal) modal.classList.toggle('hidden', !show);
        }

        window.openAddScheduleModal = function (machineName, dateStr, shift) {
            const dateParts = dateStr.split('-');
            const displayDate = `${dateParts[2]} /${dateParts[1]}/${dateParts[0]} `;

            document.getElementById('addScheduleMachine').value = machineName;
            document.getElementById('addScheduleDate').value = displayDate;
            document.getElementById('addScheduleShift').value = shift;

            // Reset fields
            document.getElementById('addScheduleCode').value = '';
            document.getElementById('addScheduleQty').value = '';
            document.getElementById('addScheduleName').innerHTML = '<option value="" disabled selected>Otomatis (Isi Kode)</option>';
            document.getElementById('addSlotStatusMessage').textContent = '';

            toggleScheduleAddModal(true);
            checkSlotAvailability_AddModal();
        }

        window.findProductNameByCode_AddModal = function () {
            const codeInput = document.getElementById('addScheduleCode');
            const nameDropdown = document.getElementById('addScheduleName');
            const code = codeInput.value.trim().toUpperCase();

            nameDropdown.innerHTML = '';

            if (!code) {
                nameDropdown.innerHTML = '<option value="" disabled selected>Otomatis (Isi Kode)</option>';
                checkSlotAvailability_AddModal(null);
                return;
            }

            const matchingProducts = Object.values(productionData).filter(p => p.code === code);

            if (matchingProducts.length > 0) {
                if (matchingProducts.length > 1) {
                    nameDropdown.innerHTML = '<option value="" disabled selected>Pilih Komponen...</option>';
                }

                matchingProducts.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.name;
                    option.textContent = product.name;
                    nameDropdown.appendChild(option);
                });

                if (matchingProducts.length === 1) {
                    nameDropdown.value = matchingProducts[0].name;
                    handleComponentSelectionChange_AddModal();
                }
            } else {
                nameDropdown.innerHTML = '<option value="" disabled>Kode tidak ditemukan</option>';
                checkSlotAvailability_AddModal(null);
            }
        }

        window.handleComponentSelectionChange_AddModal = function () {
            const code = document.getElementById('addScheduleCode').value.trim().toUpperCase();
            const componentName = document.getElementById('addScheduleName').value;

            if (!code || !componentName) {
                checkSlotAvailability_AddModal(null);
                return;
            }

            const product = Object.values(productionData).find(p => p.code === code && p.name === componentName);
            checkSlotAvailability_AddModal(product);
        }

        window.validateSlotColor = function (machine, dateYMD, shiftString, newColor) {
            if (!newColor) return { valid: true };

            const shiftNum = parseInt(shiftString.replace(/\D/g, ''));
            let prevDate = new Date(parseDMY(formatDateToDMY(new Date(dateYMD))));
            let prevShiftNum = 0;

            if (shiftNum === 1) {
                prevShiftNum = 3;
                prevDate.setDate(prevDate.getDate() - 1);
            } else {
                prevShiftNum = shiftNum - 1;
            }

            const prevDateYMD = formatDateToYMD(prevDate);
            const prevKey = `${machine}|${prevDateYMD}|Shift ${prevShiftNum}`;
            const prevItem = scheduleData[prevKey];

            if (!prevItem) return { valid: true };

            const prevColor = prevItem.color || (prevItem.product_code ? (Object.values(productionData).find(p => p.code === prevItem.product_code && p.name === prevItem.product_name)?.color) : null);

            const catPrev = getColorCategory(prevColor);
            const catCurr = getColorCategory(newColor);

            if (catPrev !== catCurr) {
                return {
                    valid: false,
                    message: `Warna tidak cocok dengan slot sebelumnya! (Prev: ${prevColor || '-'} vs New: ${newColor})`
                };
            }

            return { valid: true };
        }

        window.checkSlotAvailability_AddModal = async function (productData = null) {
            const messageEl = document.getElementById('addSlotStatusMessage');
            if (!messageEl) return;

            const machineDropdown = document.getElementById('addScheduleMachine');
            const dateStr = document.getElementById('addScheduleDate').value;
            const shift = document.getElementById('addScheduleShift').value;
            const codeInput = document.getElementById('addScheduleCode');
            const code = codeInput.value.trim().toUpperCase();

            if (!isLoggedIn || !code || !dateStr || !shift) {
                messageEl.textContent = ''; return;
            }

            const parsedDate = parseDMY(dateStr);
            if (!parsedDate) {
                messageEl.textContent = 'Format Tanggal Salah';
                messageEl.className = 'text-sm font-bold mt-3 text-center text-red-600';
                return;
            }
            const dbDate = formatDateToYMD(parsedDate);

            if (!productData) {
                const componentName = document.getElementById('addScheduleName').value;
                if (componentName) {
                    productData = Object.values(productionData).find(p => p.code === code && p.name === componentName);
                } else {
                    productData = Object.values(productionData).find(p => p.code === code);
                }
            }

            if (!productData) {
                messageEl.textContent = '';
                return;
            }

            // Check if selected machine is valid for this product
            const machinesToCheck = [];
            if (productData.machine) machinesToCheck.push(productData.machine);
            if (productData.machine_optional) {
                productData.machine_optional.split(',').map(m => m.trim().toUpperCase()).filter(m => m && !machinesToCheck.includes(m)).forEach(m => machinesToCheck.push(m));
            }

            const selectedMachine = machineDropdown.value;
            let statusMessage = '';
            let messageColor = '';

            if (!machinesToCheck.includes(selectedMachine)) {
                statusMessage = `Peringatan: Produk ini biasanya diproses di ${machinesToCheck.join(', ')} `;
                messageColor = 'text-orange-600';
            } else {
                statusMessage = 'Produk kompatibel dengan mesin ini.';
                messageColor = 'text-green-600';
            }

            // Final check: Is slot empty?
            const key = `${selectedMachine}|${dbDate}|${shift}`;
            const scheduleItem = scheduleData[key];

            if (scheduleItem) {
                statusMessage = "SLOT SUDAH TERISI!";
                messageColor = 'text-red-600';
            } else {
                // NEW: Color Stickiness Check (Validasi Warna)
                if (productData) {
                    const colorCheck = validateSlotColor(selectedMachine, dbDate, shift, productData.color);
                    if (!colorCheck.valid) {
                        statusMessage = `PERINGATAN: ${colorCheck.message}`;
                        messageColor = 'text-red-600 font-bold bg-yellow-50 p-2 rounded border border-yellow-200 block';
                    }
                }
            }

            messageEl.textContent = statusMessage;
            messageEl.className = `text-sm font-bold mt-3 text-center ${messageColor}`;
        }

        window.saveScheduleSlotFromModal = async function (forceWeekend = false) {
            if (!isLoggedIn) {
                showMessage("Akses ditolak. Silakan Login sebagai Admin.", "error");
                return;
            }

            const machine = document.getElementById('addScheduleMachine').value;
            const dateStr = document.getElementById('addScheduleDate').value;
            const shift = document.getElementById('addScheduleShift').value;
            const code = document.getElementById('addScheduleCode').value.trim();
            const name = document.getElementById('addScheduleName').value;
            const qty = document.getElementById('addScheduleQty').value;

            if (!machine || !dateStr || !shift || !code) {
                showMessage("Data tidak lengkap.", "error");
                return;
            }

            const parsedDate = parseDMY(dateStr);
            if (!parsedDate) {
                showMessage("Format Tanggal tidak valid.", "error");
                return;
            }

            const isWeekend = (parsedDate.getDay() === 0 || parsedDate.getDay() === 6);
            if (isWeekend && !forceWeekend) {
                toggleWeekendConfirmModal(true, 'add_modal', dateStr);
                return;
            }

            const dbDate = formatDateToYMD(parsedDate);
            const key = `${machine}|${dbDate}|${shift}`;

            if (scheduleData[key]) {
                showMessage("Gagal: Slot sudah terisi.", "error");
                return;
            }

            // NEW: Enforce Color Stickiness with Confirmation
            const productForColor = Object.values(productionData).find(p => p.code === code);
            const colorVal = productForColor ? productForColor.color : null;
            const colorCheck = validateSlotColor(machine, dbDate, shift, colorVal);

            if (!colorCheck.valid) {
                const proceed = confirm(`PERINGATAN KONFLIK WARNA:\n${colorCheck.message}\n\nApakah Anda yakin ingin MELANGGAR aturan warna ini?`);
                if (!proceed) return;
            }

            const dataToSave = {
                mesin: machine,
                schedule_date: dbDate,
                schedule_shift: shift,
                product_code: code,
                product_name: name,
                order_qty: qty,
                timestamp: new Date().toISOString()
            };

            try {
                const { data, error } = await supabase
                    .from(SCHEDULE_TABLE_NAME)
                    .insert([dataToSave])
                    .select();

                if (error) throw error;

                showMessage(`Jadwal baru berhasil ditambahkan!`, "info");
                toggleScheduleAddModal(false);

                // --- OPTIMISTIC ADD ---
                const insertedItem = (data && data.length > 0) ? data[0] : null;
                if (insertedItem) {
                    const newKey = `${insertedItem.mesin}|${insertedItem.schedule_date}|${insertedItem.schedule_shift}`;
                    scheduleData[newKey] = insertedItem;
                }

                const start = document.getElementById('startDate').value;
                const end = document.getElementById('endDate').value;

                // Skip fetchAll
                if (start && end) {
                    renderPlanningTable(start, end, true);
                }

            } catch (e) {
                console.error("Error saving new schedule slot:", e);
                showMessage(`Gagal menyimpan: ${e.message}`, "error");
            }
        }

        window.toggleWeekendConfirmModal = function (show, action = null, dateStr = '', details = null) {
            const modal = document.getElementById('weekendConfirmModal');
            if (!modal) return;
            modal.classList.toggle('hidden', !show);

            if (show) {
                const titleEl = document.getElementById('weekendModalTitle');
                const textEl = document.getElementById('weekendConfirmText');

                if (action === 'swap') {
                    const sCode = details ? details.source : 'Item A';
                    const tCode = details ? details.target : 'Item B';
                    const swapIcon = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mx-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                        </svg>`;
                    if (titleEl) titleEl.textContent = "Konfirmasi Tukar Posisi";
                    if (textEl) {
                        textEl.innerHTML = `
                                <p class="mb-3">Anda akan menukar posisi jadwal:</p>
                                <div class="flex items-center justify-center bg-gray-50 border border-gray-200 p-3 rounded-lg mb-3">
                                    <span class="font-bold text-indigo-700 text-lg">${sCode}</span>
                                    ${swapIcon}
                                    <span class="font-bold text-indigo-700 text-lg">${tCode}</span>
                                </div>
                                <p>Pastikan kedua mesin kompatibel. Lanjutkan?</p>`;
                    }
                } else {
                    if (titleEl) titleEl.textContent = "Konfirmasi Hari Libur";
                    if (textEl) {
                        textEl.innerHTML = `
                        <p>Tanggal <span class="font-bold text-orange-600 bg-orange-50 px-1 rounded">${dateStr}</span> adalah hari libur (Akhir Pekan).</p>
                        <p class="mt-2">Apakah Anda yakin ingin menjadwalkan produksi di hari ini?</p>`;
                    }
                }
                if (action) pendingWeekendAction = action;
            }
        }

        window.handleWeekendConfirm = function () {
            toggleWeekendConfirmModal(false);
            if (pendingWeekendAction === 'update') {
                updateScheduleSlotFromModal(true);
            } else if (pendingWeekendAction === 'move') {
                processDropUpdate(true);
            } else if (pendingWeekendAction === 'swap') {
                executeSwap();
            } else if (pendingWeekendAction === 'add_modal') {
                saveScheduleSlotFromModal(true);
            } else if (pendingWeekendAction === 'paste_duplicate') {
                executeDuplicate(pendingDuplicateData);
            }
            pendingWeekendAction = null;
        }

    </script>
</body>

</html>
